<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySync - Virtual Study Rooms</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
  tailwind.config = {
    darkMode: 'class', 
    theme: {
      extend: {
        colors: {
          'muted-pink': {
            50: '#fdf2f8',
            100: '#fce7f3',
            200: '#fbcfe8',
            300: '#f9a8d4',
            400: '#f472b6',
            500: '#ec4899',
            600: '#db2777',
            700: '#be185d',
            800: '#9d174d',
            900: '#831843'
          },
          'warm-gray': {
            50: '#fafaf9',
            100: '#f5f5f4',
            200: '#e7e5e4',
            300: '#d6d3d1',
            400: '#a8a29e',
            500: '#78716c',
            600: '#57534e',
            700: '#44403c',
            800: '#292524',
            900: '#1c1917'
          }
        },
        animation: {
          'fade-in': 'fadeIn 0.5s ease-out',
          'slide-up': 'slideUp 0.3s ease-out',
          'bounce-gentle': 'bounceGentle 0.6s ease-out',
          'pulse-soft': 'pulseSoft 2s infinite',
          'shimmer': 'shimmer 1.5s infinite'
        }
      }
    }
  }
</script>

    <style>
.highlight-text {
  background: rgba(255, 255, 255, 0.6); /* soft white box */
  backdrop-filter: blur(6px);           /* blurred effect */
  padding: 4px 8px;                     /* spacing around text */
  border-radius: 8px;                   /* rounded corners */
  display: inline-block;                /* fit box to text */
  color: black;                         /* always black text */
  border: 1px solid #fbcfe8;            /* pink border matching other boxes */
}

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-message {
            animation: slideUp 0.3s ease-out;
        }
        .timer-display {
            font-variant-numeric: tabular-nums;
        }
        .room-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .room-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .status-indicator {
            transition: all 0.2s ease;
        }
        .filter-button {
            transition: all 0.2s ease;
        }
        .white-noise-btn {
            transition: all 0.3s ease;
        }
        .white-noise-btn.active {
            background: linear-gradient(135deg, #ec4899, #db2777);
            color: white;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounceGentle {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-4px); }
            60% { transform: translateY(-2px); }
        }
        @keyframes pulseSoft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-muted-pink-50 to-muted-pink-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-muted-pink-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-muted-pink-400 to-muted-pink-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-users text-white text-sm"></i>
                    </div>
                    <h1 class="text-xl font-bold text-warm-gray-900">StudySync</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="profileBtn" class="flex items-center space-x-2 px-3 py-1.5 rounded-lg border border-muted-pink-200 hover:bg-muted-pink-50 dark:border-gray-600 dark:hover:bg-gray-700 transition-all h-9">
                        <i class="fas fa-user text-muted-pink-600 dark:text-muted-pink-400 text-sm"></i>
                        <span class="text-sm font-medium text-warm-gray-700 dark:text-gray-900" id="userName">You</span>
                    </button>
                    <button id="darkModeToggle" class="flex items-center space-x-2 px-3 py-1.5 rounded-lg border border-muted-pink-200 hover:bg-muted-pink-50 dark:border-gray-600 dark:hover:bg-gray-700 transition-all h-9">
                        <i class="fas fa-moon text-warm-gray-700 dark:text-gray-300 text-sm"></i>
                        <span class="text-sm font-medium text-warm-gray-700 dark:text-gray-300">Dark</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard View -->
        <div id="dashboardView" class="space-y-8 animate-fade-in">
            <!-- Header -->
            <div class="text-center">
    <div class="highlight-text">
        <h2 class="text-3xl font-bold mb-2">Join a Study Room</h2>
        <p class="text-sm mb-0">Connect with fellow students and boost your productivity</p>
    </div>
</div>

            <!-- Background Room Timer Indicator (hidden by default) -->
            <div id="backgroundRoomIndicator" class="hidden bg-gradient-to-r from-muted-pink-500 to-muted-pink-600 rounded-xl p-4 shadow-lg border-2 border-muted-pink-400">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center animate-pulse-soft">
                            <i class="fas fa-clock text-white text-lg"></i>
                        </div>
                        <div>
                            <p class="text-white font-semibold text-sm">Study timer running</p>
                            <p class="text-pink-100 text-xs" id="backgroundRoomName">Room Name</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="text-right mr-3">
                            <p class="text-white font-bold text-lg timer-display" id="backgroundTimerDisplay">25:00</p>
                            <p class="text-pink-100 text-xs" id="backgroundTimerStatus">Study Time</p>
                        </div>
                        <button id="returnToRoomBtn" class="px-4 py-2 bg-white text-muted-pink-600 rounded-lg hover:bg-pink-50 transition-all font-medium text-sm">
                            Return to Room
                        </button>
                        <button id="leaveRoomFromDashboardBtn" class="px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all font-medium text-sm">
                            Leave Room
                        </button>
                    </div>
                </div>
            </div>

            <!-- Motivational Quote -->
            <div class="bg-white/60 backdrop-blur-md rounded-xl p-6 text-center border border-muted-pink-200 hover:border-muted-pink-300 transition-all">
                <div class="flex items-center justify-center mb-3">
                    <i class="fas fa-quote-left text-muted-pink-400 dark:text-[#ffbfe7] text-xl mr-3"></i>
                    <i class="fas fa-star text-muted-pink-500 dark:text-[#ffbfe7] animate-pulse-soft"></i>
                    <i class="fas fa-quote-right text-muted-pink-400 dark:text-[#ffbfe7] text-xl ml-3"></i>
                </div>
                <p id="motivationalQuote" class="text-lg font-medium leading-relaxed text-warm-gray-800 transition-all duration-500">
                    "Success is not final, failure is not fatal: it is the courage to continue that counts. - Winston Churchill"
                </p>
            </div>



            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white/60 backdrop-blur-md rounded-xl p-6 border border-muted-pink-200 hover:border-muted-pink-300 transition-all">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-muted-pink-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-muted-pink-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-2xl font-bold text-warm-gray-900" id="totalStudyTime">0 hr</p>
                            <p class="text-warm-gray-600 dark:text-gray-900">Study Time Today</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white/60 backdrop-blur-md rounded-xl p-6 border border-muted-pink-200 hover:border-muted-pink-300 transition-all">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-muted-pink-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-trophy text-muted-pink-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-2xl font-bold text-warm-gray-900" id="goalsCompleted">0</p>
                            <p class="text-warm-gray-600 dark:text-gray-900">Goals Completed</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="bg-white/60 backdrop-blur-md rounded-xl p-6 border border-muted-pink-200">
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="searchRooms" placeholder="Search rooms, subjects, timer lengths (e.g. '25 min', 'restarting')..." class="w-full px-4 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base transition-all">
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <select id="filterSubject" class="px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 text-sm transition-all">
                            <option value="">All Subjects</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Science">Science</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                            <option value="History">History</option>
                            <option value="English">English</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Business">Business</option>
                            <option value="Medicine">Medicine</option>
                            <option value="Law">Law</option>
                            <option value="Psychology">Psychology</option>
                            <option value="Economics">Economics</option>
                            <option value="Language Learning">Language Learning</option>
                            <option value="Test Prep">Test Prep</option>
                            <option value="Art">Art</option>
                            <option value="Music">Music</option>
                            <option value="Data Science">Data Science</option>
                            <option value="Mixed Studies">Mixed Studies</option>
                        </select>
                        <select id="filterAge" class="px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 text-sm transition-all">
                            <option value="">All Ages</option>
                            <option value="Middle School (11-14)">Middle School (11-14)</option>
                            <option value="High School (14-18)">High School (14-18)</option>
                            <option value="College Freshman (18-19)">College Freshman (18-19)</option>
                            <option value="College (18-22)">College (18-22)</option>
                            <option value="Graduate (22+)">Graduate (22+)</option>
                            <option value="Adult Learner (25+)">Adult Learner (25+)</option>
                            <option value="Professional Development">Professional Development</option>
                            <option value="Lifelong Learner (35+)">Lifelong Learner (35+)</option>
                            <option value="Mixed Ages">Mixed Ages</option>
                        </select>
                        <select id="filterCountry" class="px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 text-sm transition-all">
                            <option value="">All Regions</option>
                            <option value="United States">United States</option>
                            <option value="Europe">Europe</option>
                            <option value="Asia">Asia</option>
                            <option value="Africa">Africa</option>
                            <option value="South America">South America</option>
                            <option value="Oceania">Oceania</option>
                            <option value="International">International</option>
                        </select>
                        <select id="filterTimer" class="px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 text-sm transition-all">
                            <option value="">All Timer Types</option>
                            <option value="Pomodoro">Pomodoro</option>
                            <option value="Simple">Simple Timer</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Room Type Filters -->
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex flex-wrap gap-2">
                    <button class="room-filter-btn active px-4 py-2 rounded-lg bg-muted-pink-100 text-muted-pink-700 dark:text-gray-800 hover:bg-muted-pink-200 transition-all" data-filter="all">All Rooms</button>
                    <button class="room-filter-btn px-4 py-2 rounded-lg bg-white/60 text-warm-gray-700 dark:text-gray-800 hover:bg-muted-pink-100 transition-all" data-filter="synchronized">Synchronized</button>
                    <button class="room-filter-btn px-4 py-2 rounded-lg bg-white/60 text-warm-gray-700 dark:text-gray-800 hover:bg-muted-pink-100 transition-all" data-filter="individual">Individual</button>
                    <button class="room-filter-btn px-4 py-2 rounded-lg bg-white/60 text-warm-gray-700 dark:text-gray-800 hover:bg-muted-pink-100 transition-all" data-filter="instant-join">
                        <i class="fas fa-bolt mr-1"></i>Instant Join
                    </button>
                </div>
                <button id="createRoomBtn" class="px-6 py-2 bg-muted-pink-500 text-white rounded-lg hover:bg-muted-pink-600 transition-all transform hover:scale-105">
                    <i class="fas fa-plus mr-2"></i>Create Room
                </button>
            </div>

            <!-- Study Rooms Grid -->
            <div id="roomsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Rooms will be generated here -->
            </div>
        </div>

        <!-- Room View -->
        <div id="roomView" class="hidden space-y-6 animate-fade-in">
            <!-- Room Header -->
            <div class="bg-white/60 backdrop-blur-md rounded-xl p-6 border border-muted-pink-200">
                <div class="flex items-center justify-between mb-4">
                    <button id="backToDashboard" class="flex items-center text-warm-gray-600 dark:text-gray-900 hover:text-warm-gray-900 dark:hover:text-black transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Rooms
                    </button>
                    <div class="flex items-center space-x-2">
                        <div id="userStatusSelector" class="flex items-center space-x-2 px-3 py-1.5 bg-white/80 rounded-lg border border-muted-pink-200">
                            <span class="text-sm text-warm-gray-600">Status:</span>
                            <select id="userStatusSelect" class="bg-transparent border-none text-sm focus:outline-none">
                                <option value="focused">ðŸ”¥ Focused</option>
                                <option value="studying">ðŸ“š Studying</option>
                                <option value="break">â˜• Break</option>
                                <option value="resting">ðŸ˜´ Resting</option>
                            </select>
                        </div>
                        <button id="leaveRoomBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all">Leave</button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h2 id="roomTitle" class="text-2xl font-bold text-warm-gray-900 mb-2">Loading...</h2>
                        <div class="flex flex-wrap items-center gap-4 text-sm text-warm-gray-600 mb-3">
                            <span id="roomParticipants" class="text-warm-gray-600 dark:text-gray-900">0 participants</span>
                        </div>
                        <!-- Room Details Section -->
                        <div id="roomDetails" class="flex flex-wrap items-center gap-3 text-sm text-warm-gray-600">
                            <div class="flex items-center">
                                <i class="fas fa-book text-muted-pink-500 dark:text-[#ffbfe7] w-4 mr-2"></i>
                                <span class="text-warm-gray-600 dark:text-gray-900" id="roomSubject">Loading...</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock text-muted-pink-500 dark:text-[#ffbfe7] w-4 mr-2"></i>
                                <span class="text-warm-gray-600 dark:text-gray-900" id="roomTimerInfo">Loading...</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-globe text-muted-pink-500 dark:text-[#ffbfe7] w-4 mr-2"></i>
                                <span class="text-warm-gray-600 dark:text-gray-900" id="roomCountry">Loading...</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-users text-muted-pink-500 dark:text-[#ffbfe7] w-4 mr-2"></i>
                                <span class="text-warm-gray-600 dark:text-gray-900" id="roomAgeRange">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="mainTimer" class="text-3xl font-bold timer-display text-muted-pink-600 dark:text-[#ffbfe7]">25:00</div>
                        <div class="text-sm text-warm-gray-600 dark:text-gray-900" id="timerStatus">Ready to start</div>
                        <div class="text-xs text-warm-gray-500" id="timerPhase"></div>
                    </div>
                </div>
            </div>

            <!-- Main Room Content -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Users List -->
                <div class="lg:col-span-2 space-y-4">
                    <div class="bg-white/60 backdrop-blur-md rounded-xl p-6 border border-muted-pink-200">
                        <h3 class="text-lg font-semibold text-warm-gray-900 mb-4">Study Buddies</h3>
                        <div id="usersList" class="space-y-3">
                            <!-- Users will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Chat & Controls -->
                <div class="space-y-4">
                    <!-- Timer Controls -->
                    <div id="timerControls" class="bg-white/60 backdrop-blur-md rounded-xl p-6 border border-muted-pink-200">
                        <h3 class="text-lg font-semibold text-warm-gray-900 mb-4">Your Timer</h3>
                        <div class="space-y-4">
                            <div id="individualTimerControls">
                                <div>
                                    <label class="block text-sm font-medium text-warm-gray-700 mb-2">Timer Type</label>
                                    <select id="timerType" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base mb-3">
                                        <option value="pomodoro">Pomodoro (25min study + 5min break)</option>
                                        <option value="simple">Simple Timer (continuous)</option>
                                    </select>
                                </div>
                                <div id="pomodoroSettings">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium text-warm-gray-700 mb-2">Focus Time (min)</label>
                                            <input type="number" id="studyDuration" value="25" min="1" max="120" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-warm-gray-700 mb-2">Break Time (min)</label>
                                            <input type="number" id="breakDuration" value="5" min="1" max="30" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                                        </div>
                                    </div>
                                </div>
                                <div id="simpleSettings" class="hidden">
                                    <label class="block text-sm font-medium text-warm-gray-700 mb-2">Timer Duration (minutes)</label>
                                    <input type="number" id="simpleDuration" value="60" min="5" max="300" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-warm-gray-700 mb-2">Your Subject</label>
                                    <input type="text" id="userSubject" placeholder="What are you studying?" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                                </div>
                                <div class="flex space-x-2 mt-4">
                                    <button id="startTimerBtn" class="flex-1 px-4 py-2 bg-muted-pink-500 text-white rounded-lg hover:bg-muted-pink-600 transition-all transform hover:scale-105">Start</button>
                                    <button id="pauseTimerBtn" class="px-4 py-2 bg-warm-gray-400 text-white rounded-lg hover:bg-warm-gray-500 transition-all">Pause</button>
                                </div>
                            </div>
                            <div id="syncTimerInfo" class="hidden text-center">
                                <div class="p-4 bg-green-50 rounded-lg border border-green-200 mb-4">
                                    <i class="fas fa-sync-alt text-green-600 mb-2"></i>
                                    <p class="text-sm text-green-700 font-medium">Synchronized with room timer</p>
                                    <p class="text-xs text-green-600 mt-1">Everyone is studying together!</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-warm-gray-700 mb-2">Your Subject (Optional)</label>
                                    <input type="text" id="userSubjectSync" placeholder="What are you studying?" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Goals & Checklist -->
                    <div class="bg-white/60 backdrop-blur-md rounded-xl p-6 border border-muted-pink-200">
                        <h3 class="text-lg font-semibold text-warm-gray-900 mb-4">Study Goals</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-warm-gray-700 mb-2">Today's Goal</label>
                                <input type="text" id="userGoal" placeholder="What do you want to accomplish?" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-sm font-medium text-warm-gray-700">Make goal public</label>
                                <button id="toggleGoalVisibility" class="relative inline-flex h-6 w-11 items-center rounded-full bg-muted-pink-500 transition-all">
                                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"></span>
                                </button>
                            </div>
                            
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-sm font-medium text-warm-gray-700">Checklist</label>
                                    <button id="addChecklistItem" class="text-muted-pink-600 dark:text-[#FCE7F3] hover:text-muted-pink-700 transition-all">
                                        <i class="fas fa-plus text-sm"></i>
                                    </button>
                                </div>
                                <div id="checklistContainer" class="space-y-2">
                                    <!-- Checklist items will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat -->
                    <div class="bg-white/60 backdrop-blur-md rounded-xl border border-muted-pink-200 h-[28rem] flex flex-col">
                        <div class="p-4 border-b border-muted-pink-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-warm-gray-900">Chat</h3>
                                <button id="toggleChatBtn" class="px-3 py-1 text-sm bg-muted-pink-100 text-muted-pink-700 rounded-lg hover:bg-muted-pink-200 transition-all">
                                    <i class="fas fa-eye mr-1"></i>Enabled
                                </button>
                            </div>
                        </div>
                        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-2">
                            <!-- Chat messages will appear here -->
                        </div>
                        <div class="p-4 border-t border-muted-pink-200">
                            <div class="flex space-x-2">
                                <input type="text" id="chatInput" placeholder="Say something..." class="flex-1 px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                                <button id="sendChatBtn" class="px-4 py-2 bg-muted-pink-500 text-white rounded-lg hover:bg-muted-pink-600 transition-all transform hover:scale-105">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Create Room Modal -->
    <div id="createRoomModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 animate-slide-up">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-warm-gray-900">Create Study Room</h3>
                <button id="closeCreateModal" class="text-warm-gray-600 hover:text-warm-gray-900 transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-warm-gray-700 mb-2">Room Name</label>
                    <input type="text" id="newRoomName" placeholder="e.g., Math Study Group" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-warm-gray-700 mb-2">Primary Subject</label>
                    <select id="newRoomSubject" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                        <option value="Mixed Studies">Mixed Studies (All subjects welcome)</option>
                        <option value="Mathematics">Mathematics</option>
                        <option value="Science">Science</option>
                        <option value="Physics">Physics</option>
                        <option value="Chemistry">Chemistry</option>
                        <option value="Biology">Biology</option>
                        <option value="History">History</option>
                        <option value="English">English</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Business">Business</option>
                        <option value="Medicine">Medicine</option>
                        <option value="Law">Law</option>
                        <option value="Psychology">Psychology</option>
                        <option value="Economics">Economics</option>
                        <option value="Language Learning">Language Learning</option>
                        <option value="Test Prep">Test Prep</option>
                        <option value="Art">Art</option>
                        <option value="Music">Music</option>
                        <option value="Data Science">Data Science</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-warm-gray-700 mb-2">Room Type</label>
                    <select id="newRoomType" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                        <option value="synchronized">Synchronized (Everyone follows the same timer)</option>
                        <option value="individual">Individual (Everyone has their own timer)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-warm-gray-700 mb-2">Timer Style</label>
                    <select id="newRoomTimerStyle" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                        <option value="pomodoro">Pomodoro (Study + Break cycles)</option>
                        <option value="simple">Simple Timer (Continuous study)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-warm-gray-700 mb-2">Region</label>
                    <select id="newRoomCountry" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                        <option value="International">International</option>
                        <option value="United States">United States</option>
                        <option value="Europe">Europe</option>
                        <option value="Asia">Asia</option>
                        <option value="Africa">Africa</option>
                        <option value="South America">South America</option>
                        <option value="Oceania">Oceania</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-warm-gray-700 mb-2">Age Group</label>
                    <select id="newRoomAgeGroup" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                        <option value="Mixed Ages">Mixed Ages</option>
                        <option value="Middle School (11-14)">Middle School (11-14)</option>
                        <option value="High School (14-18)">High School (14-18)</option>
                        <option value="College Freshman (18-19)">College Freshman (18-19)</option>
                        <option value="College (18-22)">College (18-22)</option>
                        <option value="Graduate (22+)">Graduate (22+)</option>
                        <option value="Adult Learner (25+)">Adult Learner (25+)</option>
                        <option value="Professional Development">Professional Development</option>
                        <option value="Lifelong Learner (35+)">Lifelong Learner (35+)</option>
                    </select>
                </div>
                <div id="newRoomPomodoroSettings" class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-warm-gray-700 mb-2">Study Time (min)</label>
                        <input type="number" id="newRoomStudyDuration" value="25" min="5" max="120" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-warm-gray-700 mb-2">Break Time (min)</label>
                        <input type="number" id="newRoomBreakDuration" value="5" min="1" max="30" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                    </div>
                </div>
                <div id="newRoomSimpleSettings" class="hidden">
                    <label class="block text-sm font-medium text-warm-gray-700 mb-2">Timer Duration (min)</label>
                    <input type="number" id="newRoomSimpleDuration" value="60" min="5" max="300" class="w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                </div>
                <div class="flex space-x-3">
                    <button id="cancelCreateRoom" class="flex-1 px-4 py-2 border border-muted-pink-200 text-warm-gray-700 rounded-lg hover:bg-muted-pink-50 transition-all">Cancel</button>
                    <button id="confirmCreateRoom" class="flex-1 px-4 py-2 bg-muted-pink-500 text-white rounded-lg hover:bg-muted-pink-600 transition-all">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 animate-slide-up">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-warm-gray-900 dark:text-white">Your Profile</h3>
                <button id="closeProfileModal" class="text-warm-gray-600 hover:text-warm-gray-900 dark:text-gray-400 dark:hover:text-gray-200 transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-muted-pink-400 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-user text-white text-2xl"></i>
                    </div>
                    <p class="text-sm text-warm-gray-600 dark:text-gray-400">Customize your profile information</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-warm-gray-700 dark:text-gray-300 mb-2">Display Name</label>
                    <input type="text" id="profileName" placeholder="Enter your name" class="w-full px-3 py-2 border border-muted-pink-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-warm-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-warm-gray-700 dark:text-gray-300 mb-2">Location</label>
                    <input type="text" id="profileLocation" placeholder="e.g., New York, USA" class="w-full px-3 py-2 border border-muted-pink-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-warm-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-warm-gray-700 dark:text-gray-300 mb-2">School/Institution (Optional)</label>
                    <input type="text" id="profileSchool" placeholder="e.g., Harvard University" class="w-full px-3 py-2 border border-muted-pink-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-warm-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-warm-gray-700 dark:text-gray-300 mb-2">Age Group</label>
                    <select id="profileAgeGroup" class="w-full px-3 py-2 border border-muted-pink-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-warm-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-muted-pink-500 text-base">
                        <option value="">Select age group</option>
                        <option value="Middle School">Middle School (11-14)</option>
                        <option value="High School">High School (14-18)</option>
                        <option value="College Freshman">College Freshman (18-19)</option>
                        <option value="College">College (18-22)</option>
                        <option value="Graduate">Graduate (22+)</option>
                        <option value="Adult Learner">Adult Learner (25+)</option>
                        <option value="Professional">Professional Development</option>
                        <option value="Lifelong Learner">Lifelong Learner (35+)</option>
                    </select>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button id="cancelProfileEdit" class="flex-1 px-4 py-2 border border-muted-pink-200 dark:border-gray-600 text-warm-gray-700 dark:text-gray-300 rounded-lg hover:bg-muted-pink-50 dark:hover:bg-gray-700 transition-all">Cancel</button>
                    <button id="saveProfile" class="flex-1 px-4 py-2 bg-muted-pink-500 text-white rounded-lg hover:bg-muted-pink-600 transition-all">Save Profile</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Room Confirmation Modal -->
    <div id="leaveRoomModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 animate-slide-up">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-sign-out-alt text-red-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-warm-gray-900 dark:text-white mb-2">Leave Room?</h3>
                <p class="text-warm-gray-600 dark:text-gray-400">Are you sure you want to leave this room? Your study timer will be stopped.</p>
            </div>
            <div class="flex space-x-3">
                <button id="cancelLeaveRoom" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-warm-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                    Cancel
                </button>
                <button id="confirmLeaveRoom" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all">
                    Leave Room
                </button>
            </div>
        </div>
    </div>

    <!-- Join New Room Confirmation Modal -->
    <div id="joinNewRoomModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 animate-slide-up">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-warm-gray-900 dark:text-white mb-2">Join New Room?</h3>
                <p class="text-warm-gray-600 dark:text-gray-400 mb-4">You're currently in another room. Joining this room will stop your previous room's timer.</p>
                <div class="bg-muted-pink-50 dark:bg-gray-700 rounded-lg p-3 mb-2">
                    <p class="text-sm text-warm-gray-700 dark:text-gray-300">
                        <span class="font-semibold">Current room:</span> <span id="currentRoomNameInModal">â€”</span>
                    </p>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3">
                    <p class="text-sm text-warm-gray-700 dark:text-gray-300">
                        <span class="font-semibold">New room:</span> <span id="newRoomNameInModal">â€”</span>
                    </p>
                </div>
            </div>
            <div class="flex space-x-3">
                <button id="backToPreviousRoom" class="flex-1 px-4 py-2 border border-muted-pink-300 dark:border-gray-600 text-muted-pink-700 dark:text-gray-300 rounded-lg hover:bg-muted-pink-50 dark:hover:bg-gray-700 transition-all">
                    Go Back to Previous
                </button>
                <button id="confirmJoinNewRoom" class="flex-1 px-4 py-2 bg-muted-pink-500 text-white rounded-lg hover:bg-muted-pink-600 transition-all">
                    Join New Room
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentRoom = null;
        let isViewingDashboard = true; // Track if user is viewing dashboard vs room
        let backgroundRoom = null; // Track room running in background
        let personalTimer = null;
        let roomTimer = null;
        let fakeUserTimersInterval = null;
        let fakeUserStatusInterval = null;
        let chatEnabled = true;
        let userStatus = 'studying';
        let studyTimeToday = 0;
        let realUserSessionStart = Date.now(); // Track when real user started their session (persists across rooms)
        let userChecklist = [];
        let goalVisibility = true;
        let currentWhiteNoise = 'mute';
        let lastUserMessage = null;
        let chatReplyTimeout = null;
        let allRooms = [];
        let currentFilters = {
            search: '',
            subject: '',
            age: '',
            country: '',
            timer: '',
            type: 'all'
        };

        // User profile data
        let userProfile = {
            name: 'You',
            location: 'Your Location', 
            school: '',
            ageGroup: ''
        };

        // Enhanced motivational quotes
        const motivationalQuotes = [
            "Success is not final, failure is not fatal: it is the courage to continue that counts. - Winston Churchill",
            "The only way to do great work is to love what you do. - Steve Jobs",
            "It does not matter how slowly you go as long as you do not stop. - Confucius",
            "Education is the most powerful weapon which you can use to change the world. - Nelson Mandela",
            "The beautiful thing about learning is that no one can take it away from you. - B.B. King",
            "Success is the sum of small efforts repeated day in and day out. - Robert Collier",
            "Learning never exhausts the mind. - Leonardo da Vinci",
            "The expert in anything was once a beginner. - Helen Hayes",
            "Don't let yesterday take up too much of today. - Will Rogers",
            "You are never too old to set another goal or to dream a new dream. - C.S. Lewis",
            "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
            "Believe you can and you're halfway there. - Theodore Roosevelt",
            "It is during our darkest moments that we must focus to see the light. - Aristotle",
            "The way to get started is to quit talking and begin doing. - Walt Disney",
            "Innovation distinguishes between a leader and a follower. - Steve Jobs",
            "Life is what happens to you while you're busy making other plans. - John Lennon",
            "The future belongs to those who prepare for it today. - Malcolm X",
            "Your limitationâ€”it's only your imagination.",
            "Push yourself, because no one else is going to do it for you.",
            "Great things never come from comfort zones.",
            "Dream it. Wish it. Do it.",
            "Success doesn't just find you. You have to go out and get it.",
            "The harder you work for something, the greater you'll feel when you achieve it.",
            "Don't stop when you're tired. Stop when you're done.",
            "Wake up with determination. Go to bed with satisfaction.",
            "Do something today that your future self will thank you for.",
            "Little progress is still progress.",
            "Great things never come from comfort zones.",
            "Dream bigger. Do bigger.",
            "Don't wait for opportunity. Create it.",
            "Sometimes we're tested not to show our weaknesses, but to discover our strengths.",
            "The key to success is to focus on goals, not obstacles.",
            "Dream it. Believe it. Build it.",
            "What lies behind us and what lies before us are tiny matters compared to what lies within us. - Ralph Waldo Emerson",
            "The only impossible journey is the one you never begin. - Tony Robbins",
            "In the middle of difficulty lies opportunity. - Albert Einstein",
            "Success is not how high you have climbed, but how you make a positive difference to the world. - Roy T. Bennett"
        ];

        // Enhanced fake data generators
        const subjects = ['Mathematics', 'Science', 'History', 'English', 'Computer Science', 'Physics', 'Chemistry', 'Biology', 'Language Learning', 'Test Prep', 'Art', 'Music', 'Psychology', 'Philosophy', 'Economics', 'Business', 'Engineering', 'Medicine', 'Law', 'Nursing', 'Education', 'Social Work', 'Architecture', 'Fine Arts', 'Theater', 'Film Studies', 'Journalism', 'Marketing', 'Finance', 'Accounting', 'Statistics', 'Data Science', 'Cybersecurity', 'Graphic Design', 'Web Development', 'Mixed Studies'];

        // Expanded conversation pool to reduce repetition
        let usedGeneralMessages = [];
        let usedSubjectMessages = [];
        let usedStatusMessages = [];
        let lastChatSender = null;
        let chatMessageHistory = [];
        let recentResponders = new Set(); // Track who responded recently to prevent duplicates

        // Dynamic room activity system
        let roomActivityInterval = null;
        let roomListUpdateInterval = null;
        const schools = [
            // United States
            'Harvard University', 'MIT', 'Stanford University', 'UC Berkeley', 'NYU', 'Princeton', 'Yale', 'Columbia', 'University of Chicago', 'Caltech', 'Johns Hopkins', 'Northwestern', 'Duke University', 'University of Pennsylvania', 'Cornell University', 'Brown University', 'Dartmouth College', 'Rice University', 'Vanderbilt University', 'Carnegie Mellon', 'UCLA', 'University of Southern California', 'University of Michigan', 'Georgia Tech', 'University of Illinois', 'UT Austin', 'University of Washington', 'UCSD', 'Boston University', 'Georgetown University',
            
            // United Kingdom
            'Oxford University', 'Cambridge University', 'Imperial College London', 'London School of Economics', 'University College London', 'King\'s College London', 'University of Edinburgh', 'University of Manchester', 'University of Warwick', 'University of Bath', 'University of Bristol', 'Durham University', 'University of St Andrews', 'University of Glasgow', 'University of Sheffield',
            
            // Canada
            'University of Toronto', 'McGill University', 'University of British Columbia', 'University of Waterloo', 'McMaster University', 'Queen\'s University', 'University of Alberta', 'University of Montreal', 'Simon Fraser University', 'Carleton University',
            
            // Europe
            'ETH Zurich', 'University of Copenhagen', 'KTH Royal Institute', 'Technical University of Munich', 'University of Amsterdam', 'Delft University', 'Sorbonne University', 'Ã‰cole Polytechnique', 'INSEAD', 'London Business School', 'IE Business School', 'University of Bologna', 'Bocconi University', 'Stockholm School of Economics', 'Vienna University', 'University of Zurich',
            
            // Asia
            'University of Tokyo', 'Kyoto University', 'Seoul National University', 'KAIST', 'National University of Singapore', 'Nanyang Technological University', 'Hong Kong University', 'Chinese University of Hong Kong', 'Peking University', 'Tsinghua University', 'Fudan University', 'Shanghai Jiao Tong University', 'IIT Bombay', 'IIT Delhi', 'Indian Institute of Science', 'HSNU', 'National Taiwan University', 'Waseda University', 'Keio University', 'Yonsei University',
            
            // Australia & Oceania
            'University of Melbourne', 'Australian National University', 'University of Sydney', 'University of Queensland', 'Monash University', 'University of New South Wales', 'University of Western Australia', 'University of Adelaide', 'University of Auckland', 'University of Otago',
            
            // Africa
            'University of Cape Town', 'University of the Witwatersrand', 'Cairo University', 'American University in Cairo', 'University of Nairobi', 'Makerere University', 'University of Lagos', 'Stellenbosch University',
            
            // South America
            'University of SÃ£o Paulo', 'University of Buenos Aires', 'Pontifical Catholic University of Chile', 'Universidad de los Andes', 'Federal University of Rio de Janeiro', 'University of Chile', 'TecnolÃ³gico de Monterrey',
            
            // High Schools & Others
            'Phillips Exeter Academy', 'Phillips Andover Academy', 'Eton College', 'Harrow School', 'International School of Geneva', 'United World College', 'Local High School', 'International Baccalaureate School', 'Community College', 'State University', 'Technical College', 'Online University'
        ];
        const ageRanges = ['Middle School (11-14)', 'High School (14-18)', 'College Freshman (18-19)', 'College (18-22)', 'Graduate (22+)', 'Adult Learner (25+)', 'Professional Development', 'Lifelong Learner (35+)', 'Mixed Ages'];
        const timerTypes = ['Pomodoro', 'Simple Timer'];
        const countries = ['United States', 'Europe', 'Asia', 'Africa', 'South America', 'Oceania', 'International'];
        const cities = {
            'United States': ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Antonio', 'San Diego', 'Dallas', 'San Jose', 'Austin', 'Boston', 'Seattle', 'Denver', 'Miami', 'Atlanta', 'Portland', 'Las Vegas', 'Detroit', 'Nashville'],
            'Europe': ['London', 'Paris', 'Berlin', 'Madrid', 'Rome', 'Amsterdam', 'Vienna', 'Prague', 'Brussels', 'Zurich', 'Barcelona', 'Milan', 'Munich', 'Stockholm', 'Copenhagen', 'Oslo', 'Helsinki', 'Warsaw', 'Dublin', 'Lisbon', 'Athens', 'Budapest'],
            'Asia': ['Tokyo', 'Seoul', 'Singapore', 'Hong Kong', 'Bangkok', 'Mumbai', 'Shanghai', 'Kuala Lumpur', 'Jakarta', 'Manila', 'Taipei', 'Dubai', 'Delhi', 'Bangalore', 'Beijing', 'Osaka', 'Tel Aviv', 'Doha', 'Abu Dhabi', 'Istanbul', 'Riyadh', 'Kuwait City', 'Islamabad', 'Dhaka', 'Colombo', 'Ho Chi Minh City'],
            'Africa': ['Cairo', 'Lagos', 'Johannesburg', 'Nairobi', 'Casablanca', 'Accra', 'Tunis', 'Addis Ababa', 'Khartoum', 'Algiers', 'Cape Town', 'Durban', 'Abuja', 'Kinshasa', 'Luanda', 'Dar es Salaam', 'Kampala', 'Rabat', 'Alexandria', 'Marrakech'],
            'South America': ['SÃ£o Paulo', 'Buenos Aires', 'Lima', 'BogotÃ¡', 'Santiago', 'Caracas', 'Quito', 'La Paz', 'Montevideo', 'AsunciÃ³n', 'Rio de Janeiro', 'MedellÃ­n', 'CÃ³rdoba', 'Rosario', 'ValparaÃ­so', 'Guayaquil', 'Santa Cruz', 'BrasÃ­lia', 'Salvador', 'Fortaleza'],
            'Oceania': ['Sydney', 'Melbourne', 'Brisbane', 'Perth', 'Auckland', 'Wellington', 'Adelaide', 'Gold Coast', 'Canberra', 'Darwin', 'Christchurch', 'Hamilton', 'Hobart', 'Newcastle', 'Wollongong', 'Cairns', 'Townsville', 'Geelong', 'Ballarat', 'Bendigo'],
            'International': ['Global', 'Remote', 'Online', 'Virtual', 'Digital Nomad', 'Multi-timezone', 'Worldwide', 'Cross-border', 'Global Community', 'International']
        };

        // More specific city-to-name mappings for better cultural accuracy
        const cityToNameMapping = {
            // United States
            'New York': ['Michael', 'Sarah', 'David', 'Jessica', 'Christopher', 'Ashley', 'Matthew', 'Amanda', 'Daniel', 'Emily'],
            'Los Angeles': ['Alex', 'Emma', 'Ryan', 'Olivia', 'Tyler', 'Isabella', 'Brandon', 'Sophia', 'Justin', 'Mia'],
            'Chicago': ['James', 'Jennifer', 'Robert', 'Michelle', 'William', 'Nicole', 'Anthony', 'Stephanie', 'John', 'Rachel'],
            'Houston': ['Carlos', 'Maria', 'Jose', 'Ana', 'Luis', 'Carmen', 'Miguel', 'Sofia', 'Diego', 'Elena'],
            'San Jose': ['Kevin', 'Lisa', 'Brian', 'Amy', 'Steven', 'Karen', 'Jason', 'Linda', 'Mark', 'Susan'],
            'Austin': ['Tyler', 'Madison', 'Blake', 'Savannah', 'Connor', 'Harper', 'Hunter', 'Brooke', 'Caleb', 'Chloe'],
            'Boston': ['Patrick', 'Katherine', 'Sean', 'Colleen', 'Timothy', 'Bridget', 'Kevin', 'Maureen', 'Brian', 'Erin'],
            'Seattle': ['Andrew', 'Rachel', 'Benjamin', 'Sarah', 'Nathan', 'Jessica', 'Nicholas', 'Amanda', 'Joshua', 'Stephanie'],
            'Denver': ['Ethan', 'Hannah', 'Mason', 'Abigail', 'Carter', 'Addison', 'Lucas', 'Avery', 'Owen', 'Riley'],
            'Miami': ['Isabella', 'Diego', 'Sofia', 'Carlos', 'Camila', 'Sebastian', 'Valentina', 'Mateo', 'Gabriela', 'Adrian'],
            'Atlanta': ['Jackson', 'Aaliyah', 'Noah', 'Madison', 'Jayden', 'Destiny', 'Elijah', 'Trinity', 'Caleb', 'Zoe'],
            'Portland': ['River', 'Luna', 'Sage', 'Nova', 'Kai', 'Aurora', 'Phoenix', 'Willow', 'Cedar', 'Rain'],
            'Las Vegas': ['Antonio', 'Victoria', 'Roberto', 'Angelica', 'Marco', 'Lucia', 'Fernando', 'Carmen', 'Ricardo', 'Elena'],
            'Detroit': ['Marcus', 'Jasmine', 'Darius', 'Aaliyah', 'Andre', 'Destiny', 'Malik', 'Diamond', 'Terrell', 'Imani'],
            'Nashville': ['Wyatt', 'Savannah', 'Hunter', 'Harper', 'Mason', 'Gracelyn', 'Jackson', 'Paisley', 'Colton', 'McKenzie'],
            
            // Europe - UK
            'London': ['James', 'Emma', 'Oliver', 'Charlotte', 'Harry', 'Sophie', 'George', 'Emily', 'William', 'Grace'],
            'Dublin': ['Liam', 'Emma', 'Noah', 'Emily', 'Conor', 'Sophie', 'Oisin', 'Fiadh', 'Cian', 'Grace'],
            
            // Europe - France
            'Paris': ['Pierre', 'Marie', 'Louis', 'Camille', 'Antoine', 'Chloe', 'Nicolas', 'Emma', 'Thomas', 'Lea'],
            
            // Europe - Germany
            'Berlin': ['Maximilian', 'Emma', 'Alexander', 'Hannah', 'Paul', 'Lea', 'Elias', 'Emily', 'Ben', 'Mia'],
            'Munich': ['Felix', 'Sophie', 'Lukas', 'Marie', 'Noah', 'Lena', 'Leon', 'Anna', 'Finn', 'Laura'],
            
            // Europe - Spain
            'Madrid': ['Alejandro', 'Lucia', 'Pablo', 'Maria', 'Manuel', 'Paula', 'Adrian', 'Daniela', 'David', 'Carmen'],
            'Barcelona': ['Marc', 'Julia', 'Alex', 'Carla', 'Pol', 'Martina', 'Biel', 'Laia', 'Arnau', 'Noa'],
            
            // Europe - Italy
            'Rome': ['Francesco', 'Sofia', 'Alessandro', 'Giulia', 'Lorenzo', 'Alice', 'Matteo', 'Aurora', 'Gabriele', 'Emma'],
            'Milan': ['Leonardo', 'Sofia', 'Francesco', 'Giulia', 'Alessandro', 'Aurora', 'Lorenzo', 'Alice', 'Matteo', 'Giorgia'],
            
            // Europe - Netherlands
            'Amsterdam': ['Daan', 'Emma', 'Lucas', 'Julia', 'Milan', 'Sophie', 'Sem', 'Zoe', 'Finn', 'Tess'],
            
            // Europe - Switzerland
            'Zurich': ['Noah', 'Mia', 'Liam', 'Emma', 'Matteo', 'Sofia', 'Gabriel', 'Ella', 'Leon', 'Lina'],
            
            // Europe - Scandinavia
            'Stockholm': ['William', 'Alice', 'Lucas', 'Maja', 'Liam', 'Vera', 'Noah', 'Astrid', 'Hugo', 'Freja'],
            'Copenhagen': ['William', 'Emma', 'Noah', 'Alma', 'Oliver', 'Freja', 'Oscar', 'Clara', 'Lucas', 'Agnes'],
            'Oslo': ['Jakob', 'Emma', 'William', 'Nora', 'Lucas', 'Olivia', 'Oliver', 'Sofie', 'Filip', 'Leah'],
            'Helsinki': ['Onni', 'Aino', 'Eino', 'Lilja', 'VÃ¤inÃ¶', 'Ellen', 'Leo', 'Isla', 'Niilo', 'Aava'],
            
            // Europe - Eastern Europe
            'Warsaw': ['Antoni', 'Julia', 'Franciszek', 'Zuzanna', 'Aleksander', 'Zofia', 'Filip', 'Hanna', 'MikoÅ‚aj', 'Maya'],
            'Prague': ['Jakub', 'Tereza', 'Jan', 'Anna', 'TomÃ¡Å¡', 'AdÃ©la', 'Adam', 'Ema', 'MatÄ›j', 'EliÅ¡ka'],
            'Budapest': ['Bence', 'Hanna', 'MÃ¡tÃ©', 'Anna', 'Levente', 'Emma', 'DÃ¡niel', 'Luca', 'ÃdÃ¡m', 'NÃ³ra'],
            'Vienna': ['Maximilian', 'Emma', 'Alexander', 'Anna', 'Paul', 'Lena', 'David', 'Sophie', 'Elias', 'Marie'],
            'Brussels': ['Arthur', 'Emma', 'Louis', 'Olivia', 'Noah', 'Lina', 'Lucas', 'Lotte', 'Adam', 'Elena'],
            
            // Europe - Southern Europe
            'Lisbon': ['Santiago', 'Leonor', 'Francisco', 'Matilde', 'JoÃ£o', 'Beatriz', 'Afonso', 'Maria', 'TomÃ¡s', 'Carolina'],
            'Athens': ['Georgios', 'Maria', 'Dimitrios', 'Eleni', 'Konstantinos', 'Aikaterini', 'Ioannis', 'Sofia', 'Alexandros', 'Anna'],
            
            // East Asia
            'Tokyo': ['Hiroshi', 'Yuki', 'Takeshi', 'Sakura', 'Akira', 'Kenji', 'Miho', 'Ryu', 'Yumi', 'Daichi'],
            'Osaka': ['Takumi', 'Aoi', 'Haruto', 'Hina', 'Yuto', 'Sakura', 'Sota', 'Yui', 'Hayato', 'Rin'],
            'Seoul': ['Min-jun', 'So-young', 'Joon-ho', 'Hye-jin', 'Jin-woo', 'Soo-jin', 'Dong-min', 'Mi-young'],
            'Shanghai': ['Wei', 'Li', 'Zhang', 'Wang', 'Chen', 'Liu', 'Kai', 'Mei', 'Jun', 'Ling'],
            'Beijing': ['Wei', 'Li', 'Jun', 'Mei', 'Hao', 'Yan', 'Qiang', 'Hong', 'Ming', 'Xin'],
            'Hong Kong': ['Wong', 'Chan', 'Li', 'Leung', 'Ng', 'Lau', 'Cheng', 'Tang', 'Ho', 'Yuen'],
            'Taipei': ['Chen', 'Lin', 'Huang', 'Wu', 'Liu', 'Chou', 'Tsai', 'Yang', 'Wang', 'Chang'],
            
            // Middle East (Asia region)
            'Dubai': ['Ahmed', 'Fatima', 'Omar', 'Aisha', 'Ali', 'Mariam', 'Khalid', 'Sara', 'Mohammed', 'Noura'],
            'Abu Dhabi': ['Rashid', 'Amna', 'Saeed', 'Maryam', 'Hamad', 'Shamma', 'Sultan', 'Lateefa', 'Mansour', 'Hessa'],
            'Doha': ['Abdullah', 'Noor', 'Hamad', 'Fatima', 'Khalifa', 'Maryam', 'Nasser', 'Aisha', 'Saoud', 'Hind'],
            'Riyadh': ['Mohammed', 'Fatimah', 'Abdulaziz', 'Aisha', 'Abdullah', 'Sarah', 'Khalid', 'Nour', 'Faisal', 'Layan'],
            'Kuwait City': ['Yousef', 'Fatma', 'Abdullah', 'Maryam', 'Khalid', 'Reem', 'Hamad', 'Nour', 'Faisal', 'Dana'],
            'Tel Aviv': ['Daniel', 'Noa', 'David', 'Maya', 'Ariel', 'Tamar', 'Yosef', 'Shira', 'Eitan', 'Yael'],
            'Istanbul': ['Mehmet', 'Zeynep', 'Mustafa', 'Elif', 'Ahmet', 'AyÅŸe', 'Ali', 'Fatma', 'Hasan', 'Emine'],
            
            // South Asia
            'Mumbai': ['Ravi', 'Priya', 'Arjun', 'Ananya', 'Rajesh', 'Sneha', 'Vikram', 'Kavya', 'Aditya', 'Shreya'],
            'Delhi': ['Rohit', 'Priya', 'Amit', 'Pooja', 'Rahul', 'Shweta', 'Vikash', 'Neha', 'Arun', 'Deepika'],
            'Bangalore': ['Karthik', 'Divya', 'Suresh', 'Lakshmi', 'Rajesh', 'Meera', 'Naveen', 'Sowmya', 'Prakash', 'Nisha'],
            'Islamabad': ['Muhammad', 'Fatima', 'Ali', 'Aisha', 'Ahmed', 'Zainab', 'Hassan', 'Maryam', 'Usman', 'Khadija'],
            'Dhaka': ['Rashid', 'Fatima', 'Karim', 'Nasreen', 'Rahman', 'Shahida', 'Hasan', 'Rahima', 'Mahmud', 'Salma'],
            'Colombo': ['Kamal', 'Sita', 'Nimal', 'Kumari', 'Sunil', 'Mala', 'Rohan', 'Chamari', 'Dinesh', 'Priyanka'],
            
            // Southeast Asia
            'Singapore': ['Tan', 'Lim', 'Lee', 'Ong', 'Goh', 'Teo', 'Ng', 'Chen', 'Koh', 'Low'],
            'Bangkok': ['Chaiyaporn', 'Siriporn', 'Niran', 'Ploy', 'Thanakorn', 'Apinya', 'Krit', 'Nim'],
            'Kuala Lumpur': ['Ahmad', 'Siti', 'Muhammad', 'Fatimah', 'Ali', 'Nurul', 'Haziq', 'Aisyah'],
            'Jakarta': ['Budi', 'Sari', 'Adi', 'Dewi', 'Indra', 'Maya', 'Reza', 'Fitri'],
            'Manila': ['Jose', 'Maria', 'Juan', 'Ana', 'Miguel', 'Carmen', 'Luis', 'Elena'],
            'Ho Chi Minh City': ['Nguyen', 'Tran', 'Le', 'Pham', 'Hoang', 'Huynh', 'Vu', 'Vo', 'Dang', 'Bui'],
            
            // Africa - North Africa
            'Cairo': ['Mohamed', 'Fatima', 'Ahmed', 'Aisha', 'Omar', 'Yasmin', 'Ali', 'Nour', 'Hassan', 'Maryam'],
            'Alexandria': ['Mahmoud', 'Yasmin', 'Karim', 'Nour', 'Youssef', 'Salma', 'Amr', 'Dina', 'Tamer', 'Rana'],
            'Casablanca': ['Youssef', 'Aicha', 'Mohamed', 'Fatima', 'Omar', 'Khadija', 'Hassan', 'Zineb', 'Amine', 'Sara'],
            'Rabat': ['Mehdi', 'Salma', 'Khalid', 'Imane', 'Rachid', 'Ghita', 'Anas', 'Meryem', 'Hamza', 'Nadia'],
            'Marrakech': ['Abdellah', 'Aicha', 'Youssef', 'Khadija', 'Hicham', 'Fatima', 'Nabil', 'Hafsa', 'Tarik', 'Loubna'],
            'Tunis': ['Amine', 'Salma', 'Youssef', 'Rim', 'Khalil', 'Ines', 'Nabil', 'Yasmine', 'Mehdi', 'Nesrine'],
            'Algiers': ['Mohamed', 'Amina', 'Youcef', 'Fatima', 'Karim', 'Khadija', 'Amine', 'Aicha', 'Rachid', 'Sara'],
            
            // Africa - Sub-Saharan
            'Lagos': ['Chidi', 'Adaeze', 'Emeka', 'Ngozi', 'Kemi', 'Tunde', 'Funmi', 'Segun', 'Bisi', 'Yemi'],
            'Abuja': ['Chioma', 'Kelechi', 'Nneka', 'Emeka', 'Adunni', 'Babatunde', 'Folake', 'Seyi', 'Ade', 'Kemi'],
            'Johannesburg': ['Thabo', 'Nomsa', 'Sipho', 'Zanele', 'Mandla', 'Nkosana', 'Precious', 'Lucky', 'Blessing', 'Gift'],
            'Cape Town': ['Dylan', 'Chloe', 'Liam', 'Zoe', 'Ethan', 'Mia', 'Connor', 'Emma', 'Kyle', 'Paige'],
            'Durban': ['Arjun', 'Kavitha', 'Raj', 'Sita', 'Dev', 'Priya', 'Anil', 'Meera', 'Sunil', 'Deepa'],
            'Nairobi': ['David', 'Grace', 'John', 'Mary', 'Peter', 'Faith', 'Samuel', 'Ruth', 'Daniel', 'Esther'],
            'Kampala': ['Samuel', 'Sarah', 'David', 'Grace', 'Joseph', 'Rebecca', 'Moses', 'Racheal', 'Paul', 'Esther'],
            'Dar es Salaam': ['Juma', 'Fatuma', 'Hassan', 'Amina', 'Salim', 'Zainab', 'Omari', 'Halima', 'Hamisi', 'Mwajuma'],
            'Addis Ababa': ['Dawit', 'Hanna', 'Daniel', 'Rahel', 'Samuel', 'Sara', 'Michael', 'Ruth', 'Solomon', 'Meron'],
            'Accra': ['Kwame', 'Akosua', 'Kofi', 'Ama', 'Kwaku', 'Abena', 'Yaw', 'Efua', 'Kwadwo', 'Adwoa'],
            'Kinshasa': ['Jean', 'Marie', 'Paul', 'Grace', 'Joseph', 'Esther', 'Pierre', 'Ruth', 'Michel', 'Sarah'],
            'Luanda': ['JoÃ£o', 'Maria', 'AntÃ³nio', 'Ana', 'Carlos', 'Isabel', 'Manuel', 'Fernanda', 'Paulo', 'Cristina'],
            'Khartoum': ['Mohamed', 'Fatima', 'Ahmed', 'Aisha', 'Ibrahim', 'Zeinab', 'Osman', 'Amna', 'Hassan', 'Maryam'],
            
            // South America
            'SÃ£o Paulo': ['Gabriel', 'Julia', 'JoÃ£o', 'Sophia', 'Pedro', 'Isabella', 'Lucas', 'Manuela', 'Mateus', 'Laura'],
            'Rio de Janeiro': ['JoÃ£o', 'Ana', 'Pedro', 'Maria', 'Carlos', 'Beatriz', 'Rafael', 'Camila', 'Gabriel', 'Larissa'],
            'Buenos Aires': ['Santiago', 'Valentina', 'Mateo', 'Emma', 'Nicolas', 'Olivia', 'Benjamin', 'Martina', 'Thiago', 'Sofia'],
            'CÃ³rdoba': ['Franco', 'Martina', 'Mateo', 'Valentina', 'Thiago', 'Emma', 'Santino', 'Julieta', 'JoaquÃ­n', 'Mora'],
            'Rosario': ['Valentino', 'Emma', 'Mateo', 'Martina', 'Thiago', 'Valentina', 'Bautista', 'Emilia', 'Franco', 'Mora'],
            'Lima': ['Sebastian', 'Valeria', 'Diego', 'Camila', 'Alejandro', 'Isabella', 'Joaquin', 'Lucia', 'Matias', 'Fernanda'],
            'BogotÃ¡': ['Samuel', 'Sofia', 'David', 'Isabella', 'Santiago', 'Valeria', 'Alejandro', 'Camila', 'Nicolas', 'Mariana'],
            'MedellÃ­n': ['Samuel', 'SofÃ­a', 'MatÃ­as', 'Isabella', 'Santiago', 'Valeria', 'SebastiÃ¡n', 'Camila', 'Alejandro', 'Mariana'],
            'Santiago': ['Mateo', 'Sofia', 'Agustin', 'Florencia', 'Benjamin', 'Isidora', 'Vicente', 'Antonella', 'Diego', 'Emilia'],
            'ValparaÃ­so': ['Mateo', 'SofÃ­a', 'BenjamÃ­n', 'Florencia', 'Vicente', 'Isidora', 'AgustÃ­n', 'Antonella', 'Diego', 'Emilia'],
            'Caracas': ['Luis', 'MarÃ­a', 'Carlos', 'Ana', 'JosÃ©', 'Daniela', 'Miguel', 'SofÃ­a', 'Alejandro', 'Valentina'],
            'Quito': ['SebastiÃ¡n', 'SofÃ­a', 'Mateo', 'Isabella', 'Diego', 'Valentina', 'Alejandro', 'Camila', 'Santiago', 'Martina'],
            'Guayaquil': ['Mateo', 'Isabella', 'SebastiÃ¡n', 'SofÃ­a', 'Diego', 'Valentina', 'Alejandro', 'Camila', 'AdriÃ¡n', 'Martina'],
            'La Paz': ['Diego', 'SofÃ­a', 'SebastiÃ¡n', 'Isabella', 'Mateo', 'Valentina', 'Alejandro', 'Camila', 'AdriÃ¡n', 'Martina'],
            'Santa Cruz': ['SebastiÃ¡n', 'SofÃ­a', 'Mateo', 'Isabella', 'Diego', 'Valentina', 'Alejandro', 'Camila', 'AdriÃ¡n', 'Martina'],
            'Montevideo': ['Mateo', 'SofÃ­a', 'Santiago', 'Valentina', 'SebastiÃ¡n', 'Emma', 'JoaquÃ­n', 'Isabella', 'Bautista', 'Martina'],
            'AsunciÃ³n': ['Mateo', 'SofÃ­a', 'Santiago', 'Valentina', 'SebastiÃ¡n', 'Isabella', 'Diego', 'Emma', 'Alejandro', 'Camila'],
            'BrasÃ­lia': ['Gabriel', 'Ana', 'JoÃ£o', 'Maria', 'Pedro', 'Beatriz', 'Lucas', 'Julia', 'Mateus', 'Isabella'],
            'Salvador': ['Gabriel', 'Ana', 'JoÃ£o', 'Maria', 'Lucas', 'Beatriz', 'Pedro', 'Julia', 'Mateus', 'Isabella'],
            'Fortaleza': ['JoÃ£o', 'Ana', 'Pedro', 'Maria', 'Lucas', 'Beatriz', 'Gabriel', 'Julia', 'Mateus', 'Isabella'],
            
            // Oceania
            'Sydney': ['Oliver', 'Charlotte', 'William', 'Olivia', 'Jack', 'Amelia', 'Noah', 'Isla', 'Thomas', 'Mia'],
            'Melbourne': ['Henry', 'Grace', 'Charlie', 'Chloe', 'Leo', 'Zoe', 'Ethan', 'Sophie', 'Luca', 'Ruby'],
            'Brisbane': ['Mason', 'Ruby', 'Cooper', 'Chloe', 'Hudson', 'Sienna', 'Hunter', 'Piper', 'Archer', 'Mackenzie'],
            'Perth': ['Jack', 'Olivia', 'Oliver', 'Charlotte', 'William', 'Amelia', 'Noah', 'Isla', 'Thomas', 'Mia'],
            'Adelaide': ['William', 'Charlotte', 'Oliver', 'Olivia', 'Jack', 'Amelia', 'Noah', 'Isla', 'Thomas', 'Mia'],
            'Gold Coast': ['Liam', 'Emma', 'Noah', 'Olivia', 'Mason', 'Ava', 'Ethan', 'Sophia', 'Lucas', 'Isabella'],
            'Canberra': ['Oliver', 'Charlotte', 'William', 'Olivia', 'Jack', 'Amelia', 'Noah', 'Isla', 'Thomas', 'Mia'],
            'Darwin': ['Mason', 'Ruby', 'Cooper', 'Chloe', 'Hudson', 'Sienna', 'Hunter', 'Piper', 'Archer', 'Mackenzie'],
            'Newcastle': ['Liam', 'Emma', 'Noah', 'Olivia', 'Mason', 'Ava', 'Ethan', 'Sophia', 'Lucas', 'Isabella'],
            'Wollongong': ['Oliver', 'Charlotte', 'William', 'Olivia', 'Jack', 'Amelia', 'Noah', 'Isla', 'Thomas', 'Mia'],
            'Cairns': ['Mason', 'Ruby', 'Cooper', 'Chloe', 'Hudson', 'Sienna', 'Hunter', 'Piper', 'Archer', 'Mackenzie'],
            'Townsville': ['Jack', 'Olivia', 'Oliver', 'Charlotte', 'William', 'Amelia', 'Noah', 'Isla', 'Thomas', 'Mia'],
            'Geelong': ['Oliver', 'Charlotte', 'William', 'Olivia', 'Jack', 'Amelia', 'Noah', 'Isla', 'Thomas', 'Mia'],
            'Ballarat': ['William', 'Charlotte', 'Oliver', 'Olivia', 'Jack', 'Amelia', 'Noah', 'Isla', 'Thomas', 'Mia'],
            'Bendigo': ['Jack', 'Olivia', 'Oliver', 'Charlotte', 'William', 'Amelia', 'Noah', 'Isla', 'Thomas', 'Mia'],
            'Hobart': ['Oliver', 'Charlotte', 'William', 'Olivia', 'Jack', 'Amelia', 'Noah', 'Isla', 'Thomas', 'Mia'],
            'Auckland': ['Liam', 'Emma', 'Noah', 'Olivia', 'Oliver', 'Charlotte', 'William', 'Amelia', 'Jack', 'Isla'],
            'Wellington': ['Oliver', 'Charlotte', 'William', 'Olivia', 'Jack', 'Amelia', 'Noah', 'Isla', 'Thomas', 'Mia'],
            'Christchurch': ['Liam', 'Emma', 'Noah', 'Olivia', 'Oliver', 'Charlotte', 'William', 'Amelia', 'Jack', 'Isla'],
            'Hamilton': ['Liam', 'Emma', 'Noah', 'Olivia', 'Oliver', 'Charlotte', 'William', 'Amelia', 'Jack', 'Isla']
        };

        const namesByRegion = {
            'United States': [
                // Common American names
                'Alex', 'Emma', 'Liam', 'Olivia', 'Noah', 'Ava', 'Ethan', 'Sophia', 'Mason', 'Isabella', 
                'Logan', 'Charlotte', 'Lucas', 'Amelia', 'Oliver', 'Mia', 'Benjamin', 'Harper', 'Elijah', 'Evelyn', 
                'James', 'Grace', 'Sam', 'Jordan', 'Taylor', 'Casey', 'Riley', 'Avery', 'Jamie', 'Morgan', 
                'Quinn', 'Sage', 'River', 'Skylar', 'Rowan', 'Phoenix', 'Blake', 'Madison', 'Jackson', 'Zoe',
                'Michael', 'Sarah', 'David', 'Jessica', 'Christopher', 'Ashley', 'Matthew', 'Amanda', 'Joshua', 'Stephanie'
            ],
            'Europe': [
                // Mix of European names
                'Hugo', 'Emma', 'Louis', 'Chloe', 'Antoine', 'Camille', 'Marie', 'Pierre', 'Lars', 'Astrid', 
                'Erik', 'Ingrid', 'Klaus', 'Greta', 'Hans', 'Liesel', 'Marco', 'Giulia', 'Luca', 'Francesca', 
                'Miguel', 'Carmen', 'Pablo', 'Sofia', 'JoÃ£o', 'Ana', 'Carlos', 'Maria', 'Finn', 'Maja',
                'Alessandro', 'Chiara', 'Henri', 'AmÃ©lie', 'Niko', 'Elsa', 'Viktor', 'Katarina', 'Dmitri', 'Anya',
                'Franz', 'Ingrid', 'Paolo', 'Valentina', 'Gustaf', 'Astrid', 'Nicolae', 'Elena', 'PÃ©ter', 'Zara'
            ],
            'Asia': [
                // General Asian names (fallback for when specific city isn't found)
                'Alex', 'Sam', 'Jay', 'Kim', 'Lee', 'Chen', 'Lin', 'Tan', 'Wong', 'Li', 
                'Wei', 'Jin', 'Min', 'Yu', 'Kai', 'Ray', 'Amy', 'Eva', 'Maya', 'Zoe',
                'David', 'Emma', 'Anna', 'Nina', 'Kira', 'Maya', 'Aria', 'Luna', 'Leo', 'Max'
            ],
            'Africa': [
                // Mix of African names
                'Amara', 'Kofi', 'Asha', 'Kwame', 'Zara', 'Mandla', 'Kemi', 'Chidi', 'Fatima', 'Omar', 
                'Aisha', 'Ibrahim', 'Nyla', 'Tariq', 'Zuri', 'Jamal', 'Imani', 'Jabari', 'Nia', 'Kiano',
                'Thabo', 'Nomsa', 'Sipho', 'Zanele', 'Tendai', 'Chipo', 'Blessing', 'Gift', 'Emmanuel', 'Grace',
                'Yusuf', 'Khadija', 'Mahmoud', 'Amina', 'Sekou', 'Mariama', 'Kwaku', 'Akosua', 'Olu', 'Bisi'
            ],
            'South America': [
                // Latin American names
                'Alejandro', 'Isabella', 'Diego', 'Camila', 'Santiago', 'Valentina', 'Mateo', 'Gabriela', 'Emilio', 'Lucia', 
                'Rafael', 'Daniela', 'Carlos', 'Maria', 'JosÃ©', 'Ana', 'Juan', 'Carmen', 'Pablo', 'Sofia',
                'Fernando', 'Elena', 'Ricardo', 'Paola', 'Antonio', 'Beatriz', 'Miguel', 'Adriana', 'Raul', 'Esperanza',
                'Eduardo', 'Catalina', 'Rodrigo', 'Fernanda', 'Javier', 'Natalia', 'AndrÃ©s', 'Marcela', 'Victor', 'Claudia'
            ],
            'Oceania': [
                // Australian/New Zealand names (mix of Anglo and Pacific Islander)
                'Jack', 'Olivia', 'Noah', 'Charlotte', 'William', 'Amelia', 'James', 'Isla', 'Lucas', 'Mia',
                'Henry', 'Grace', 'Leo', 'Zoe', 'Mason', 'Ruby', 'Cooper', 'Chloe', 'Ethan', 'Sophie',
                'Kai', 'Aroha', 'Tane', 'Kaia', 'Nikau', 'Aria', 'Rawiri', 'Maia', 'Rangi', 'Ataahua',
                'Connor', 'Sienna', 'Ryan', 'Harper', 'Tyler', 'Mackenzie', 'Liam', 'Ella', 'Mitchell', 'Piper'
            ],
            'International': [
                // Mix of globally recognizable names
                'Alex', 'Sam', 'Jordan', 'Taylor', 'Casey', 'Riley', 'Avery', 'Jamie', 'Morgan', 'Quinn', 
                'Sage', 'River', 'Skylar', 'Rowan', 'Phoenix', 'Maya', 'Kai', 'Zara', 'Nova', 'Luna',
                'Chris', 'Lee', 'Max', 'Nico', 'Ivy', 'Kira', 'Dante', 'Atlas', 'Orion', 'Aria',
                'Daniel', 'Anna', 'Michael', 'Lisa', 'David', 'Nina', 'Tom', 'Eva', 'Ben', 'Mila'
            ]
        };
        const statusTypes = ['studying', 'break', 'focused', 'resting'];
        const studyGoals = [
            'Finish Chapter 5',
            'Finish Chapter 4',
            'Finish Chapter 3',
            'Finish Chapter 10',
            'Finish Chapter 7',
            'Finish Chapter 9',
            'Finish Chapter 8',
            'Complete practice problems',
            'Review for tomorrow\'s quiz',
            'Memorize vocabulary',
            'Write essay outline',
            'Study for final exam',
            'Practice coding problems',
            'Read research papers',
            'Complete lab report',
            'Prepare presentation',
            'Learn new concepts',
            'Review lecture notes',
            'Complete assignments',
            'Prepare for interview',
            'Study language grammar'
        ];

        // Enhanced room name generators
        const roomPrefixes = [
            'Focus', 'Study', 'Learn', 'Master', 'Ace', 'Excel', 'Boost', 'Power', 'Deep', 'Intense',
            'Quick', 'Smart', 'Bright', 'Elite', 'Pro', 'Advanced', 'Ultimate', 'Super', 'Mega', 'Global'
        ];
        const roomSuffixes = [
            'Squad', 'Group', 'Circle', 'Club', 'Hub', 'Zone', 'Space', 'Room', 'Session', 'Team',
            'Alliance', 'Network', 'Community', 'Collective', 'Society', 'Academy', 'Laboratory', 'Workshop'
        ];

        function getRandomItem(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateRandomRoomName(subject) {
            const useSubject = Math.random() > 0.3;
            if (useSubject && subject !== 'Mixed Studies') {
                return `${getRandomItem(roomPrefixes)} ${subject} ${getRandomItem(roomSuffixes)}`;
            } else {
                return `${getRandomItem(roomPrefixes)} ${getRandomItem(roomSuffixes)}`;
            }
        }

        // Global user tracking to prevent duplicates
        let globalUserIds = new Set();
        let globalUserNames = new Map(); // Maps name to count for uniqueness
        
        function generateFakeUser(roomSubjects, roomType, roomCountry = null, existingUsers = []) {
            // For International rooms, pick a random country. Otherwise use specified country
            let country;
            if (roomCountry === 'International') {
                // For International rooms, users can be from any region
                country = getRandomItem(['United States', 'Europe', 'Asia', 'Africa', 'South America', 'Oceania']);
            } else {
                country = roomCountry || getRandomItem(countries);
            }
            
            // Ensure city exists for the country
            const cityOptions = cities[country] || cities['International'] || ['Unknown City'];
            const city = getRandomItem(cityOptions);
            const timeOnApp = getRandomNumber(5, 300); // minutes
            
            // Handle Mixed Studies rooms - users can study any subject
            let userSubject;
            if (Array.isArray(roomSubjects) && roomSubjects.includes('Mixed Studies')) {
                // For "Mixed Studies" rooms, pick any random subject
                userSubject = getRandomItem(subjects.filter(s => s !== 'Mixed Studies'));
            } else if (Array.isArray(roomSubjects)) {
                // For other multi-subject rooms, pick from room's subjects
                userSubject = getRandomItem(roomSubjects);
            } else {
                // For single-subject rooms, ensure userSubject is valid
                userSubject = roomSubjects || 'Mixed Studies';
            }
            
            // Generate active timer for individual rooms with consistency
            let userTimer = null;
            let userTimerSeconds = null;
            if (roomType === 'individual') {
                // Generate more realistic timer patterns
                const timerPatterns = [
                    { min: 25, sec: 0 }, // Classic Pomodoro
                    { min: 30, sec: 0 }, // Extended focus
                    { min: 45, sec: 0 }, // Long session
                    { min: 15, sec: 0 }, // Short burst
                ];
                
                const usePattern = Math.random() < 0.6; // 60% use common patterns
                if (usePattern) {
                    const pattern = getRandomItem(timerPatterns);
                    const minutes = pattern.min + getRandomNumber(-2, 5); // Small variation
                    const seconds = pattern.sec + getRandomNumber(0, 59);
                    userTimerSeconds = Math.max(300, minutes * 60 + seconds); // Minimum 5 minutes
                } else {
                    // Random timer
                    const minutes = getRandomNumber(10, 50);
                    const seconds = getRandomNumber(0, 59);
                    userTimerSeconds = minutes * 60 + seconds;
                }
                
                const displayMinutes = Math.floor(userTimerSeconds / 60);
                const displaySeconds = userTimerSeconds % 60;
                userTimer = `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
            }
            
            // Enhanced name selection with better duplicate prevention
            let selectedName = generateUniqueName(city, country, existingUsers);
            
            // Generate unique ID with collision prevention
            let uniqueId;
            let idAttempts = 0;
            do {
                uniqueId = Math.random().toString(36).substr(2, 9);
                idAttempts++;
            } while (globalUserIds.has(uniqueId) && idAttempts < 10);
            
            // If still duplicate after 10 attempts, append timestamp
            if (globalUserIds.has(uniqueId)) {
                uniqueId = uniqueId + Date.now().toString(36).slice(-3);
            }
            
            globalUserIds.add(uniqueId);
            
            return {
                id: uniqueId,
                name: selectedName,
                location: `${city}, ${country}`,
                timeOnApp: timeOnApp,
                joinedAt: Date.now(), // Track when user joined
                status: getRandomItem(statusTypes),
                subject: userSubject,
                goal: getRandomItem(studyGoals),
                timer: userTimer,
                timerSeconds: userTimerSeconds,
                isPublicGoal: Math.random() > 0.3,
                checklist: generateChecklist(),
                lastStatusChange: Date.now()
            };
        }
        
        function generateUniqueName(city, country, existingUsers = []) {
            const existingNames = new Set(existingUsers.map(u => u.name));
            let selectedName;
            let attempts = 0;
            const maxAttempts = 50; // Increased attempts
            
            do {
                attempts++;
                
                // Select culturally appropriate name based on specific city if available, or fall back to region
                if (cityToNameMapping[city] && cityToNameMapping[city].length > 0) {
                    // Use city-specific names for better cultural accuracy
                    selectedName = getRandomItem(cityToNameMapping[city]);
                } else {
                    // Fall back to region-based names
                    const regionNames = namesByRegion[country] || namesByRegion['International'];
                    if (regionNames && regionNames.length > 0) {
                        selectedName = getRandomItem(regionNames);
                    } else {
                        // Ultimate fallback to common names
                        selectedName = getRandomItem(['Alex', 'Sam', 'Jordan', 'Taylor', 'Casey', 'Riley', 'Morgan', 'Jamie']);
                    }
                }
                
                // If name already exists, try better variations
                if (existingNames.has(selectedName) && attempts < maxAttempts) {
                    // Try culturally appropriate variations
                    const nameVariations = [];
                    
                    // Add common nickname variations
                    if (selectedName === 'Alexander') nameVariations.push('Alex', 'Sasha', 'Xander');
                    else if (selectedName === 'Elizabeth') nameVariations.push('Liz', 'Beth', 'Ellie', 'Libby');
                    else if (selectedName === 'Michael') nameVariations.push('Mike', 'Mick', 'Mickey');
                    else if (selectedName === 'Katherine') nameVariations.push('Kate', 'Katie', 'Kat', 'Kathy');
                    else if (selectedName === 'Christopher') nameVariations.push('Chris', 'Kit', 'Topher');
                    else if (selectedName === 'Jennifer') nameVariations.push('Jen', 'Jenny', 'Jenna');
                    else if (selectedName === 'Matthew') nameVariations.push('Matt', 'Matty');
                    else if (selectedName === 'Jessica') nameVariations.push('Jess', 'Jessie');
                    else if (selectedName === 'Benjamin') nameVariations.push('Ben', 'Benny', 'Benji');
                    else if (selectedName === 'Amanda') nameVariations.push('Mandy', 'Amy');
                    
                    // Add other variations for any name
                    nameVariations.push(
                        selectedName + 'a',  // Maria -> Mariaa (less obvious)
                        selectedName.slice(0, -1) + 'i', // David -> Davii 
                        selectedName + 'e',  // John -> Johne
                        selectedName.charAt(0).toUpperCase() + selectedName.slice(1).toLowerCase() + 'n' // Make it look natural
                    );
                    
                    selectedName = getRandomItem(nameVariations);
                }
                
            } while (existingNames.has(selectedName) && attempts < maxAttempts);
            
            // Track globally for future reference
            const globalCount = globalUserNames.get(selectedName) || 0;
            globalUserNames.set(selectedName, globalCount + 1);
            
            // Final fallback with natural-looking suffix (avoid numbers)
            if (existingNames.has(selectedName)) {
                const naturalSuffixes = ['Jr', 'II', 'Lee', 'Mae', 'Ann', 'Ray', 'Jay', 'Lin'];
                selectedName = `${selectedName} ${getRandomItem(naturalSuffixes)}`;
            }
            
            return selectedName;
        }

        function generateChecklist() {
            const tasks = [
                'Read chapter introduction',
                'Complete practice questions',
                'Review key concepts',
                'Take notes on examples',
                'Summarize main points',
                'Check understanding',
                'Prepare for quiz',
                'Watch tutorial videos',
                'Complete homework',
                'Review flashcards'
            ];
            const taskCount = getRandomNumber(1, 3);
            return tasks.slice(0, taskCount).map(task => ({
                id: Math.random().toString(36).substr(2, 9),
                text: task,
                completed: Math.random() > 0.7
            }));
        }

        // Enhanced room generation for instant join compatibility
        function generateInstantJoinRoom(isIndividual = null) {
            // Force room type if specified, otherwise 50/50 split
            const roomType = isIndividual !== null ? (isIndividual ? 'individual' : 'synchronized') : 
                             (Math.random() > 0.5 ? 'individual' : 'synchronized');
            
            const primarySubject = getRandomItem(subjects.filter(s => s !== 'Mixed Studies'));
            const timerStyle = getRandomItem(timerTypes);
            const participantCount = getRandomNumber(4, 25);
            const country = Math.random() > 0.2 ? getRandomItem(countries) : 'International';
            const ageRange = Math.random() > 0.05 ? getRandomItem(ageRanges.filter(age => age !== 'Mixed Ages')) : 'Mixed Ages';
            
            let syncTimer = null;
            if (roomType === 'synchronized') {
                syncTimer = generateInstantJoinSyncTimer(timerStyle);
            }
            
            const users = Array.from({length: participantCount}, () => generateFakeUser(primarySubject, roomType, country));
            
            return {
                id: Math.random().toString(36).substr(2, 9),
                name: generateRandomRoomName(primarySubject),
                primarySubject: primarySubject,
                subjects: [primarySubject],
                type: roomType,
                timerStyle: timerStyle,
                school: getRandomItem(schools),
                ageRange: ageRange,
                country: country,
                participants: participantCount,
                users: users,
                createdAt: new Date(Date.now() - getRandomNumber(1, 2880) * 60000),
                syncTimer: syncTimer,
                lastActivity: new Date(Date.now() - getRandomNumber(1, 60) * 60000),
                isInstantJoinCompatible: true
            };
        }

        function generateInstantJoinSyncTimer(timerStyle) {
            if (timerStyle === 'Pomodoro') {
                const pomodoroPatterns = [
                    { study: 25, break: 5 },
                    { study: 25, break: 10 },
                    { study: 30, break: 5 },
                    { study: 30, break: 10 },
                    { study: 50, break: 5 },
                    { study: 50, break: 10 }
                ];
                
                const pattern = getRandomItem(pomodoroPatterns);
                
                // For instant join: 40% waiting, 40% break, 20% early study phase
                const state = Math.random();
                if (state < 0.4) {
                    // Waiting/restarting state
                    return {
                        studyDuration: pattern.study,
                        breakDuration: pattern.break,
                        remaining: getRandomNumber(1, 5) * 60,
                        isRunning: true,
                        isStudyPhase: true,
                        isWaiting: true,
                        cycle: getRandomNumber(1, 4)
                    };
                } else if (state < 0.8) {
                    // Break phase
                    return {
                        studyDuration: pattern.study,
                        breakDuration: pattern.break,
                        remaining: getRandomNumber(1, pattern.break) * 60,
                        isRunning: true,
                        isStudyPhase: false,
                        isWaiting: false,
                        cycle: getRandomNumber(1, 4)
                    };
                } else {
                    // Early study phase (first 30% of study time)
                    const earlyStudyTime = Math.floor(pattern.study * 0.3);
                    return {
                        studyDuration: pattern.study,
                        breakDuration: pattern.break,
                        remaining: getRandomNumber(earlyStudyTime, pattern.study) * 60,
                        isRunning: true,
                        isStudyPhase: true,
                        isWaiting: false,
                        cycle: getRandomNumber(1, 4)
                    };
                }
            } else {
                const basicDurations = [30, 45, 60, 75, 90, 105, 120];
                const duration = getRandomItem(basicDurations);
                
                // 60% chance of waiting state, 40% early study phase
                if (Math.random() < 0.6) {
                    return {
                        duration: duration,
                        remaining: getRandomNumber(1, 5) * 60,
                        isRunning: true,
                        isStudyPhase: true,
                        isWaiting: true
                    };
                } else {
                    // Early study phase (first 20% of total time)
                    const earlyStudyTime = Math.floor(duration * 0.2);
                    return {
                        duration: duration,
                        remaining: getRandomNumber(earlyStudyTime, duration) * 60,
                        isRunning: true,
                        isStudyPhase: true,
                        isWaiting: false
                    };
                }
            }
        }

        function generateRoom() {
            // Decide if this is a mixed subject room or specific subject room
            const roomTypeChance = Math.random();
            let roomSubjects, primarySubject;
            
            if (roomTypeChance < 0.25) {
                // 25% chance: Mixed Studies room - anyone can join with any subject
                primarySubject = 'Mixed Studies';
                roomSubjects = ['Mixed Studies']; // Special marker for "all subjects allowed" rooms
            } else {
                // 75% chance: Specific subject room
                primarySubject = getRandomItem(subjects.filter(s => s !== 'Mixed Studies'));
                roomSubjects = [primarySubject];
            }
            
            const roomType = Math.random() > 0.5 ? 'synchronized' : 'individual';
            const timerStyle = getRandomItem(timerTypes);
            const participantCount = getRandomNumber(4, 25);
            // Increased specific country probability to 80%
            const country = Math.random() > 0.2 ? getRandomItem(countries) : 'International';
            // Increased specific age range probability to 95%
            const ageRange = Math.random() > 0.05 ? getRandomItem(ageRanges.filter(age => age !== 'Mixed Ages')) : 'Mixed Ages';
            const users = Array.from({length: participantCount}, () => generateFakeUser(roomSubjects, roomType, country));
            
            // Generate consistent timer settings for the room
            let roomTimerSettings = null;
            if (roomType === 'synchronized') {
                if (timerStyle === 'Pomodoro') {
                    // Predefined Pomodoro patterns
                    const patterns = [
                        { study: 25, break: 5 },
                        { study: 25, break: 10 },
                        { study: 30, break: 5 },
                        { study: 30, break: 10 },
                        { study: 50, break: 5 },
                        { study: 50, break: 10 }
                    ];
                    roomTimerSettings = getRandomItem(patterns);
                } else {
                    // Simple timer durations
                    const durations = [30, 45, 60, 75, 90, 105, 120];
                    roomTimerSettings = { duration: getRandomItem(durations) };
                }
            } else {
                // Individual rooms - store default settings but users can change them
                roomTimerSettings = { 
                    defaultStudy: 25, 
                    defaultBreak: 5, 
                    defaultSimple: 60,
                    allowsCustomization: true 
                };
            }
            
            const room = {
                id: Math.random().toString(36).substr(2, 9),
                name: generateRandomRoomName(primarySubject),
                primarySubject: primarySubject,
                subjects: roomSubjects,
                type: roomType,
                timerStyle: timerStyle,
                timerSettings: roomTimerSettings, // Store consistent timer settings
                school: getRandomItem(schools),
                ageRange: ageRange,
                country: country,
                participants: participantCount,
                users: users,
                createdAt: new Date(Date.now() - getRandomNumber(1, 2880) * 60000), // Random time in last 48 hours
                syncTimer: roomType === 'synchronized' ? generateSyncTimer(timerStyle, roomTimerSettings) : null,
                lastActivity: new Date(Date.now() - getRandomNumber(1, 60) * 60000) // Last activity within last hour
            };
            
            return room;
        }

        function generateSyncTimer(timerStyle, roomTimerSettings) {
            if (timerStyle === 'Pomodoro') {
                // Use the room's specific timer settings if provided
                let pattern;
                if (roomTimerSettings && roomTimerSettings.study && roomTimerSettings.break) {
                    pattern = { study: roomTimerSettings.study, break: roomTimerSettings.break };
                } else {
                    // Fallback to predefined patterns
                    const pomodoroPatterns = [
                        { study: 25, break: 5 },
                        { study: 25, break: 10 },
                        { study: 30, break: 5 },
                        { study: 30, break: 10 },
                        { study: 50, break: 5 },
                        { study: 50, break: 10 }
                    ];
                    pattern = getRandomItem(pomodoroPatterns);
                }
                
                // 15% chance of being in waiting state (yellow circle)
                if (Math.random() < 0.15) {
                    return {
                        studyDuration: pattern.study,
                        breakDuration: pattern.break,
                        remaining: getRandomNumber(1, 5) * 60, // 1-5 minutes waiting
                        isRunning: true,
                        isStudyPhase: true,
                        isWaiting: true,
                        cycle: getRandomNumber(1, 4)
                    };
                }
                
                const isStudyPhase = Math.random() > 0.3;
                const currentDuration = isStudyPhase ? pattern.study : pattern.break;
                
                return {
                    studyDuration: pattern.study,
                    breakDuration: pattern.break,
                    remaining: getRandomNumber(1, currentDuration) * 60, // seconds
                    isRunning: true,
                    isStudyPhase: isStudyPhase,
                    isWaiting: false,
                    cycle: getRandomNumber(1, 4)
                };
            } else {
                // Use the room's specific duration if provided
                let duration;
                if (roomTimerSettings && roomTimerSettings.duration) {
                    duration = roomTimerSettings.duration;
                } else {
                    // Fallback to predefined durations
                    const basicDurations = [30, 45, 60, 75, 90, 105, 120];
                    duration = getRandomItem(basicDurations);
                }
                
                // 10% chance of being in waiting state (yellow circle)
                if (Math.random() < 0.1) {
                    return {
                        duration: duration,
                        remaining: getRandomNumber(1, 5) * 60, // 1-5 minutes waiting
                        isRunning: true,
                        isStudyPhase: true,
                        isWaiting: true
                    };
                }
                
                return {
                    duration: duration,
                    remaining: getRandomNumber(5, duration) * 60, // seconds
                    isRunning: true,
                    isStudyPhase: true,
                    isWaiting: false
                };
            }
        }

        function generateRoomsWithGuarantees() {
            const rooms = [];
            
            // Generate guaranteed minimums for each filter category
            // Ensure at least 5 rooms for each age range (for filtering)
            const guaranteedAges = ageRanges.filter(age => age !== 'Mixed Ages');
            guaranteedAges.forEach(ageRange => {
                for (let i = 0; i < 5; i++) {
                    const room = generateRoom();
                    room.ageRange = ageRange;
                    rooms.push(room);
                }
            });
            
            // Ensure at least 5 rooms for EVERY subject (for filtering)
            const guaranteedSubjects = ['Mathematics', 'Science', 'Computer Science', 'History', 'English', 'Physics', 'Chemistry', 'Biology', 'Engineering', 'Business', 'Medicine', 'Law', 'Psychology', 'Economics', 'Language Learning', 'Test Prep', 'Art', 'Music', 'Data Science'];
            guaranteedSubjects.forEach(subject => {
                for (let i = 0; i < 5; i++) {
                    const room = generateRoom();
                    room.primarySubject = subject;
                    room.subjects = [subject];
                    // Re-generate room name with the correct subject
                    room.name = generateRandomRoomName(subject);
                    // Re-generate users with the correct subject
                    room.users = Array.from({length: room.participants}, () => generateFakeUser(subject, room.type, room.country));
                    rooms.push(room);
                }
            });
            
            // Ensure at least 5 rooms for EVERY country (for filtering)
            const guaranteedCountries = ['United States', 'Europe', 'Asia', 'Africa', 'South America', 'Oceania'];
            guaranteedCountries.forEach(country => {
                for (let i = 0; i < 5; i++) {
                    const room = generateRoom();
                    room.country = country;
                    // Re-generate users with the correct country
                    room.users = Array.from({length: room.participants}, () => generateFakeUser(room.subjects, room.type, country));
                    rooms.push(room);
                }
            });
            
            // Ensure both timer types are represented (at least 8 rooms each)
            for (let i = 0; i < 8; i++) {
                const pomodoroRoom = generateRoom();
                pomodoroRoom.timerStyle = 'Pomodoro';
                rooms.push(pomodoroRoom);
                
                const simpleRoom = generateRoom();
                simpleRoom.timerStyle = 'Simple Timer';
                rooms.push(simpleRoom);
            }
            
            // Ensure both room types are represented (at least 8 rooms each)
            for (let i = 0; i < 8; i++) {
                const syncRoom = generateRoom();
                syncRoom.type = 'synchronized';
                rooms.push(syncRoom);
                
                const individualRoom = generateRoom();
                individualRoom.type = 'individual';
                rooms.push(individualRoom);
            }
            
            // Generate MORE rooms with broader categories for better filtering fallbacks
            // Add 15 Mixed Ages rooms
            for (let i = 0; i < 15; i++) {
                const room = generateRoom();
                room.ageRange = 'Mixed Ages';
                rooms.push(room);
            }
            
            // Add 15 International rooms
            for (let i = 0; i < 15; i++) {
                const room = generateRoom();
                room.country = 'International';
                rooms.push(room);
            }
            
            // Add 15 Mixed Studies rooms
            for (let i = 0; i < 15; i++) {
                const room = generateRoom();
                room.primarySubject = 'Mixed Studies';
                room.subjects = ['Mixed Studies'];
                // Mixed Studies rooms allow users with any subject
                room.users = Array.from({length: room.participants}, () => generateFakeUser(['Mixed Studies'], room.type, room.country));
                rooms.push(room);
            }
            
            // Add 10 rooms with 2 broad categories
            for (let i = 0; i < 10; i++) {
                const room = generateRoom();
                const categories = ['age', 'country', 'subject'];
                const selectedCategories = categories.sort(() => Math.random() - 0.5).slice(0, 2);
                
                if (selectedCategories.includes('age')) room.ageRange = 'Mixed Ages';
                if (selectedCategories.includes('country')) room.country = 'International';
                if (selectedCategories.includes('subject')) {
                    room.primarySubject = 'Mixed Studies';
                    room.subjects = ['Mixed Studies'];
                    room.users = Array.from({length: room.participants}, () => generateFakeUser(['Mixed Studies'], room.type, room.country));
                }
                rooms.push(room);
            }
            
            // Add 5 rooms with all 3 broad categories
            for (let i = 0; i < 5; i++) {
                const room = generateRoom();
                room.ageRange = 'Mixed Ages';
                room.country = 'International';
                room.primarySubject = 'Mixed Studies';
                room.subjects = ['Mixed Studies'];
                room.users = Array.from({length: room.participants}, () => generateFakeUser(['Mixed Studies'], room.type, room.country));
                rooms.push(room);
            }
            
            // Generate instant-join compatible rooms (at least 40 rooms)
            const instantJoinRooms = [];
            
            // Generate 20 individual timer rooms (always instant-join compatible)
            for (let i = 0; i < 20; i++) {
                instantJoinRooms.push(generateInstantJoinRoom(true));
            }
            
            // Generate 20 synchronized timer rooms (break/waiting states only)
            for (let i = 0; i < 20; i++) {
                instantJoinRooms.push(generateInstantJoinRoom(false));
            }
            
            rooms.push(...instantJoinRooms);
            
            // Generate remaining random rooms to reach total of 120+ rooms
            const remainingCount = Math.max(0, 120 - rooms.length);
            for (let i = 0; i < remainingCount; i++) {
                rooms.push(generateRoom());
            }
            
            // Shuffle to distribute the guaranteed rooms randomly
            for (let i = rooms.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [rooms[i], rooms[j]] = [rooms[j], rooms[i]];
            }
            
            return rooms;
        }

        // Enhanced filtering with instant-join logic
        function roomPassesFilters(room, filters) {
            // EDGE CASE: Validate inputs
            if (!room || !filters) {
                console.warn('Invalid room or filters passed to roomPassesFilters:', { room, filters });
                return false;
            }
            
            const { search, subject, age, country, timer, type } = filters;
            
            // EDGE CASE: Validate room has required properties
            if (!room.name || !room.type || !room.primarySubject) {
                console.warn('Room missing required properties:', room);
                return false;
            }
            
            // Handle instant-join filter FIRST - completely separate logic
            if (type === 'instant-join') {
                // Individual rooms are always good for instant joining
                if (room.type === 'individual') {
                    // Apply other filters to individual rooms too
                    if (search) {
                        try {
                            const searchableText = [
                                (room.name || '').toLowerCase(),
                                ...(room.subjects || [room.primarySubject]).map(s => (s || '').toLowerCase()),
                                (room.country || '').toLowerCase(),
                                (room.ageRange || '').toLowerCase(),
                                (room.timerStyle || '').toLowerCase(),
                                (room.type || '').toLowerCase()
                            ].filter(text => text.length > 0); // Remove empty strings
                            
                            if (!searchableText.some(text => text.includes(search))) return false;
                        } catch (error) {
                            console.warn('Search filtering error for individual room:', error, room);
                            return false;
                        }
                    }
                    if (subject) {
                        // EDGE CASE: Handle null/undefined subject filter gracefully
                        try {
                            // For Mixed Studies rooms, they accept any subject filter, but continue checking other filters
                            if (room.primarySubject !== 'Mixed Studies') {
                                // For specific subject rooms, must match exactly
                                if (room.primarySubject !== subject && !(room.subjects && room.subjects.includes(subject))) {
                                    return false;
                                }
                            }
                        } catch (error) {
                            console.warn('Subject filtering error for individual room:', error, room);
                            return false;
                        }
                    }
                    if (age && room.ageRange !== age && room.ageRange !== 'Mixed Ages') return false;
                    if (country && room.country !== country && room.country !== 'International') return false;
                    if (timer) {
                        // EDGE CASE: Handle invalid timer values gracefully
                        try {
                            const roomTimerStyle = room.timerStyle === 'Pomodoro' ? 'Pomodoro' : 'Simple';
                            const filterTimerStyle = timer === 'Pomodoro' ? 'Pomodoro' : 'Simple';
                            if (roomTimerStyle !== filterTimerStyle) return false;
                        } catch (error) {
                            console.warn('Timer filtering error for individual room:', error, room);
                            return false;
                        }
                    }
                    return true;
                }
                
                // Synchronized rooms need to be in good joining states
                if (room.type === 'synchronized') {
                    // EDGE CASE: Handle missing or malformed syncTimer
                    if (!room.syncTimer || typeof room.syncTimer !== 'object') {
                        console.warn('Missing or invalid syncTimer for synchronized room:', room);
                        return false;
                    }
                    
                    try {
                        const isRestarting = room.syncTimer.isWaiting;
                        const isOnBreak = room.syncTimer.studyDuration && !room.syncTimer.isStudyPhase;
                        
                        // Only show rooms that are restarting or on break - NOT rooms already studying
                        if (isRestarting || isOnBreak) {
                            // Apply other filters to sync rooms too
                            if (search) {
                                try {
                                    const searchableText = [
                                        (room.name || '').toLowerCase(),
                                        ...(room.subjects || [room.primarySubject]).map(s => (s || '').toLowerCase()),
                                        (room.country || '').toLowerCase(),
                                        (room.ageRange || '').toLowerCase(),
                                        (room.timerStyle || '').toLowerCase(),
                                        (room.type || '').toLowerCase(),
                                        (room.school || '').toLowerCase()
                                    ].filter(text => text.length > 0);

                                    // Add timer-specific searchable terms (same as regular search)
                                    if (room.syncTimer) {
                                        if (room.syncTimer.studyDuration) {
                                            searchableText.push(`${room.syncTimer.studyDuration} min`, `${room.syncTimer.studyDuration}min`);
                                            searchableText.push(`${room.syncTimer.breakDuration} min`, `${room.syncTimer.breakDuration}min`);
                                            searchableText.push(`${room.syncTimer.studyDuration}/${room.syncTimer.breakDuration}`);
                                        } else if (room.syncTimer.duration) {
                                            searchableText.push(`${room.syncTimer.duration} min`, `${room.syncTimer.duration}min`);
                                        }
                                    }

                                    // Add status-specific searchable terms
                                    if (room.syncTimer.isWaiting) {
                                        searchableText.push('restarting', 'waiting', 'joining', 'new users');
                                    } else if (room.syncTimer.isStudyPhase === false) {
                                        searchableText.push('break', 'rest', 'break time');
                                    } else {
                                        searchableText.push('studying', 'focus', 'active');
                                    }

                                    // Enhanced search matching - use word boundaries and exact matches for numbers
                                    const matches = searchableText.some(text => {
                                        // For number + "min" combinations, use exact word matching
                                        if (search.includes('min') || /\d/.test(search)) {
                                            // Extract numbers from search term
                                            const searchNumbers = search.match(/\d+/g);
                                            if (searchNumbers) {
                                                // Check if any of the search numbers appear as exact matches in the text
                                                return searchNumbers.some(num => {
                                                    // Use word boundaries to ensure exact number matches
                                                    const regex = new RegExp(`\\b${num}\\b`, 'i');
                                                    return regex.test(text);
                                                });
                                            }
                                        }
                                        // For other searches, use contains matching
                                        return text.includes(search);
                                    });
                                    if (!matches) return false;
                                } catch (error) {
                                    console.warn('Search filtering error for sync room:', error, room);
                                    return false;
                                }
                            }
                            if (subject) {
                                try {
                                    // For Mixed Studies rooms, they accept any subject filter, but continue checking other filters
                                    if (room.primarySubject !== 'Mixed Studies') {
                                        // For specific subject rooms, must match exactly
                                        if (room.primarySubject !== subject && !(room.subjects && room.subjects.includes(subject))) {
                                            return false;
                                        }
                                    }
                                } catch (error) {
                                    console.warn('Subject filtering error for sync room:', error, room);
                                    return false;
                                }
                            }
                            if (age && room.ageRange !== age && room.ageRange !== 'Mixed Ages') return false;
                            if (country && room.country !== country && room.country !== 'International') return false;
                            if (timer) {
                                try {
                                    const roomTimerStyle = room.timerStyle === 'Pomodoro' ? 'Pomodoro' : 'Simple';
                                    const filterTimerStyle = timer === 'Pomodoro' ? 'Pomodoro' : 'Simple';
                                    if (roomTimerStyle !== filterTimerStyle) return false;
                                } catch (error) {
                                    console.warn('Timer filtering error for sync room:', error, room);
                                    return false;
                                }
                            }
                            return true;
                        }
                    } catch (error) {
                        console.warn('Error processing synchronized room for instant join:', error, room);
                        return false;
                    }
                }
                
                return false; // Not suitable for instant join
            }

            // For all other filters (all, synchronized, individual)
            
            // Enhanced search term functionality
            if (search) {
                try {
                    const searchableText = [
                        (room.name || '').toLowerCase(),
                        ...(room.subjects || [room.primarySubject]).map(s => (s || '').toLowerCase()),
                        (room.country || '').toLowerCase(),
                        (room.ageRange || '').toLowerCase(),
                        (room.timerStyle || '').toLowerCase(),
                        (room.type || '').toLowerCase(),
                        (room.school || '').toLowerCase()
                    ].filter(text => text.length > 0);

                    // Add timer-specific searchable terms
                    if (room.syncTimer) {
                        if (room.syncTimer.studyDuration) {
                            searchableText.push(`${room.syncTimer.studyDuration} min`, `${room.syncTimer.studyDuration}min`);
                            searchableText.push(`${room.syncTimer.breakDuration} min`, `${room.syncTimer.breakDuration}min`);
                            searchableText.push(`${room.syncTimer.studyDuration}/${room.syncTimer.breakDuration}`);
                        } else if (room.syncTimer.duration) {
                            searchableText.push(`${room.syncTimer.duration} min`, `${room.syncTimer.duration}min`);
                        }

                        // Add status-specific searchable terms
                        if (room.syncTimer.isWaiting) {
                            searchableText.push('restarting', 'waiting', 'joining', 'new users');
                        } else if (room.syncTimer.isStudyPhase === false) {
                            searchableText.push('break', 'rest', 'break time');
                        } else {
                            searchableText.push('studying', 'focus', 'active');
                        }
                    }

                    // Enhanced search matching - use word boundaries and exact matches for numbers
                    const matches = searchableText.some(text => {
                        try {
                            // For number + "min" combinations, use exact word matching
                            if (search.includes('min') || /\d/.test(search)) {
                                // Extract numbers from search term
                                const searchNumbers = search.match(/\d+/g);
                                if (searchNumbers) {
                                    // Check if any of the search numbers appear as exact matches in the text
                                    return searchNumbers.some(num => {
                                        try {
                                            // Use word boundaries to ensure exact number matches
                                            const regex = new RegExp(`\\b${num}\\b`, 'i');
                                            return regex.test(text);
                                        } catch (regexError) {
                                            console.warn('Regex error in number matching:', regexError);
                                            return text.includes(num);
                                        }
                                    });
                                }
                            }
                            // For other searches, use contains matching
                            return text.includes(search);
                        } catch (textError) {
                            console.warn('Error in text matching:', textError);
                            return false;
                        }
                    });
                    if (!matches) return false;
                } catch (error) {
                    console.warn('Search filtering error:', error, room);
                    return false;
                }
            }

            // Room type filter
            if (type !== 'all' && room.type !== type) {
                return false;
            }

            // STRICT: Subject filtering - only exact matches or Mixed Studies when specifically selected
            if (subject) {
                if (subject === 'Mixed Studies') {
                    // User specifically selected Mixed Studies - show Mixed Studies rooms only
                    if (room.primarySubject !== 'Mixed Studies') {
                        return false;
                    }
                } else {
                    // User selected specific subject - show exact matches OR Mixed Studies rooms (they accept any subject)
                    if (room.primarySubject !== subject && room.primarySubject !== 'Mixed Studies' && !room.subjects.includes(subject)) {
                        return false;
                    }
                }
            }

            // STRICT: Age filter - only exact matches or Mixed Ages when specifically selected
            if (age) {
                if (age === 'Mixed Ages') {
                    // User specifically selected Mixed Ages - show Mixed Ages rooms only
                    if (room.ageRange !== 'Mixed Ages') {
                        return false;
                    }
                } else {
                    // User selected specific age - show exact matches OR Mixed Ages rooms (they accept any age)
                    if (room.ageRange !== age && room.ageRange !== 'Mixed Ages') {
                        return false;
                    }
                }
            }

            // STRICT: Country filter - only exact matches or International when specifically selected
            if (country) {
                if (country === 'International') {
                    // User specifically selected International - show International rooms only
                    if (room.country !== 'International') {
                        return false;
                    }
                } else {
                    // User selected specific country - show exact matches OR International rooms (they accept any country)
                    if (room.country !== country && room.country !== 'International') {
                        return false;
                    }
                }
            }

            // Timer filter - normalize both room and filter values for proper comparison
            if (timer) {
                // Normalize room timer style: "Pomodoro" stays "Pomodoro", anything else becomes "Simple"
                const roomTimerStyle = room.timerStyle === 'Pomodoro' ? 'Pomodoro' : 'Simple';
                // Normalize filter value: "Pomodoro" stays "Pomodoro", anything else becomes "Simple"  
                const filterTimerStyle = timer === 'Pomodoro' ? 'Pomodoro' : 'Simple';
                if (roomTimerStyle !== filterTimerStyle) {
                    return false;
                }
            }

            return true;
        }

        function ensureInstantJoinRooms(currentFiltered) {
            // Count current instant-join compatible rooms
            const instantJoinCount = currentFiltered.filter(room => 
                roomPassesFilters(room, { ...currentFilters, type: 'instant-join' })
            ).length;
            
            // If less than 30, generate more (but limit total rooms to prevent memory issues)
            if (instantJoinCount < 30 && allRooms.length < 200) {
                const needed = Math.min(30 - instantJoinCount, 200 - allRooms.length);
                const newRooms = [];
                
                // Generate 50% individual, 50% synchronized rooms
                const individualNeeded = Math.ceil(needed / 2);
                const syncNeeded = needed - individualNeeded;
                
                for (let i = 0; i < individualNeeded; i++) {
                    const room = generateInstantJoinRoom(true);
                    // Apply current filters to new room
                    if (currentFilters.subject) {
                        room.primarySubject = currentFilters.subject;
                        room.subjects = [currentFilters.subject];
                    }
                    if (currentFilters.age && currentFilters.age !== 'Mixed Ages') {
                        room.ageRange = currentFilters.age;
                    }
                    if (currentFilters.country && currentFilters.country !== 'International') {
                        room.country = currentFilters.country;
                    }
                    if (currentFilters.timer) {
                        room.timerStyle = currentFilters.timer === 'Pomodoro' ? 'Pomodoro' : 'Simple Timer';
                    }
                    newRooms.push(room);
                }
                
                for (let i = 0; i < syncNeeded; i++) {
                    const room = generateInstantJoinRoom(false);
                    // Apply current filters to new room
                    if (currentFilters.subject) {
                        room.primarySubject = currentFilters.subject;
                        room.subjects = [currentFilters.subject];
                    }
                    if (currentFilters.age && currentFilters.age !== 'Mixed Ages') {
                        room.ageRange = currentFilters.age;
                    }
                    if (currentFilters.country && currentFilters.country !== 'International') {
                        room.country = currentFilters.country;
                    }
                    if (currentFilters.timer) {
                        room.timerStyle = currentFilters.timer === 'Pomodoro' ? 'Pomodoro' : 'Simple Timer';
                    }
                    newRooms.push(room);
                }
                
                // Add new rooms to global list
                allRooms.push(...newRooms);
                console.log(`Generated ${newRooms.length} new instant-join rooms (Total: ${allRooms.length})`);
            }
        }

        function filterRooms() {
            // Update current filters
            currentFilters = {
                search: document.getElementById('searchRooms').value.toLowerCase(),
                subject: document.getElementById('filterSubject').value,
                age: document.getElementById('filterAge').value,
                country: document.getElementById('filterCountry').value,
                timer: document.getElementById('filterTimer').value,
                type: document.querySelector('.room-filter-btn.active').dataset.filter
            };

            // Check if user has applied specific filters (not just search or 'all' type)
            const hasSpecificFilters = currentFilters.subject || currentFilters.age || currentFilters.country || currentFilters.timer;

            // PROACTIVE GENERATION: If user applies specific filters, immediately generate perfect matches
            if (hasSpecificFilters && currentFilters.type !== 'instant-join') {
                console.log('Specific filters detected, generating perfect-match rooms immediately...');
                
                const newPerfectMatches = [];
                const roomsToGenerate = getRandomNumber(3, 6); // Generate 3-6 perfect matches
                
                for (let i = 0; i < roomsToGenerate; i++) {
                    const room = generatePerfectMatchRoom(currentFilters);
                    room.isPerfectMatch = true; // Mark for priority sorting
                    room.generatedAt = Date.now(); // Track when generated
                    newPerfectMatches.push(room);
                }
                
                // Add perfect matches to the beginning of rooms array
                allRooms.unshift(...newPerfectMatches);
                console.log(`Generated ${newPerfectMatches.length} perfect-match rooms for current filters`);
            }

            let filtered = allRooms.filter(room => roomPassesFilters(room, currentFilters));

            // Special handling for instant-join filter
            if (currentFilters.type === 'instant-join') {
                ensureInstantJoinRooms(filtered);
                // Re-filter after potentially adding new rooms
                filtered = allRooms.filter(room => roomPassesFilters(room, currentFilters));
            }

            // SMART SORTING: Bring perfect matches to the top
            if (hasSpecificFilters) {
                filtered.sort((a, b) => {
                    // Perfect matches first
                    if (a.isPerfectMatch && !b.isPerfectMatch) return -1;
                    if (!a.isPerfectMatch && b.isPerfectMatch) return 1;
                    
                    // Among perfect matches, show most recently generated first
                    if (a.isPerfectMatch && b.isPerfectMatch) {
                        return (b.generatedAt || 0) - (a.generatedAt || 0);
                    }
                    
                    // For non-perfect matches, sort by activity (most recent first)
                    return new Date(b.lastActivity) - new Date(a.lastActivity);
                });
            }

            renderRooms(filtered);
        }

        // Generate a room that perfectly matches all specified filters
        function generatePerfectMatchRoom(filters) {
            const room = generateRoom();
            
            // Apply ALL specified filters to create perfect match
            if (filters.subject && filters.subject !== 'Mixed Studies') {
                room.primarySubject = filters.subject;
                room.subjects = [filters.subject];
            }
            if (filters.age && filters.age !== 'Mixed Ages') {
                room.ageRange = filters.age;
            }
            if (filters.country && filters.country !== 'International') {
                room.country = filters.country;
            }
            if (filters.timer) {
                room.timerStyle = filters.timer === 'Pomodoro' ? 'Pomodoro' : 'Simple Timer';
            }
            if (filters.type !== 'all') {
                room.type = filters.type;
            }
            
            // Re-generate users that match the room's perfect criteria
            const roomSubjectsForUsers = room.subjects;
            const roomCountryForUsers = room.country;
            room.users = Array.from({length: room.participants}, () => 
                generateFakeUser(roomSubjectsForUsers, room.type, roomCountryForUsers)
            );
            
            // Update room name to reflect the perfect match
            if (filters.subject && filters.subject !== 'Mixed Studies') {
                room.name = generateRandomRoomName(filters.subject);
            }
            
            // Mark as recently created
            room.lastActivity = new Date();
            room.createdAt = new Date();
            
            return room;
        }

        function renderRooms(rooms = allRooms) {
            const roomsGrid = document.getElementById('roomsGrid');
            const activeFilter = document.querySelector('.room-filter-btn.active')?.dataset.filter || 'all';
            
            roomsGrid.innerHTML = rooms.map(room => {
                // Mixed Studies rooms just show "Mixed Studies" - no "+number" since they allow any subject
                const subjectDisplay = room.primarySubject === 'Mixed Studies' ? 
                    'Mixed Studies' : 
                    room.primarySubject;
                
                // Generate timer details display that MATCHES what you get when joining the room
                let timerInfo = '';
                if (room.type === 'synchronized' && room.syncTimer) {
                    // Synchronized rooms: show the actual current timer state
                    if (room.timerStyle === 'Pomodoro') {
                        const studyDur = room.syncTimer.studyDuration || 25;
                        const breakDur = room.syncTimer.breakDuration || 5;
                        let phase;
                        if (room.syncTimer.isWaiting) {
                            phase = 'Restarting';
                        } else if (room.syncTimer.isStudyPhase) {
                            phase = 'Studying';
                        } else {
                            phase = 'Break';
                        }
                        timerInfo = `Sync Pomodoro: ${studyDur}/${breakDur} min â€¢ ${phase}`;
                    } else {
                        const duration = room.syncTimer.duration || 60;
                        const phase = room.syncTimer.isWaiting ? 'Restarting' : 'Studying';
                        timerInfo = `Sync Timer: ${duration} min â€¢ ${phase}`;
                    }
                } else if (room.type === 'individual') {
                    // Individual rooms: show what timer types are actually available
                    if (room.timerStyle === 'Pomodoro') {
                        timerInfo = `Individual (Default: Pomodoro)`;
                    } else {
                        timerInfo = `Individual (Default: Simple Timer)`;
                    }
                } else {
                    // Fallback for any edge cases
                    timerInfo = `Individual (Choose your timer)`;
                }
                
                // Circle color logic with instant join filter fix
                let circleColor = '';
                if (room.type === 'individual') {
                    // Individual rooms always show blue circles with dark mode support
                    circleColor = 'bg-blue-500 dark:bg-[#dbeafe]';
                } else if (room.type === 'synchronized') {
                    // Ensure synchronized rooms always have a circle
                    if (room.syncTimer && room.syncTimer.isRunning) {
                        if (activeFilter === 'instant-join') {
                            // For instant join: only show yellow circles
                            circleColor = 'bg-yellow-500 dark:bg-yellow-400';
                        } else {
                            // For other filters: show proper status colors
                            if (room.syncTimer.isWaiting) {
                                circleColor = 'bg-yellow-500 dark:bg-yellow-400';
                            } else if (room.syncTimer.isStudyPhase) {
                                circleColor = 'bg-green-500 dark:bg-[#dbfce7]';
                            } else {
                                circleColor = 'bg-yellow-500 dark:bg-yellow-400';
                            }
                        }
                    } else {
                        // Fallback for synchronized rooms without proper timer state
                        circleColor = 'bg-green-500 dark:bg-[#dbfce7]';
                    }
                }
                
                return `
                    <div class="room-card bg-white/60 backdrop-blur-md rounded-xl p-6 border border-muted-pink-200 hover:border-muted-pink-300 cursor-pointer" data-room-id="${room.id}">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-warm-gray-900 truncate">${room.name}</h3>
                            <div class="flex items-center space-x-1">
                                <span class="px-2 py-1 text-xs rounded-full ${room.type === 'synchronized' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                    ${room.type === 'synchronized' ? 'Sync' : 'Individual'}
                                </span>
                                ${circleColor ? `<div class="w-2 h-2 ${circleColor} rounded-full animate-pulse-soft"></div>` : ''}
                            </div>
                        </div>
                        <div class="space-y-2 text-sm text-warm-gray-600 dark:text-black mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-book text-muted-pink-500 dark:text-[#ffbfe7] w-4"></i>
                                <span class="ml-2 text-warm-gray-600 dark:text-black" title="${room.subjects.join(', ')}">${subjectDisplay}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock text-muted-pink-500 dark:text-[#ffbfe7] w-4"></i>
                                <span class="ml-2 text-warm-gray-600 dark:text-black">${timerInfo}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-globe text-muted-pink-500 dark:text-[#ffbfe7] w-4"></i>
                                <span class="ml-2 text-warm-gray-600 dark:text-black">${room.country}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-users text-muted-pink-500 dark:text-[#ffbfe7] w-4"></i>
                                <span class="ml-2 text-warm-gray-600 dark:text-black">${room.ageRange}</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <div class="flex -space-x-2">
                                    ${room.users.slice(0, 4).map(() => `
                                        <div class="w-6 h-6 bg-muted-pink-400 rounded-full border-2 border-white"></div>
                                    `).join('')}
                                    ${room.participants > 4 ? `<div class="w-6 h-6 bg-warm-gray-400 rounded-full border-2 border-white flex items-center justify-center text-xs text-white">+${room.participants - 4}</div>` : ''}
                                </div>
                                <span class="text-sm text-warm-gray-600 dark:text-black">${room.participants} studying</span>
                            </div>
                            <span class="text-xs text-warm-gray-500 dark:text-gray-800">${formatTimeAgo(room.lastActivity)}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Add click handlers
            document.querySelectorAll('.room-card').forEach(card => {
                card.addEventListener('click', () => {
                    const roomId = card.dataset.roomId;
                    const room = rooms.find(r => r.id === roomId);
                    joinRoom(room);
                });
            });
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Active now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
            return `${Math.floor(diffInMinutes / 1440)}d ago`;
        }

        // Store the pending room for join confirmation
        let pendingRoomToJoin = null;

        function joinRoom(room) {
            // Check if user is already in a room (either viewing it or has it in background)
            if (currentRoom || backgroundRoom) {
                // Show confirmation modal
                pendingRoomToJoin = room;
                const existingRoom = currentRoom || backgroundRoom;
                document.getElementById('currentRoomNameInModal').textContent = existingRoom.name;
                document.getElementById('newRoomNameInModal').textContent = room.name;
                document.getElementById('joinNewRoomModal').classList.remove('hidden');
                document.getElementById('joinNewRoomModal').classList.add('flex');
                return;
            }

            // Actually join the room
            actuallyJoinRoom(room);
        }

        function actuallyJoinRoom(room) {
            // Stop any existing timers
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            // Stop study time tracking from previous room
            stopStudyTimeTracking();

            // Reset timer state for new room
            isRunning = false;
            currentTime = 0;
            isStudyPhase = true; // Reset to study phase

            // Set isPomodoro based on room's timer style
            isPomodoro = (room.timerStyle === 'Pomodoro');

            currentRoom = room;
            backgroundRoom = null;
            isViewingDashboard = false;

            // Hide background indicator if showing
            hideBackgroundRoomIndicator();

            // Update room header
            document.getElementById('roomTitle').textContent = room.name;
            document.getElementById('roomParticipants').textContent = `${room.participants} participants`;
            
            // Update room details section
            document.getElementById('roomSubject').textContent = room.primarySubject;
            document.getElementById('roomTimerInfo').textContent = `${room.timerStyle} Style`;
            document.getElementById('roomCountry').textContent = room.country;
            document.getElementById('roomAgeRange').textContent = room.ageRange;
            
            // Handle timer display based on room type
            if (room.type === 'synchronized' && room.syncTimer) {
                // Show sync timer
                document.getElementById('individualTimerControls').classList.add('hidden');
                document.getElementById('syncTimerInfo').classList.remove('hidden');
                
                // Set up sync timer display
                updateSyncTimerDisplay(room.syncTimer);
                startSyncTimer();
            } else {
                // Show individual timer controls
                document.getElementById('individualTimerControls').classList.remove('hidden');
                document.getElementById('syncTimerInfo').classList.add('hidden');
                
                // Set default timer display
                document.getElementById('mainTimer').textContent = '25:00';
                document.getElementById('timerStatus').textContent = 'Ready to start';
                document.getElementById('timerPhase').textContent = '';
                document.getElementById('startTimerBtn').textContent = 'Start Timer';
                
                // Set timer type based on room - fix the logic
                const timerSelect = document.getElementById('timerType');
                if (room.timerStyle === 'Pomodoro') {
                    timerSelect.value = 'pomodoro';
                } else {
                    timerSelect.value = 'simple';
                }
                toggleTimerSettings();
            }
            
            // Check if current user is already in the room
            const existingUser = room.users.find(user => user.isCurrentUser);
            
            if (!existingUser) {
                // Add current user to room only if not already present
                const currentUser = {
                    id: 'current-user',
                    name: userProfile.name,
                    location: userProfile.location,
                    timeOnApp: studyTimeToday,
                    joinedAt: realUserSessionStart, // Use global session start (persists across rooms)
                    status: userStatus,
                    subject: room.primarySubject,
                    goal: 'Set your goal...',
                    timer: room.type === 'synchronized' ? null : '00:00',
                    isPublicGoal: goalVisibility,
                    isCurrentUser: true,
                    checklist: []
                };
                
                room.users.unshift(currentUser);
                room.participants++; // Increment when real user joins
            }
            
            // Participant count should match actual users array
            room.participants = room.users.length;
            
            renderUsers(room.users);
            renderChecklist();
            
            // Update participant count in header
            document.getElementById('roomParticipants').textContent = `${room.participants} participants`;
            
            // Switch views
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('roomView').classList.remove('hidden');
            
            // Pre-fill subject
            const subjectInput = room.type === 'synchronized' ? 'userSubjectSync' : 'userSubject';
            document.getElementById(subjectInput).value = room.primarySubject;
            
            // Add welcome message for the real user
            setTimeout(() => {
                const welcomeMessages = [
                    `Welcome to ${room.name}! ðŸŽ‰`,
                    `${userProfile.name} joined the study group!`,
                    `Great to have you here! Let's make this a productive session! ðŸ’ª`,
                    `Welcome! Ready to study together? ðŸ“š`
                ];
                addSystemMessage(getRandomItem(welcomeMessages));
            }, 1000);
            
            // Start enhanced chat
            startEnhancedChat();

            // Start fake user timers for individual rooms
            if (room.type === 'individual') {
                startFakeUserTimers();
            }

            // Start fake user status updates
            startFakeUserStatusUpdates();

            // Start updating online times every minute
            startOnlineTimeUpdates();
        }

        function renderUsers(users) {
            const usersList = document.getElementById('usersList');
            
            // Safety check for null/undefined users
            if (!users || !Array.isArray(users)) {
                console.warn('renderUsers called with invalid users data:', users);
                return;
            }
            
            usersList.innerHTML = users.map(user => {
                const statusEmoji = getStatusEmoji(user.status);
                const statusColor = getStatusColor(user.status);
                
                return `
                    <div class="flex items-center justify-between p-4 bg-white/40 rounded-lg border border-muted-pink-100 hover:bg-white/60 transition-all">
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <div class="w-10 h-10 bg-muted-pink-400 rounded-full flex items-center justify-center">
                                    ${user.isCurrentUser ? '<i class="fas fa-user text-white"></i>' : '<i class="fas fa-user-graduate text-white"></i>'}
                                </div>
                                <div class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-white ${statusColor}"></div>
                            </div>
                            <div>
                                <div class="flex items-center space-x-2">
                                    <h4 class="font-medium text-warm-gray-900">${user.name}</h4>
                                    ${user.isCurrentUser ? '<span class="px-2 py-0.5 text-xs bg-muted-pink-100 text-muted-pink-700 rounded-full">You</span>' : ''}
                                </div>
                                <p class="text-sm text-warm-gray-600">${user.location}</p>
                                <p class="text-xs text-warm-gray-500 online-time" data-user-id="${user.id}">Online for ${formatOnlineTime(calculateOnlineTime(user))}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-sm font-medium text-warm-gray-900">${user.subject}</span>
                                <span class="text-lg">${statusEmoji}</span>
                            </div>
                            ${currentRoom && currentRoom.type === 'individual' && user.timer ? `<div class="text-sm text-warm-gray-600 timer-display">${user.timer}</div>` : ''}
                            ${user.isPublicGoal ? `<div class="text-xs text-warm-gray-500 mt-1">${user.goal}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusEmoji(status) {
            const emojis = {
                'studying': 'ðŸ“š',
                'break': 'â˜•',
                'focused': 'ðŸ”¥',
                'resting': 'ðŸ˜´'
            };
            return emojis[status] || 'ðŸ“š';
        }

        function getStatusColor(status) {
            const colors = {
                'studying': 'bg-green-500',
                'break': 'bg-yellow-500',
                'focused': 'bg-red-500',
                'resting': 'bg-blue-500'
            };
            return colors[status] || 'bg-gray-400';
        }

        function formatOnlineTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;

            if (minutes < 60) return `${minutes}min`;
            if (minutes < 1440) return `${hours}hr ${mins}min`;
            const days = Math.floor(minutes / 1440);
            const remainingHours = Math.floor((minutes % 1440) / 60);
            return `${days}d ${remainingHours}hr`;
        }

        // Calculate current online time based on joinedAt timestamp
        function calculateOnlineTime(user) {
            if (!user.joinedAt) return user.timeOnApp || 0;
            const now = Date.now();
            const minutesOnline = Math.floor((now - user.joinedAt) / 60000);
            return (user.timeOnApp || 0) + minutesOnline;
        }

        // Enhanced timer functionality with Pomodoro support
        let timerInterval = null;
        let currentTime = 0;
        let isRunning = false;
        let isPomodoro = false;
        let isStudyPhase = true;
        let pomodoroStudyDuration = 25;
        let pomodoroBreakDuration = 5;

        function toggleTimerSettings() {
            const timerType = document.getElementById('timerType').value;
            const pomodoroSettings = document.getElementById('pomodoroSettings');
            const simpleSettings = document.getElementById('simpleSettings');
            
            if (timerType === 'pomodoro') {
                pomodoroSettings.classList.remove('hidden');
                simpleSettings.classList.add('hidden');
                isPomodoro = true;
            } else {
                pomodoroSettings.classList.add('hidden');
                simpleSettings.classList.remove('hidden');
                isPomodoro = false;
            }
        }

        function toggleCreateRoomTimerSettings() {
            const timerStyle = document.getElementById('newRoomTimerStyle').value;
            const pomodoroSettings = document.getElementById('newRoomPomodoroSettings');
            const simpleSettings = document.getElementById('newRoomSimpleSettings');
            
            if (timerStyle === 'pomodoro') {
                pomodoroSettings.classList.remove('hidden');
                simpleSettings.classList.add('hidden');
            } else {
                pomodoroSettings.classList.add('hidden');
                simpleSettings.classList.remove('hidden');
            }
        }

        function startTimer() {
            if (!isRunning) {
                if (isPomodoro) {
                    pomodoroStudyDuration = parseInt(document.getElementById('studyDuration').value);
                    pomodoroBreakDuration = parseInt(document.getElementById('breakDuration').value);
                    
                    if (currentTime === 0) {
                        currentTime = (isStudyPhase ? pomodoroStudyDuration : pomodoroBreakDuration) * 60;
                    }
                    
                    // Show notification for Pomodoro timer start
                    const phase = isStudyPhase ? 'Study' : 'Break';
                    const duration = isStudyPhase ? pomodoroStudyDuration : pomodoroBreakDuration;
                    showTimerNotification(`ðŸŽ¯ Pomodoro ${phase} Started!`, `${duration} minute ${phase.toLowerCase()} session is now active`);
                    
                    // Send chat message when starting study session
                    if (chatEnabled && isStudyPhase) {
                        const studyMessages = [
                            `Starting my ${duration}-minute focus session! Let's do this! ðŸŽ¯`,
                            `Beginning a ${duration} min Pomodoro study session! ðŸ“š`,
                            `Time to focus! ${duration} minutes of productive studying ahead! ðŸ’ª`,
                            `Pomodoro timer started! ${duration} min of deep work mode activated! ðŸ”¥`
                        ];
                        addChatMessage('You', getRandomItem(studyMessages), true);
                    }
                } else {
                    const duration = parseInt(document.getElementById('simpleDuration').value);
                    if (currentTime === 0) {
                        currentTime = duration * 60;
                    }
                    
                    // Show notification for Simple timer start
                    showTimerNotification('â° Study Timer Started!', `${duration} minute study session is now active`);
                    
                    // Send chat message when starting study session
                    if (chatEnabled) {
                        const studyMessages = [
                            `Starting my ${duration}-minute study session! Time to focus! ðŸ“š`,
                            `Beginning a ${duration} min focused study session! Let's go! ðŸŽ¯`,
                            `Study timer activated! ${duration} minutes of productive learning ahead! ðŸ’ª`,
                            `Ready to tackle this ${duration} min study session! ðŸ”¥`
                        ];
                        addChatMessage('You', getRandomItem(studyMessages), true);
                    }
                }
                
                isRunning = true;
                document.getElementById('startTimerBtn').textContent = 'Running...';
                updateTimerStatus();

                startValidatedTimer();

                // Start tracking study time
                startStudyTimeTracking();

                updateUserStatus(isPomodoro && !isStudyPhase ? 'break' : 'studying');
            }
        }

        function pauseTimer() {
            if (isRunning) {
                isRunning = false;
                clearInterval(timerInterval);
                document.getElementById('startTimerBtn').textContent = 'Resume';
                document.getElementById('timerStatus').textContent = 'Paused';
                updateUserStatus('break');
                
                // Show notification for timer pause
                if (isPomodoro) {
                    const phase = isStudyPhase ? 'Study' : 'Break';
                    showTimerNotification('â¸ï¸ Timer Paused', `Pomodoro ${phase.toLowerCase()} session paused`);
                } else {
                    showTimerNotification('â¸ï¸ Timer Paused', 'Study session paused');
                }
                
                // Send chat message when pausing/finishing study session
                if (chatEnabled) {
                    const pauseMessages = [
                        'Taking a break from studying! Be back soon! â˜•',
                        'Pausing my timer for a quick break ðŸ›‘',
                        'Study session paused - time for a breather! ðŸ˜Š',
                        'Taking a moment to rest and recharge! âš¡'
                    ];
                    addChatMessage('You', getRandomItem(pauseMessages), true);
                }
            }
        }

        function completePomodoroCycle() {
            isStudyPhase = !isStudyPhase;
            
            if (isStudyPhase) {
                // Completed a break, starting new study session
                currentTime = pomodoroStudyDuration * 60;
                document.getElementById('timerStatus').textContent = 'Study Time!';
                document.getElementById('timerPhase').textContent = 'Focus Session';
                updateUserStatus('studying');
                
                if (chatEnabled) {
                    addChatMessage('You', 'Starting a new focus session! ðŸŽ¯', true);
                }
            } else {
                // Completed a study session, starting break
                currentTime = pomodoroBreakDuration * 60;
                document.getElementById('timerStatus').textContent = 'Break Time!';
                document.getElementById('timerPhase').textContent = 'Rest & Recharge';
                updateUserStatus('break');
                
                // Update study time
                studyTimeToday += pomodoroStudyDuration;
                updateStudyTimeDisplay();
                
                if (chatEnabled) {
                    addChatMessage('You', 'Great study session! Taking a well-deserved break â˜•', true);
                }
            }
            
            updateTimerDisplay();
        }

        function completeTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            currentTime = 0;
            document.getElementById('startTimerBtn').textContent = 'Start';
            document.getElementById('timerStatus').textContent = 'Session Complete!';
            document.getElementById('timerPhase').textContent = '';
            document.getElementById('mainTimer').textContent = '00:00';
            
            // Update study time for simple timer
            if (!isPomodoro) {
                const duration = parseInt(document.getElementById('simpleDuration').value);
                studyTimeToday += duration;
                updateStudyTimeDisplay();
                
                // Show notification for Simple timer completion
                showTimerNotification('âœ… Timer Complete!', `Great ${duration} minute study session completed!`);
                
                // Send chat message when completing study session
                if (chatEnabled) {
                    const completionMessages = [
                        `Just finished a ${duration}-minute study session! Feeling accomplished! ðŸŽ‰`,
                        `Study session complete! That was a productive ${duration} minutes! âœ…`,
                        `${duration} min timer done! Time for a well-deserved break! â˜•`,
                        `Completed my ${duration} minute focus session! Great progress made! ðŸ’ª`
                    ];
                    addChatMessage('You', getRandomItem(completionMessages), true);
                }
            } else {
                // Show notification for Pomodoro timer completion
                const phase = isStudyPhase ? 'Study' : 'Break';
                const duration = isStudyPhase ? pomodoroStudyDuration : pomodoroBreakDuration;
                showTimerNotification('âœ… Pomodoro Complete!', `${phase} session (${duration} min) completed!`);
                
                // Send chat message when completing pomodoro session
                if (chatEnabled) {
                    const completionMessages = [
                        `Pomodoro ${phase.toLowerCase()} session complete! ${duration} minutes well spent! ðŸŽ‰`,
                        `Just finished my ${duration}-min ${phase.toLowerCase()} period! Pomodoro technique works! âœ…`,
                        `${phase} timer done! ${duration} minutes of focused work completed! ðŸ’ª`,
                        `Pomodoro ${phase.toLowerCase()} complete! Great ${duration} min session! ðŸ…`
                    ];
                    addChatMessage('You', getRandomItem(completionMessages), true);
                }
            }
            
            updateUserStatus('break');
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('mainTimer').textContent = display;

            // Update background timer display if viewing dashboard
            if (isViewingDashboard && backgroundRoom) {
                document.getElementById('backgroundTimerDisplay').textContent = display;
            }

            // Update current user's timer display in study buddies list
            if (currentRoom && currentRoom.type === 'individual' && currentRoom.users[0].isCurrentUser) {
                currentRoom.users[0].timer = display;
                renderUsers(currentRoom.users);
            }
        }

        function updateTimerStatus() {
            if (isPomodoro) {
                document.getElementById('timerStatus').textContent = isStudyPhase ? 'Study Time' : 'Break Time';
                document.getElementById('timerPhase').textContent = isStudyPhase ? 'Focus Session' : 'Rest & Recharge';

                // Update background timer status
                if (isViewingDashboard && backgroundRoom) {
                    document.getElementById('backgroundTimerStatus').textContent = isStudyPhase ? 'Study Time' : 'Break Time';
                }
            } else {
                document.getElementById('timerStatus').textContent = 'Study Session';
                document.getElementById('timerPhase').textContent = '';

                // Update background timer status
                if (isViewingDashboard && backgroundRoom) {
                    document.getElementById('backgroundTimerStatus').textContent = 'Study Time';
                }
            }
        }

        function updateUserStatus(status) {
            userStatus = status;
            const statusSelect = document.getElementById('userStatusSelect');
            if (statusSelect) {
                statusSelect.value = status;
            }
            
            if (currentRoom && currentRoom.users && currentRoom.users[0] && currentRoom.users[0].isCurrentUser) {
                currentRoom.users[0].status = status;
                const subjectInput = currentRoom.type === 'synchronized' ? 'userSubjectSync' : 'userSubject';
                const inputElement = document.getElementById(subjectInput);
                if (inputElement) {
                    currentRoom.users[0].subject = inputElement.value || currentRoom.primarySubject;
                }
                renderUsers(currentRoom.users);
            }
        }

        // Study time display function
        function updateStudyTimeDisplay() {
            const hours = Math.floor(studyTimeToday / 60);
            const mins = studyTimeToday % 60;
            let displayText = '';

            if (studyTimeToday < 60) {
                displayText = `${studyTimeToday}min`;
            } else {
                displayText = `${hours}hr ${mins}min`;
            }

            document.getElementById('totalStudyTime').textContent = displayText;
        }

        // Interval IDs for cleanup
        let onlineTimeUpdateInterval = null;
        let studyTimeUpdateInterval = null;

        // Update online times every minute
        function startOnlineTimeUpdates() {
            // Clear any existing interval
            if (onlineTimeUpdateInterval) {
                clearInterval(onlineTimeUpdateInterval);
            }

            // Update immediately
            updateOnlineTimes();

            // Then update every minute (60 seconds)
            onlineTimeUpdateInterval = setInterval(updateOnlineTimes, 60000);
        }

        function updateOnlineTimes() {
            // Get the active room (either current or background)
            const activeRoom = currentRoom || backgroundRoom;
            if (!activeRoom || !activeRoom.users) return;

            // Update each user's online time in the DOM
            activeRoom.users.forEach(user => {
                const element = document.querySelector(`.online-time[data-user-id="${user.id}"]`);
                if (element) {
                    const currentOnlineTime = calculateOnlineTime(user);
                    element.textContent = `Online for ${formatOnlineTime(currentOnlineTime)}`;
                }
            });
        }

        // Update study time every minute while timer is running
        function startStudyTimeTracking() {
            if (studyTimeUpdateInterval) {
                clearInterval(studyTimeUpdateInterval);
            }

            // Update every minute (60 seconds) while studying
            studyTimeUpdateInterval = setInterval(() => {
                if (isRunning && isStudyPhase) {
                    studyTimeToday += 1; // Add 1 minute
                    updateStudyTimeDisplay();

                    // Update the current user's timeOnApp in whichever room they're in
                    const activeRoom = currentRoom || backgroundRoom;
                    if (activeRoom && activeRoom.users) {
                        const realUser = activeRoom.users.find(u => u.isCurrentUser);
                        if (realUser) {
                            realUser.timeOnApp = studyTimeToday;
                        }
                    }
                }
            }, 60000); // Every 60 seconds
        }

        function stopStudyTimeTracking() {
            if (studyTimeUpdateInterval) {
                clearInterval(studyTimeUpdateInterval);
                studyTimeUpdateInterval = null;
            }
        }

        // Profile functionality
        function openProfileModal() {
            // Pre-fill current profile data
            document.getElementById('profileName').value = userProfile.name === 'You' ? '' : userProfile.name;
            document.getElementById('profileLocation').value = userProfile.location === 'Your Location' ? '' : userProfile.location;
            document.getElementById('profileSchool').value = userProfile.school;
            document.getElementById('profileAgeGroup').value = userProfile.ageGroup;
            
            document.getElementById('profileModal').classList.remove('hidden');
            document.getElementById('profileModal').classList.add('flex');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
            document.getElementById('profileModal').classList.remove('flex');
        }

        function saveProfile() {
            const name = document.getElementById('profileName').value.trim() || 'You';
            const location = document.getElementById('profileLocation').value.trim() || 'Your Location';
            const school = document.getElementById('profileSchool').value.trim();
            const ageGroup = document.getElementById('profileAgeGroup').value;
            
            // Update profile
            userProfile.name = name;
            userProfile.location = location;
            userProfile.school = school;
            userProfile.ageGroup = ageGroup;
            
            // Update UI
            document.getElementById('userName').textContent = name;
            
            // Update current user in room if present
            if (currentRoom && currentRoom.users && currentRoom.users[0] && currentRoom.users[0].isCurrentUser) {
                currentRoom.users[0].name = name;
                currentRoom.users[0].location = location;
                renderUsers(currentRoom.users);
            }
            
            closeProfileModal();
            
            // Show success message
            const successModal = document.createElement('div');
            successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            successModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-sm w-full mx-4 text-center animate-bounce-gentle">
                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-white text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-warm-gray-900 dark:text-white mb-2">Profile Updated!</h3>
                    <p class="text-warm-gray-600 dark:text-gray-400 text-sm">Your profile information has been saved successfully.</p>
                </div>
            `;
            document.body.appendChild(successModal);
            
            setTimeout(() => {
                if (successModal.parentNode) {
                    successModal.remove();
                }
            }, 2000);
        }

        // Enhanced sync timer functionality
        function updateSyncTimerDisplay(syncTimer) {
            try {
                // Validate syncTimer object and its properties
                if (!syncTimer || typeof syncTimer.remaining !== 'number' || isNaN(syncTimer.remaining)) {
                    console.error('Invalid syncTimer data:', syncTimer);
                    document.getElementById('mainTimer').textContent = '00:00';
                    document.getElementById('timerStatus').textContent = 'Timer Error';
                    document.getElementById('timerPhase').textContent = 'Please restart the timer';
                    return;
                }

                const minutes = Math.floor(Math.abs(syncTimer.remaining) / 60);
                const seconds = Math.abs(syncTimer.remaining) % 60;
                const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('mainTimer').textContent = display;

                // Update background timer display if viewing dashboard
                if (isViewingDashboard && backgroundRoom) {
                    document.getElementById('backgroundTimerDisplay').textContent = display;
                }

                if (syncTimer.studyDuration && syncTimer.breakDuration) {
                    // Pomodoro style - validate durations
                    const studyDur = parseInt(syncTimer.studyDuration) || 25;
                    const breakDur = parseInt(syncTimer.breakDuration) || 5;
                    const cycle = parseInt(syncTimer.cycle) || 1;
                    
                    if (syncTimer.isWaiting) {
                        document.getElementById('timerStatus').textContent = `Restarting Pomodoro (${studyDur}/${breakDur} min)`;
                        document.getElementById('timerPhase').textContent = 'Waiting for new users to join...';
                        // Update background timer status
                        if (isViewingDashboard && backgroundRoom) {
                            document.getElementById('backgroundTimerStatus').textContent = 'Restarting';
                        }
                    } else if (syncTimer.isStudyPhase) {
                        document.getElementById('timerStatus').textContent = `Pomodoro Study (${studyDur} min)`;
                        document.getElementById('timerPhase').textContent = `Focus Session - Cycle ${cycle}`;
                        // Update background timer status
                        if (isViewingDashboard && backgroundRoom) {
                            document.getElementById('backgroundTimerStatus').textContent = 'Study Time';
                        }
                    } else {
                        document.getElementById('timerStatus').textContent = `Pomodoro Break (${breakDur} min)`;
                        document.getElementById('timerPhase').textContent = 'Rest & Recharge';
                        // Update background timer status
                        if (isViewingDashboard && backgroundRoom) {
                            document.getElementById('backgroundTimerStatus').textContent = 'Break Time';
                        }
                    }
                } else {
                    // Simple timer style - validate duration
                    const duration = parseInt(syncTimer.duration) || 60;
                    
                    if (syncTimer.isWaiting) {
                        document.getElementById('timerStatus').textContent = `Restarting (${duration} min timer)`;
                        document.getElementById('timerPhase').textContent = 'Waiting for new users to join...';
                        // Update background timer status
                        if (isViewingDashboard && backgroundRoom) {
                            document.getElementById('backgroundTimerStatus').textContent = 'Restarting';
                        }
                    } else {
                        document.getElementById('timerStatus').textContent = `Study Session (${duration} min)`;
                        document.getElementById('timerPhase').textContent = 'Continuous Focus Mode';
                        // Update background timer status
                        if (isViewingDashboard && backgroundRoom) {
                            document.getElementById('backgroundTimerStatus').textContent = 'Study Time';
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating sync timer display:', error);
                document.getElementById('mainTimer').textContent = '00:00';
                document.getElementById('timerStatus').textContent = 'Display Error';
                document.getElementById('timerPhase').textContent = '';
            }
        }

        function startSyncTimer() {
            if (currentRoom && currentRoom.syncTimer && currentRoom.syncTimer.isRunning) {
                // Show notification for synchronized timer start
                if (currentRoom.syncTimer.studyDuration && currentRoom.syncTimer.breakDuration) {
                    // Pomodoro timer
                    const studyDur = currentRoom.syncTimer.studyDuration;
                    const breakDur = currentRoom.syncTimer.breakDuration;
                    if (currentRoom.syncTimer.isWaiting) {
                        showTimerNotification('â° Synchronized Timer', `Waiting period (${Math.ceil(currentRoom.syncTimer.remaining / 60)} min) - ${studyDur}/${breakDur} Pomodoro room`);
                    } else if (currentRoom.syncTimer.isStudyPhase) {
                        showTimerNotification('ðŸŽ¯ Synchronized Study!', `Pomodoro study session (${studyDur} min) synchronized with room`);
                    } else {
                        showTimerNotification('â˜• Synchronized Break!', `Pomodoro break time (${breakDur} min) synchronized with room`);
                    }
                } else {
                    // Simple timer
                    const duration = currentRoom.syncTimer.duration;
                    if (currentRoom.syncTimer.isWaiting) {
                        showTimerNotification('â° Synchronized Timer', `Waiting period (${Math.ceil(currentRoom.syncTimer.remaining / 60)} min) - ${duration} min study room`);
                    } else {
                        showTimerNotification('â° Synchronized Study!', `Study session (${duration} min) synchronized with room`);
                    }
                }
                
                roomTimer = setInterval(() => {
                    currentRoom.syncTimer.remaining--;
                    updateSyncTimerDisplay(currentRoom.syncTimer);
                    
                    if (currentRoom.syncTimer.remaining <= 0) {
                        if (currentRoom.syncTimer.isWaiting) {
                            // Waiting period is over, restart the timer
                            currentRoom.syncTimer.isWaiting = false;
                            const restartDuration = currentRoom.syncTimer.studyDuration || currentRoom.syncTimer.duration || 25;
                            currentRoom.syncTimer.remaining = restartDuration * 60;
                            updateSyncTimerDisplay(currentRoom.syncTimer);
                            updateUserStatus('studying');
                            
                            // Show notification for timer restart
                            showTimerNotification('ðŸš€ Timer Restarted!', `Synchronized study session is now active (${restartDuration} min)`);
                            
                            if (chatEnabled) {
                                addChatMessage('You', 'New study session starting! Let\'s focus! ðŸŽ¯', true);
                            }
                        } else {
                            completeSyncTimer();
                        }
                    }
                }, 1000);
                
                updateUserStatus(currentRoom.syncTimer.isStudyPhase ? 'studying' : 'break');
            }
        }

        function completeSyncTimer() {
            if (!currentRoom || !currentRoom.syncTimer) return;
            
            try {
                if (currentRoom.syncTimer.studyDuration && currentRoom.syncTimer.breakDuration) {
                    // Pomodoro style - switch phases with validation
                    currentRoom.syncTimer.isStudyPhase = !currentRoom.syncTimer.isStudyPhase;
                    
                    // Validate timer durations before using them
                    const studyDur = parseInt(currentRoom.syncTimer.studyDuration) || 25;
                    const breakDur = parseInt(currentRoom.syncTimer.breakDuration) || 5;
                    
                    if (currentRoom.syncTimer.isStudyPhase) {
                        // Starting new study session
                        currentRoom.syncTimer.remaining = studyDur * 60;
                        currentRoom.syncTimer.cycle = (currentRoom.syncTimer.cycle || 0) + 1;
                        studyTimeToday += breakDur;
                        
                        showTimerNotification('ðŸŽ¯ Study Time!', `Focus session ${currentRoom.syncTimer.cycle} started (${studyDur} min)`);
                    } else {
                        // Starting break
                        currentRoom.syncTimer.remaining = breakDur * 60;
                        studyTimeToday += studyDur;
                        
                        showTimerNotification('â˜• Break Time!', `Well deserved break (${breakDur} min)`);
                    }
                    
                    // Ensure timer keeps running
                    currentRoom.syncTimer.isRunning = true;
                    currentRoom.syncTimer.isWaiting = false;
                    
                    updateSyncTimerDisplay(currentRoom.syncTimer);
                    updateUserStatus(currentRoom.syncTimer.isStudyPhase ? 'studying' : 'break');
                    
                    if (chatEnabled) {
                        const message = currentRoom.syncTimer.isStudyPhase ? 
                            `New study session starting! Session ${currentRoom.syncTimer.cycle} ðŸŽ¯` : 'Break time everyone! â˜•';
                        addChatMessage('You', message, true);
                    }
                    
                } else {
                    // Simple timer style - validate duration before using
                    const duration = parseInt(currentRoom.syncTimer.duration) || 60;
                    
                    // Enter waiting period instead of restarting immediately
                    currentRoom.syncTimer.isWaiting = true;
                    currentRoom.syncTimer.remaining = 5 * 60; // 5 minutes waiting period
                    studyTimeToday += duration;
                    
                    showTimerNotification('â° Session Complete!', `Great ${duration} min session! New timer starts in 5 minutes`);
                    
                    updateSyncTimerDisplay(currentRoom.syncTimer);
                    updateUserStatus('break');
                    
                    if (chatEnabled) {
                        addChatMessage('You', `Great ${duration} min session completed! New timer starts in 5 minutes â°`, true);
                    }
                }
                
                updateStudyTimeDisplay();
                
            } catch (error) {
                console.error('Timer completion error:', error);
                // Restart timer with safe defaults if something goes wrong
                restartTimerWithDefaults();
            }
        }

        // Enhanced chat functionality with better AI responses
        let recentChatMessages = []; // Track recent messages to prevent repeating
        let recentFakeMessages = []; // Track fake user messages for inter-fake replies
        let lastChatMessageTime = 0; // Global chat cooldown
        let conversationLength = 0; // Track length of current conversation
        let chatCooldownActive = false; // Prevent message flooding
        let userResponseTracker = {}; // Track which fake users have responded to which real user messages
        let fakeUserRecentMessages = {}; // Track recent messages per fake user to prevent repetition

        function addChatMessage(sender, message, isCurrentUser = false, replyingTo = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isCurrentUser ? 'text-right' : ''}`;

            // Add reply context if provided
            const replyContext = replyingTo ? `
                <div class="text-xs mb-1 italic opacity-75 ${isCurrentUser ? 'text-pink-100' : 'text-gray-500 dark:text-gray-400'}">
                    â†³ replying to <span class="font-medium">${replyingTo.sender}</span>: "${replyingTo.message.substring(0, 40)}${replyingTo.message.length > 40 ? '...' : ''}"
                </div>
            ` : '';

            messageDiv.innerHTML = `
                <div class="${isCurrentUser ? 'bg-muted-pink-500 text-white ml-8' : 'bg-white/60 mr-8'} rounded-lg p-3 inline-block max-w-xs">
                    ${!isCurrentUser ? `<div class="text-xs font-medium text-muted-pink-600 mb-1">${sender}</div>` : ''}
                    ${replyContext}
                    <div class="text-sm">${message}</div>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Store last user message for potential replies
            if (isCurrentUser) {
                lastUserMessage = {
                    text: message.toLowerCase(),
                    sender: sender,
                    timestamp: Date.now()
                };
                
                // Check if the real user mentioned any fake user by name
                const mentionedFakeUser = findMentionedFakeUser(message, sender);
                if (mentionedFakeUser) {
                    // High chance for mentioned fake user to reply directly to real user
                    scheduleDirectReplyFromFakeUser(message, mentionedFakeUser);
                } else {
                    // Schedule a regular reply with normal probability
                    scheduleUserReply();
                }
            }
            // Store fake user messages for fake-to-fake replies
            else if (currentRoom && currentRoom.users.some(u => u.name === sender && !u.isCurrentUser)) {
                const messageData = {
                    text: message.toLowerCase(),
                    sender: sender,
                    timestamp: Date.now(),
                    originalMessage: message
                };
                
                recentFakeMessages.push(messageData);
                
                // Keep only last 5 fake messages
                if (recentFakeMessages.length > 5) {
                    recentFakeMessages.shift();
                }
                
                // PRIORITY: Check if this is a group question from fake user - should get multiple responses
                const isGroupQuestion = detectGroupQuestion(messageData.text);
                
                if (isGroupQuestion) {
                    // Group questions from fake users should also get multiple responses
                    setTimeout(() => {
                        scheduleGroupResponses(messageData.text, messageData.sender, messageData.originalMessage);
                    }, getRandomNumber(2000, 6000)); // 2-6 seconds delay
                } else {
                    // Check if this message mentions another fake user by name
                    const mentionedUser = findMentionedUser(message, sender);
                    if (mentionedUser) {
                        // High chance for mentioned user to reply - ONLY the mentioned user should reply
                        scheduleDirectReply(messageData, mentionedUser);
                        // Do NOT call scheduleFakeUserReply() - prevent other users from responding
                    } else {
                        // Regular fake-to-fake reply chance only when no specific user is mentioned
                        scheduleFakeUserReply();
                    }
                }
            }
        }

function addSystemMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;

    const msgDiv = document.createElement('div');
    msgDiv.className = "text-center text-sm my-2 opacity-80 text-gray-500 dark:text-[#080707]";
    msgDiv.textContent = message;

    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

        // Track recent conversations to prevent interrupting direct exchanges
        let recentDirectConversations = new Map(); // Maps real user + fake user pairs to timestamps

        function scheduleUserReply() {
            // Clear existing reply timeout
            if (chatReplyTimeout) {
                clearTimeout(chatReplyTimeout);
            }
            
            if (!lastUserMessage) return;
            
            const messageText = lastUserMessage.text.toLowerCase();
            
            // HIGHEST PRIORITY: Check for direct mentions of specific fake users FIRST
            const mentionedFakeUser = findMentionedFakeUser(lastUserMessage.text, lastUserMessage.sender);
            if (mentionedFakeUser) {
                console.log(`Direct mention detected: ${lastUserMessage.sender} mentioned ${mentionedFakeUser.name}`);
                // ONLY the mentioned user should reply - very high chance (95%)
                if (Math.random() < 0.95) {
                    const replyDelay = getRandomNumber(1500, 4000); // 1.5-4 seconds for direct mentions
                    chatReplyTimeout = setTimeout(() => {
                        const replyMessage = generateFakeToRealUserReplyMessage(lastUserMessage.text, mentionedFakeUser, lastUserMessage.sender);
                        if (replyMessage) {
                            // Add reply context
                            const replyContext = {
                                sender: lastUserMessage.sender,
                                message: lastUserMessage.text
                            };
                            addChatMessage(mentionedFakeUser.name, replyMessage, false, replyContext);
                            // Track this as a direct conversation
                            const conversationKey = `${lastUserMessage.sender}-${mentionedFakeUser.name}`;
                            recentDirectConversations.set(conversationKey, Date.now());
                        }
                        lastUserMessage = null;
                    }, replyDelay);
                }
                return; // CRITICAL: Return here to prevent other users from responding
            }
            
            // Check for "Hiiiii" type messages that should trigger group replies SECOND
            if (messageText.includes('hiiiii') || messageText.includes('hiiii') ||
                messageText.includes('heyyyy') || messageText.includes('helloooo') ||
                messageText.includes('hiii') || messageText.includes('heyyy') ||
                messageText.includes('hellooo') || messageText.includes('hiiiiii')) {
                const replyDelay = getRandomNumber(800, 2500); // Faster response to greetings
                chatReplyTimeout = setTimeout(() => {
                    scheduleGroupResponses(lastUserMessage.text, lastUserMessage.sender, lastUserMessage.text);
                    lastUserMessage = null;
                }, replyDelay);
                return;
            }
            
            // CRITICAL: Check if this is a response in an ongoing direct conversation
            const now = Date.now();
            let isPartOfDirectConversation = false;
            
            // Check if real user recently had a direct conversation with any fake user
            recentDirectConversations.forEach((timestamp, conversationKey) => {
                if (now - timestamp < 60000) { // Within last 60 seconds
                    const [sender, recipient] = conversationKey.split('-');
                    if (sender === lastUserMessage.sender || recipient === lastUserMessage.sender) {
                        isPartOfDirectConversation = true;
                    }
                } else {
                    // Clean up old conversations
                    recentDirectConversations.delete(conversationKey);
                }
            });
            
            // If this is part of a direct conversation, only allow the specific participant to respond
            if (isPartOfDirectConversation) {
                // Find the other participant in the recent conversation
                let conversationPartner = null;
                recentDirectConversations.forEach((timestamp, conversationKey) => {
                    if (now - timestamp < 60000) {
                        const [sender, recipient] = conversationKey.split('-');
                        if (sender === lastUserMessage.sender) {
                            conversationPartner = currentRoom.users.find(u => u.name === recipient);
                        } else if (recipient === lastUserMessage.sender) {
                            conversationPartner = currentRoom.users.find(u => u.name === sender);
                        }
                    }
                });
                
                if (conversationPartner) {
                    // Only the conversation partner should respond
                    const replyDelay = getRandomNumber(1500, 4000);
                    chatReplyTimeout = setTimeout(() => {
                        const replyMessage = generateFakeToRealUserReplyMessage(lastUserMessage.text, conversationPartner, lastUserMessage.sender);
                        if (replyMessage) {
                            // Add reply context
                            const replyContext = {
                                sender: lastUserMessage.sender,
                                message: lastUserMessage.text
                            };
                            addChatMessage(conversationPartner.name, replyMessage, false, replyContext);
                            // Update the conversation timestamp
                            const conversationKey = `${lastUserMessage.sender}-${conversationPartner.name}`;
                            recentDirectConversations.set(conversationKey, Date.now());
                        }
                        lastUserMessage = null;
                    }, replyDelay);
                    return;
                }
            }
            
            // Check if this is a group question SECOND - group questions should always get responses
            const isGroupQuestion = detectGroupQuestion(lastUserMessage.text);
            
            if (isGroupQuestion) {
                // Group questions always get responses (100% chance)
                const replyDelay = getRandomNumber(1000, 4000); // 1-4 seconds (faster)
                chatReplyTimeout = setTimeout(() => {
                    scheduleGroupResponses(lastUserMessage.text, lastUserMessage.sender, lastUserMessage.text);
                    lastUserMessage = null;
                }, replyDelay);
            } else {
                // MUCH MORE RESPONSIVE - increased base response rate
                let responseChance = 0.90; // 90% base chance (increased further)
                
                // High priority messages get near-guaranteed responses
                const isHighPriorityMessage = messageText.includes('stress') || 
                                      messageText.includes('worried') || 
                                      messageText.includes('hard') || 
                                      messageText.includes('difficult') || 
                                      messageText.includes('struggling') || 
                                      messageText.includes('stuck') ||
                                      messageText.includes('frustrated') ||
                                      messageText.includes('overwhelmed') ||
                                      messageText.includes('nervous') ||
                                      messageText.includes('anxious') ||
                                      messageText.includes('help') ||
                                      messageText.includes('advice') ||
                                      messageText.includes('tips') ||
                                      messageText.includes('exam') ||
                                      messageText.includes('test') ||
                                      messageText.includes('quiz') ||
                                      messageText.includes('pray for me') ||
                                      messageText.includes('please pray') ||
                                      messageText.includes('finals') ||
                                      messageText.includes('midterm') ||
                                      messageText.includes('assignment') ||
                                      messageText.includes('due') ||
                                      messageText.includes('question') ||
                                      messageText.includes('confused') ||
                                      messageText.includes('understand') ||
                                      messageText.includes('explain');
                
                if (isHighPriorityMessage) {
                    responseChance = 0.98; // 98% chance for high priority
                }
                
                // Simple greetings and social messages get excellent response rates
                const isSocialMessage = messageText.includes('hi ') || messageText.includes('hello ') || 
                                       messageText.includes('hey ') || messageText.includes('thanks') ||
                                       messageText.includes('good morning') || messageText.includes('good afternoon') ||
                                       messageText.includes('how are you') || messageText.includes('what\'s up') ||
                                       messageText.includes('motivation') || messageText.includes('energy') ||
                                       messageText.includes('math') || messageText.includes('science') ||
                                       messageText.includes('studying') || messageText.includes('working on');
                
                if (isSocialMessage) {
                    responseChance = 0.95; // 95% chance for social messages
                }
                
                if (Math.random() < responseChance) {
                    const replyDelay = isHighPriorityMessage ? 
                        getRandomNumber(800, 3000) : // Faster for high priority: 1.2-3 seconds
                        getRandomNumber(1200, 4000); // Normal: 1.5-4 seconds
                    
                    chatReplyTimeout = setTimeout(() => {
                        generateReplyToUser();
                    }, replyDelay);
                }
            }
        }

        // Function to determine if fake users should respond to a REAL USER's message
        function shouldRespondToRealUserMessage(messageText, originalMessage) {
            // MUCH MORE PERMISSIVE - Use probability instead of hard blocks
            
            // FILTER 1: Welcome messages FOR fake users - never respond to avoid loops
            if ((messageText.includes('welcome') && (messageText.includes('to the') || messageText.includes('to our'))) ||
                messageText.includes('joined the study group') || messageText.includes('just joined us')) {
                return false; // Never respond to welcome messages FOR fake users
            }
            
            // FILTER 2: Direct system/goodbye messages - never respond
            if (messageText.includes('left the study session') || messageText.includes('finished their study session') ||
                messageText.includes('good luck with your studies') || messageText.includes('thanks for studying with us')) {
                return false; // Never respond to system farewell messages
            }
            
            // Everything else is allowed - let percentage-based responses handle the rest
            return true;
        }

        // Comprehensive group question detection system
        function detectGroupQuestion(message) {
            const messageText = message.toLowerCase();
            
            // CRITICAL FILTER: Check if message mentions a specific fake user's name
            // If it does, it's NOT a group question regardless of other patterns
            if (currentRoom && currentRoom.users) {
                const fakeUsers = currentRoom.users.filter(u => !u.isCurrentUser);
                for (const user of fakeUsers) {
                    const nameLower = user.name.toLowerCase();
                    
                    // Check if the message mentions this specific user's name
                    const mentionPatterns = [
                        new RegExp(`\\b${nameLower}\\b`, 'i'),           // Name anywhere in message
                        new RegExp(`^${nameLower}[!,.]`, 'i'),           // Start with name + punctuation
                        new RegExp(`\\bhi\\s+${nameLower}\\b`, 'i'),     // "Hi [Name]"
                        new RegExp(`\\bhey\\s+${nameLower}\\b`, 'i'),    // "Hey [Name]"
                        new RegExp(`\\b${nameLower}[!,.]`, 'i'),         // "[Name]!" or "[Name],"
                        new RegExp(`@${nameLower}\\b`, 'i'),             // "@[Name]"
                        new RegExp(`\\b${nameLower}\\s`, 'i'),           // "[Name] " (name followed by space)
                        new RegExp(`\\s${nameLower}\\b`, 'i')            // " [Name]" (space followed by name)
                    ];
                    
                    // If ANY mention pattern matches, this is NOT a group question
                    if (mentionPatterns.some(pattern => pattern.test(message))) {
                        return false; // Direct mention = not a group question
                    }
                }
            }
            
            // STRICT FILTERING: Exclude messages that should NEVER be group questions
            
            // Filter 1: Welcome messages
            if (messageText.includes('welcome') || messageText.includes('good to have you') || 
                messageText.includes('great to have you') || messageText.includes('glad to have you') ||
                messageText.includes('nice to have you') || messageText.includes('welcome to') ||
                messageText.includes('welcome everyone') || messageText.includes('welcome all') ||
                messageText.includes('good to see you') || messageText.includes('nice to see you')) {
                return false;
            }
            
            // Filter 2: Pure greetings
            if ((messageText.includes('hi everyone') || messageText.includes('hello everyone') || 
                 messageText.includes('hey everyone') || messageText.includes('hi all') ||
                 messageText.includes('hello all') || messageText.includes('hey all')) &&
                messageText.length < 40 && !messageText.includes('?')) {
                return false;
            }
            
            // Filter 3: System/goodbye messages
            if (messageText.includes('left the') || messageText.includes('finished their') ||
                messageText.includes('goodbye') || messageText.includes('see you later') ||
                messageText.includes('catch you later') || messageText.includes('thanks for studying') ||
                messageText.includes('good luck with') || messageText.includes('have a great')) {
                return false;
            }
            
            // Filter 4: General compliments
            if ((messageText.includes('love') || messageText.includes('amazing') || messageText.includes('great')) &&
                (messageText.includes('room') || messageText.includes('group') || messageText.includes('app') ||
                 messageText.includes('energy') || messageText.includes('vibe') || messageText.includes('everyone'))) {
                return false;
            }
            
            // Filter 5: Pure status updates without questions
            if ((messageText.includes('i\'m') || messageText.includes('i am') || messageText.includes('just finished') ||
                messageText.includes('taking a break') || messageText.includes('be right back') ||
                messageText.includes('brb') || messageText.includes('going to')) &&
                !messageText.includes('?') && !messageText.includes('anyone')) {
                return false;
            }
            
            // PRIORITY: Study-related group questions - detect these first!
            if (messageText.includes('what') && messageText.includes('?')) {
                // Enhanced "what are y'all studying" detection with various spellings
                const studyingPatterns = [
                    'what are you all studying',
                    'what are ya\'ll studying', 
                    'what are yall studying',
                    'what are y\'all studying',
                    'what\'s everyone studying',
                    'what is everyone studying',
                    'what are you guys studying',
                    'what are you studying',
                    'what\'s everyone working on',
                    'what are ya\'ll working on',
                    'what are you all working on',
                    'what are everyone studying',
                    'what subjects are you',
                    'what subjects is everyone',
                    'what\'s everyone\'s progress',
                    'what is everyone\'s progress',
                    'what are you all working',
                    'what\'s everyone up to',
                    'what is everyone up to'
                ];
                
                const matchedStudyPattern = studyingPatterns.find(pattern => messageText.includes(pattern));
                if (matchedStudyPattern) {
                    console.log(`Group question detected by studying pattern: "${matchedStudyPattern}"`);
                    return true;
                }
                
                // General "what are y'all doing" questions
                const doingPatterns = [
                    'what are you all doing',
                    'what are ya\'ll doing', 
                    'what are yall doing',
                    'what are y\'all doing',
                    'what\'s everyone doing',
                    'what is everyone doing',
                    'what are you guys doing'
                ];
                
                const matchedDoingPattern = doingPatterns.find(pattern => messageText.includes(pattern));
                if (matchedDoingPattern) {
                    console.log(`Group question detected by doing pattern: "${matchedDoingPattern}"`);
                    return true;
                }
            }
            
            // PRIORITY: "How is everyone" questions
            if (messageText.includes('how') && messageText.includes('?')) {
                const howEveryonePatterns = [
                    'how is everyone',
                    'how\'s everyone',
                    'how are you all',
                    'how are ya\'ll',
                    'how are yall',
                    'how are y\'all',
                    'how are you guys',
                    'how is everybody',
                    'how\'s everybody',
                    'how are we all',
                    'how is everyone doing',
                    'how\'s everyone doing',
                    'how are you all doing',
                    'how are ya\'ll doing',
                    'how are y\'all doing'
                ];
                
                const matchedHowPattern = howEveryonePatterns.find(pattern => messageText.includes(pattern));
                if (matchedHowPattern) {
                    console.log(`Group question detected by how-everyone pattern: "${matchedHowPattern}"`);
                    return true;
                }
            }
            
            // PRIORITY: "Is everyone" questions  
            if (messageText.includes('is') && messageText.includes('?')) {
                const isEveryonePatterns = [
                    'is everyone ready',
                    'is everybody ready', 
                    'are you all ready',
                    'are ya\'ll ready',
                    'are yall ready',
                    'are y\'all ready',
                    'are you guys ready',
                    'is everyone here',
                    'is everybody here',
                    'are you all here',
                    'is everyone focused',
                    'is everybody focused',
                    'are you all focused',
                    'is everyone good',
                    'is everybody good',
                    'are you all good'
                ];
                
                const matchedIsPattern = isEveryonePatterns.find(pattern => messageText.includes(pattern));
                if (matchedIsPattern) {
                    console.log(`Group question detected by is-everyone pattern: "${matchedIsPattern}"`);
                    return true;
                }
            }
            
            // PRIORITY: "Anyone feel" questions - stress, exam anxiety, etc.
            if (messageText.includes('anyone') && messageText.includes('feel') && messageText.includes('?')) {
                const anyoneFeelPatterns = [
                    'anyone feel stressed',
                    'anyone else feel stressed',
                    'anyone feel nervous',
                    'anyone else feel nervous',
                    'anyone feel anxious', 
                    'anyone else feel anxious',
                    'anyone feel worried',
                    'anyone else feel worried',
                    'anyone feel overwhelmed',
                    'anyone else feel overwhelmed',
                    'anyone feel stressed about',
                    'anyone else feel stressed about',
                    'anyone feel nervous about',
                    'anyone else feel nervous about'
                ];
                
                const matchedFeelPattern = anyoneFeelPatterns.find(pattern => messageText.includes(pattern));
                if (matchedFeelPattern) {
                    console.log(`Group question detected by anyone-feel pattern: "${matchedFeelPattern}"`);
                    return true;
                }
            }
            
            // PRIORITY: "Who is/Who's" questions
            if (messageText.includes('who') && messageText.includes('?')) {
                const whoQuestions = [
                    'who\'s studying',
                    'who is studying', 
                    'who\'s working on',
                    'who is working on',
                    'who\'s doing',
                    'who is doing',
                    'who\'s ready',
                    'who is ready',
                    'who\'s here',
                    'who is here',
                    'who\'s taking',
                    'who is taking',
                    'who\'s in',
                    'who is in'
                ];
                
                const matchedWhoPattern = whoQuestions.find(pattern => messageText.includes(pattern));
                if (matchedWhoPattern) {
                    console.log(`Group question detected by who-question pattern: "${matchedWhoPattern}"`);
                    return true;
                }
            }
            
            // Core group question starters - these ALWAYS indicate group questions
            const groupQuestionStarters = [
                'who else', 'anyone else', 'who all', 'does anyone', 'is anyone', 
                'anybody else', 'anyone here', 'everyone here', 'who here',
                'how many of you', 'how many people', 'who among you',
                'raise your hand if', 'show of hands', 'who else has', 'who else have',
                'anyone else has', 'anyone else have', 'who has', 'who have'
            ];
            
            // Group invitation patterns - seeking participation
            const groupInvitationPatterns = [
                'anyone want', 'who wants', 'who want', 'anybody want',
                'anyone need', 'who needs', 'anybody need',
                'anyone down for', 'who\'s down for', 'anybody down for',
                'anyone up for', 'who\'s up for', 'anybody up for',
                'anyone feel like', 'who feels like', 'anybody feel like',
                'anyone else feel', 'who else feels', 'anybody else feel'
            ];
            
            // Preference and opinion seekers
            const preferencePatterns = [
                'anyone prefer', 'who prefers', 'anybody prefer',
                'anyone else prefer', 'who else prefers',
                'anyone think', 'who thinks', 'anybody think',
                'anyone agree', 'who agrees', 'anybody agree',
                'anyone like', 'who likes', 'anybody like',
                'anyone love', 'who loves', 'anybody love'
            ];
            
            // Status and experience sharing - STRICT: must include question word
            const statusPatterns = [
                'anyone else', 'who else is', 'anybody else',
                'anyone currently', 'who\'s currently', 'anybody currently',
                'anyone also', 'who\'s also', 'anybody also',
                'anyone still', 'who\'s still', 'anybody still'
            ];
            
            // SPECIFIC PATTERNS: Direct matches for fake user messages that should get group responses
            const specificGroupPatterns = [
                'find it easier to study with others',
                'who else is obsessed with',
                'who else is powered by coffee',
                'who else is powered by',
                'does anyone need a break',
                'anyone else find',
                'anyone else tired',
                'who prefers studying in the morning',
                'who prefers studying in the evening', 
                'anyone else prefer studying',
                'easier to study with others'
            ];
            
            // Check for specific group patterns FIRST (most precise)
            const matchedSpecific = specificGroupPatterns.find(pattern => messageText.includes(pattern));
            if (matchedSpecific) {
                console.log(`Group question detected by specific pattern: "${matchedSpecific}"`);
                return true;
            }
            
            // Check for core group question starters
            const matchedStarter = groupQuestionStarters.find(pattern => messageText.includes(pattern));
            if (matchedStarter) {
                console.log(`Group question detected by starter: "${matchedStarter}"`);
                return true;
            }
            
            // Check for group invitation patterns
            const matchedInvitation = groupInvitationPatterns.find(pattern => messageText.includes(pattern));
            if (matchedInvitation) {
                console.log(`Group question detected by invitation pattern: "${matchedInvitation}"`);
                return true;
            }
            
            // Check for preference patterns
            const matchedPreference = preferencePatterns.find(pattern => messageText.includes(pattern));
            if (matchedPreference) {
                console.log(`Group question detected by preference pattern: "${matchedPreference}"`);
                return true;
            }
            
            // Check for status patterns - STRICTER: must be actual question
            if (messageText.includes('?')) {
                const matchedStatus = statusPatterns.find(pattern => messageText.includes(pattern));
                if (matchedStatus) {
                    console.log(`Group question detected by status pattern: "${matchedStatus}"`);
                    return true;
                }
            }
            
            // ENHANCED: More comprehensive study-related group detection
            const studyGroupPatterns = [
                'lot of studies', 'lots of studies', 'a lot of study', 'lots of study',
                'tons of homework', 'lots of homework', 'a lot of homework',
                'busy with studies', 'busy with study', 'busy studying',
                'overwhelmed with', 'stressed about studies', 'behind on studies',
                'caught up with studies'
            ];
            
            // Check for study-related group patterns
            const matchedStudyPattern = studyGroupPatterns.find(pattern => messageText.includes(pattern));
            if (matchedStudyPattern) {
                // If it contains group question words, it's definitely a group question
                const groupWords = ['who', 'anyone', 'everybody', 'someone', 'people'];
                if (groupWords.some(word => messageText.includes(word))) {
                    console.log(`Group question detected by study pattern: "${matchedStudyPattern}"`);
                    return true;
                }
            }
            
            // Default: NOT a group question unless it matches specific patterns above
            return false;
        }
        
        // Function to schedule multiple group responses
        function scheduleGroupResponses(messageText, originalSender = null, originalMessage = null) {
            if (!currentRoom || !chatEnabled || !currentRoom.users) return;

            const availableFakeUsers = currentRoom.users.filter(u => u && !u.isCurrentUser && u.name);
            if (availableFakeUsers.length === 0) return;

            // CRITICAL: Check if this is actually a group question and not a direct mention
            const isRealGroupQuestion = detectGroupQuestion(messageText);
            if (!isRealGroupQuestion) {
                console.log('Not a real group question, skipping group responses');
                return;
            }

            // Determine how many people should respond (2-4 users for most group questions)
            const responseCount = Math.min(getRandomNumber(2, 4), availableFakeUsers.length);

            // Select random users to respond (no duplicates)
            const responders = [];
            const shuffledUsers = [...availableFakeUsers].sort(() => Math.random() - 0.5);

            for (let i = 0; i < responseCount; i++) {
                if (shuffledUsers[i] && shuffledUsers[i].name) {
                    responders.push(shuffledUsers[i]);
                }
            }

            // Schedule responses with varying delays to make it feel natural
            responders.forEach((user, index) => {
                if (!user || !user.name) return; // Safety check

                const baseDelay = 2000 + (index * 1500); // 2s, 3.5s, 5s, 6.5s etc.
                const randomDelay = getRandomNumber(baseDelay, baseDelay + 1000);

                setTimeout(() => {
                    if (user && user.name) { // Double-check before using
                        const response = generateGroupResponse(messageText, user);
                        if (response) {
                            // Add reply context if original sender is known
                            const replyContext = originalSender ? {
                                sender: originalSender,
                                message: originalMessage || messageText
                            } : null;
                            addChatMessage(user.name, response, false, replyContext);
                        }
                    }
                }, randomDelay);
            });
        }
        
        // Function to generate appropriate responses to group questions
        function generateGroupResponse(messageText, responder) {
            const messageTextLower = messageText.toLowerCase();
            
            // STRICT CONTEXT FILTERS - Apply same filtering as other reply functions
            
            // FILTER 1: Never respond to welcome messages
            if (messageTextLower.includes('welcome') || messageTextLower.includes('good to have you') || 
                messageTextLower.includes('great to have you') || messageTextLower.includes('glad to have you') ||
                messageTextLower.includes('nice to have you') || messageTextLower.includes('welcome to') ||
                messageTextLower.includes('welcome everyone') || messageTextLower.includes('welcome all') ||
                messageTextLower.includes('good to see you') || messageTextLower.includes('nice to see you')) {
                return null; // Never respond to welcome messages
            }
            
            // FILTER 2: Never respond to general greetings to groups
            if ((messageTextLower.includes('hi everyone') || messageTextLower.includes('hello everyone') || 
                 messageTextLower.includes('hey everyone') || messageTextLower.includes('hi all') ||
                 messageTextLower.includes('hello all') || messageTextLower.includes('hey all')) &&
                messageTextLower.length < 40 && !messageTextLower.includes('?')) {
                return null; // Don't respond to general group greetings
            }
            
            // FILTER 3: Never respond to system/goodbye messages
            if (messageTextLower.includes('left the') || messageTextLower.includes('finished their') ||
                messageTextLower.includes('goodbye') || messageTextLower.includes('see you later') ||
                messageTextLower.includes('catch you later') || messageTextLower.includes('thanks for studying') ||
                messageTextLower.includes('good luck with') || messageTextLower.includes('have a great')) {
                return null; // Never respond to farewell messages
            }
            
            // FILTER 4: Don't respond to compliments about the room/app/general things
            if ((messageTextLower.includes('love') || messageTextLower.includes('amazing') || messageTextLower.includes('great')) &&
                (messageTextLower.includes('room') || messageTextLower.includes('group') || messageTextLower.includes('app') ||
                 messageTextLower.includes('energy') || messageTextLower.includes('vibe') || messageTextLower.includes('everyone'))) {
                return null; // Don't respond to general compliments
            }
            
            // FILTER 5: Don't respond to pure status updates
            if ((messageTextLower.includes('i\'m') || messageTextLower.includes('i am') || messageTextLower.includes('just finished') ||
                messageTextLower.includes('taking a break') || messageTextLower.includes('be right back') ||
                messageTextLower.includes('brb') || messageTextLower.includes('going to')) &&
                !messageTextLower.includes('?') && !messageTextLower.includes('anyone')) {
                return null; // Don't respond to personal status updates
            }
            
            // PRIORITY 1: "What are you all doing" type questions - should get specific activity answers
            if (messageTextLower.includes('what are you') && messageTextLower.includes('doing')) {
                return getRandomItem([
                    `I'm working on ${responder.subject} right now! ðŸ“š`,
                    `Currently studying ${responder.subject} - making good progress! ðŸ’ª`,
                    `Deep into ${responder.subject} today! Really focused! ðŸŽ¯`,
                    `I'm tackling some ${responder.subject} problems! ðŸ“`,
                    `Working through ${responder.subject} material - it's challenging but good! ðŸ§ `,
                    `I'm reviewing ${responder.subject} concepts right now! ðŸ“–`,
                    `Currently focused on ${responder.subject} - loving the concentration! âš¡`,
                    `I'm studying ${responder.subject} and making great headway! ðŸš€`,
                    `Working on ${responder.subject} assignments today! ðŸ“‹`,
                    `I'm diving deep into ${responder.subject} - so interesting! ðŸ’¡`
                ]);
            }
            
            // PRIORITY 2: "What are you studying" type questions
            if ((messageTextLower.includes('what') && messageTextLower.includes('studying')) || 
                (messageTextLower.includes('what') && messageTextLower.includes('working on'))) {
                return getRandomItem([
                    `I'm studying ${responder.subject} today! ðŸ“š`,
                    `Working on ${responder.subject} - really enjoying it! ðŸ’ª`,
                    `${responder.subject} is my focus right now! ðŸŽ¯`,
                    `I'm deep into ${responder.subject} material! ðŸ“`,
                    `Currently tackling ${responder.subject} concepts! ðŸ§ `,
                    `${responder.subject} homework and review! ðŸ“–`,
                    `I'm working through ${responder.subject} problems! âš¡`,
                    `${responder.subject} is keeping me busy today! ðŸš€`
                ]);
            }
            
            // Study & Academic - HIGH PRIORITY: homework, studies, assignments
            // SPECIAL CASE: "lot of studies" / "lots of studies" gets special responses
            if (messageTextLower.includes('lot of studies') || messageTextLower.includes('lots of studies') || 
                messageTextLower.includes('a lot of study') || messageTextLower.includes('lots of study') ||
                messageTextLower.includes('tons of homework') || messageTextLower.includes('lots of homework') ||
                messageTextLower.includes('a lot of homework')) {
                return getRandomItem([
                    'Me! ðŸ“š I have SO much studying to catch up on!',
                    'Definitely me! ðŸ“ My workload is absolutely crazy right now!',
                    'Same here! ðŸŽ“ Drowning in assignments and readings!',
                    'Me for sure! ðŸ“– Feels like the studies never end!',
                    'Oh absolutely! ðŸ’» My study schedule is packed!',
                    'Yes! ðŸ“š Between all my subjects, it\'s overwhelming!',
                    'Me! ðŸ¤“ So many chapters to review, so little time!',
                    'Totally! ðŸ“‹ My to-do list of studies keeps growing!',
                    'Same! ðŸŽ¯ I feel like I\'m drowning in coursework!',
                    'Me! ðŸ“ The amount of material to cover is insane!',
                    'Definitely! ðŸ”¥ Some days I wonder how I\'ll get through it all!',
                    'Me too! ðŸ“š It\'s like every professor thinks their class is the only one!',
                    'Absolutely! ðŸ’ª But we\'ve got this! One step at a time!',
                    'Same here! ðŸ“– Sometimes I miss the days when homework was simple!'
                ]);
            }
            
            // SPECIAL CASE: "worried about studies" - ENCOURAGING responses, NOT agreement!
            if (messageTextLower.includes('worried about my studies') || messageTextLower.includes('worried about studies') ||
                messageTextLower.includes('stressed about studies') || messageTextLower.includes('so worried about') ||
                messageTextLower.includes('really worried about') || messageTextLower.includes('very worried about') ||
                messageTextLower.includes('i\'m worried about') || messageTextLower.includes('i am worried about') ||
                messageTextLower.includes('concerned about my studies') || messageTextLower.includes('anxious about studies') ||
                messageTextLower.includes('nervous about my studies') || messageTextLower.includes('afraid about studies') ||
                messageTextLower.includes('panicking about') || messageTextLower.includes('freaking out about studies')) {
                return getRandomItem([
                    'Hey, you\'ve got this! ðŸ’ª Take it one day at a time!',
                    'Don\'t worry! ðŸ¤— You\'re doing better than you think!',
                    'I believe in you! ðŸŒŸ What specific part is stressing you out?',
                    'Take a deep breath! ðŸ˜Œ You\'re already taking the right steps by studying!',
                    'You\'re not alone! ðŸ¤ We\'re all here to support each other!',
                    'Remember: progress, not perfection! ðŸ“ˆ You\'re doing great!',
                    'Hey, worry shows you care! ðŸ’ Channel that energy into action!',
                    'You\'re braver than you believe! ðŸ’Ž One step at a time!',
                    'Trust yourself! ðŸŒ± You\'ve overcome challenges before!',
                    'It\'s okay to feel worried! ðŸŒŠ That means you\'re pushing yourself!',
                    'You\'re exactly where you need to be! ðŸš€ Keep going!',
                    'I have faith in you! ðŸ™Œ What\'s one small thing you can do right now?',
                    'Breathe! ðŸ’¨ Break it down into smaller, manageable pieces!',
                    'You\'re stronger than your worries! ðŸ’ª What support do you need?',
                    'Every expert was once a beginner! ðŸŒ± You\'re growing!',
                    'Worried minds are caring minds! âœ¨ You\'re going to succeed!',
                    'Don\'t let worry steal your joy! ðŸ˜Š Celebrate small victories!',
                    'You\'re doing the hard work! ðŸ† That takes courage!',
                    'Focus on what you can control! ðŸŽ¯ You\'ve got the power!',
                    'Remember: this feeling is temporary! ðŸŒˆ You\'ll get through this!'
                ]);
            }
            
            // General study & academic terms
            if (messageTextLower.includes('homework') || messageTextLower.includes('studies') || 
                messageTextLower.includes('assignment') || messageTextLower.includes('exam') || 
                messageTextLower.includes('test') || messageTextLower.includes('quiz') || 
                messageTextLower.includes('paper') || messageTextLower.includes('essay') || 
                messageTextLower.includes('project')) {
                return getRandomItem([
                    'Me! ðŸ“š Got tons of homework to catch up on!',
                    'Absolutely! ðŸ“ My assignment list is endless!',
                    'Same here! ðŸŽ“ So much studying to do!',
                    'Me too! ðŸ“– Project deadlines are approaching fast!',
                    'Definitely! ðŸ’» Essay due tomorrow and haven\'t started!',
                    'Yes! ðŸ“š Exam prep is consuming my life right now!',
                    'Me! ðŸ¤“ Quiz tomorrow and I\'m not ready!',
                    'So much! ðŸ“‹ My to-do list keeps growing!',
                    'Absolutely! ðŸŽ¯ Finals season is brutal!',
                    'Me! ðŸ“ Research paper is driving me crazy!'
                ]);
            }
            
            // Coffee/caffeine related
            if (messageTextLower.includes('coffee') || messageTextLower.includes('caffeine')) {
                return getRandomItem([
                    'â˜• Absolutely! Coffee is my study fuel today!',
                    'Coffee gang! â˜• Can\'t study without it!',
                    'Def meee! â˜• Coffee\'s LIFE!',
                    'Me! â˜• Already on my second cup!',
                    'Coffee is life! â˜• Especially during study sessions!',
                    'â˜• Yes! Perfect study companion!',
                    'Me here! â˜• I\'m 100% addicted ðŸ˜…ðŸ¤£ðŸ¤£ðŸ¤£!',
                    'Totally! Coffee is fuel! â˜•ðŸ¤£!',
                    'Me too! â˜• Nothing beats coffee for focus!',
                    'â˜• 100%! My brain runs on caffeine!',
                    'Coffee addict here! â˜• Wouldn\'t study without it!'
                ]);
            }
            
            // Food/hunger related
            if (messageTextLower.includes('hungry') || messageTextLower.includes('food') || messageTextLower.includes('snack')) {
                return getRandomItem([
                    'ðŸ• Me! Getting pretty hungry over here!',
                    'Same! ðŸ¥ª Study sessions always make me hungry!',
                    'Absolutely! ðŸŽ Time for a snack break soon!',
                    'Me too! ðŸ¿ Brain work burns calories!',
                    'ðŸ¥¨ Yes! My stomach has been growling!',
                    'So hungry! ðŸŒ Perfect timing for a food break!',
                    'Me! ðŸ§€ Studying makes me work up an appetite!',
                    'Starving! ðŸ¥œ Anyone else need a snack run?'
                ]);
            }
            
            // Study time preferences
            if (messageTextLower.includes('morning') || messageTextLower.includes('evening')) {
                if (messageTextLower.includes('morning')) {
                    return getRandomItem([
                        'Morning person here! ðŸŒ… Peak focus time for me!',
                        'Love morning study sessions! ðŸŒž Fresh brain energy!',
                        'Morning all the way! â˜€ï¸ I\'m most productive early!',
                        'Morning gang! ðŸŒ„ Clear mind, better concentration!',
                        'ðŸŒ… Morning! My brain works best in the AM!',
                        'Early bird here! ðŸ¦ Morning study sessions are the best!'
                    ]);
                } else {
                    return getRandomItem([
                        'Evening for me! ðŸŒ™ Night owl all the way!',
                        'I prefer evening! ðŸŒ† More focused after sunset!',
                        'Evening study sessions! ðŸŒƒ Quieter and calmer!',
                        'Night owl here! ðŸ¦‰ I study better in the evening!',
                        'ðŸŒ™ Evening! Less distractions, better focus!',
                        'Evening person! ðŸŒƒ Peaceful study vibes!'
                    ]);
                }
            }
            
            // Sleep/tiredness
            if (messageTextLower.includes('sleep') || messageTextLower.includes('sleepy') || messageTextLower.includes('tired')) {
                return getRandomItem([
                    'Same! ðŸ˜´ Could definitely use a nap right now!',
                    'Me too! ðŸ¥± Staying up late studying is catching up with me!',
                    'Absolutely! ðŸ˜ª My bed is calling my name!',
                    'So sleepy! ðŸ›Œ But gotta power through this session!',
                    'Me! ðŸ˜µ Coffee isn\'t working anymore!',
                    'Same here! ðŸ’¤ Need some good sleep tonight!',
                    'Definitely! ðŸ˜´ Early bedtime for me tonight!'
                ]);
            }
            
            // Coffee response specifically to "who wants coffee?"
            if (messageTextLower.includes('who wants coffee') || messageTextLower.includes('who want coffee')) {
                return getRandomItem([
                    'Me! â˜• Desperately need caffeine right now!',
                    'I do! â˜• Can\'t function without my coffee fix!',
                    'Absolutely! â˜• My brain needs fuel!',
                    'Me please! â˜• Running on empty here!',
                    'Count me in! â˜• Coffee = productivity for me!',
                    'Yes! â˜• Already thinking about my next cup!'
                ]);
            }
            
            // Time and Schedule - EXPANDED: Adding schedule-related responses
            if (messageTextLower.includes('weekend') || messageTextLower.includes('weekday') || 
                messageTextLower.includes('today') || messageTextLower.includes('tomorrow') || 
                messageTextLower.includes('schedule') || messageTextLower.includes('time') || 
                messageTextLower.includes('busy') || messageTextLower.includes('free')) {
                return getRandomItem([
                    'Same here! ðŸ“… My schedule is packed but manageable!',
                    'I feel you! â° Time management is everything!',
                    'Me too! ðŸ“‹ Trying to balance everything today!',
                    'Absolutely! ðŸ—“ï¸ Planning my day helps so much!',
                    'Yes! â±ï¸ Making the most of my available time!',
                    'Same! ðŸ“† Weekend plans are already filling up!',
                    'Me! ðŸ• Finding time to study is always a challenge!',
                    'Definitely! â° Every free moment counts!'
                ]);
            }
            
            // Physical & Mental State - EXPANDED
            if (messageTextLower.includes('tired') || messageTextLower.includes('sleepy') || 
                messageTextLower.includes('exhausted') || messageTextLower.includes('stressed') || 
                messageTextLower.includes('nervous') || messageTextLower.includes('excited') || 
                messageTextLower.includes('motivated') || messageTextLower.includes('ready') || 
                messageTextLower.includes('sick') || messageTextLower.includes('healthy')) {
                return getRandomItem([
                    'Same! ðŸ˜´ Could definitely use more sleep!',
                    'Me too! ðŸ’ª Pushing through the fatigue!',
                    'I feel that! ðŸ¥± Study fatigue is real!',
                    'Absolutely! ðŸ˜µ But staying motivated anyway!',
                    'Same here! ðŸ˜¤ Mind over matter!',
                    'Me! ðŸ§  Mental energy running low but still going!',
                    'Yes! ðŸ’¤ Planning an early bedtime tonight!',
                    'I hear you! ðŸŒŸ Taking care of ourselves matters!'
                ]);
            }
            
            // Activities & Breaks - EXPANDED
            if (messageTextLower.includes('break') || messageTextLower.includes('walk') || 
                messageTextLower.includes('exercise') || messageTextLower.includes('music') || 
                messageTextLower.includes('game') || messageTextLower.includes('movie') || 
                messageTextLower.includes('book') || messageTextLower.includes('hobby') || 
                messageTextLower.includes('relax') || messageTextLower.includes('rest')) {
                return getRandomItem([
                    'Great idea! ðŸš¶â€â™€ï¸ Breaks are so important for focus!',
                    'Me too! ðŸŽµ Music helps me recharge!',
                    'Same! ðŸ“š Taking breaks makes studying more effective!',
                    'Absolutely! ðŸŒ¿ Fresh air does wonders!',
                    'Yes! ðŸ§˜â€â™€ï¸ Self-care is part of good studying!',
                    'Me! ðŸŽ¯ Regular breaks keep me productive!',
                    'Perfect! âš¡ Recharging for the next session!',
                    'Same here! ðŸ”„ Work-rest balance is key!'
                ]);
            }
            
            // Environment & Tools - EXPANDED  
            if (messageTextLower.includes('quiet') || messageTextLower.includes('loud') || 
                messageTextLower.includes('hot') || messageTextLower.includes('cold') || 
                messageTextLower.includes('comfortable') || messageTextLower.includes('library') || 
                messageTextLower.includes('home') || messageTextLower.includes('outside') || 
                messageTextLower.includes('inside')) {
                return getRandomItem([
                    'Same! ðŸ¤« I need the perfect environment to focus!',
                    'Me too! ðŸŒ¡ï¸ Temperature makes such a difference!',
                    'Absolutely! ðŸ  Finding the right study space is crucial!',
                    'I agree! ðŸ“š Environment affects my concentration so much!',
                    'Yes! ðŸª‘ Comfort helps me study longer!',
                    'Same here! ðŸŒ¤ï¸ Location matters for productivity!',
                    'Me! ðŸŽ§ Creating the perfect study atmosphere!',
                    'Definitely! ðŸ”† Good lighting and setup are everything!'
                ]);
            }
            
            // Technology & Study Tools - EXPANDED
            if (messageTextLower.includes('app') || messageTextLower.includes('website') || 
                messageTextLower.includes('tool') || messageTextLower.includes('software') || 
                messageTextLower.includes('online') || messageTextLower.includes('digital') || 
                messageTextLower.includes('computer') || messageTextLower.includes('phone') || 
                messageTextLower.includes('tablet')) {
                return getRandomItem([
                    'Same! ðŸ’» Technology makes studying so much easier!',
                    'Me too! ðŸ“± Digital tools are game-changers!',
                    'Absolutely! ðŸ–¥ï¸ The right apps make all the difference!',
                    'Yes! âš¡ Online resources are amazing!',
                    'I love that! ðŸ“Š Tech helps me stay organized!',
                    'Same here! ðŸ”§ Good tools boost productivity!',
                    'Me! ðŸ’¡ Digital solutions save so much time!',
                    'Definitely! ðŸš€ Modern study tools are incredible!'
                ]);
            }
            
            // Preferences & Habits - EXPANDED
            if (messageTextLower.includes('prefer') || messageTextLower.includes('like') || 
                messageTextLower.includes('love') || messageTextLower.includes('hate') || 
                messageTextLower.includes('favorite') || messageTextLower.includes('best') || 
                messageTextLower.includes('worst') || messageTextLower.includes('better') || 
                messageTextLower.includes('morning') || messageTextLower.includes('evening') || 
                messageTextLower.includes('night')) {
                return getRandomItem([
                    'Same preference! ðŸ‘ We\'re definitely on the same wavelength!',
                    'Me too! ðŸ’¯ That\'s exactly how I feel about it!',
                    'I love that approach! â­ Works perfectly for me too!',
                    'Absolutely agree! ðŸŽ¯ That\'s my go-to method!',
                    'Same here! ðŸŒŸ Great minds think alike!',
                    'Yes! ðŸ”¥ That\'s definitely the best way!',
                    'Me! ðŸ’ª That strategy works wonders!',
                    'Totally! âœ¨ I\'ve found that works best too!'
                ]);
            }
            
            // Stress/tiredness
            if (messageTextLower.includes('stressed') || messageTextLower.includes('exhausted')) {
                return getRandomItem([
                    'Me! ðŸ˜´ But pushing through - we got this!',
                    'Same here! ðŸ˜… Study grind is real!',
                    'Feeling it too! ðŸ’ª But staying strong!',
                    'Me! ðŸ˜µ Coffee helping a bit though!',
                    'Definitely! ðŸ˜° But we\'re in this together!',
                    'Same! ðŸ¥± Taking breaks helps!',
                    'Me too! ðŸ˜“ But the end goal keeps me going!',
                    'Absolutely! ðŸ˜¤ Power through mode activated!'
                ]);
            }
            
            // Music/background noise preferences
            if (messageTextLower.includes('music') || messageTextLower.includes('quiet') || messageTextLower.includes('noise')) {
                return getRandomItem([
                    'ðŸŽµ I love background music while studying!',
                    'Quiet for me! ðŸ¤« Need total silence to focus!',
                    'ðŸŽ§ Music helps me stay in the zone!',
                    'Lo-fi beats! ðŸŽ¶ Perfect study soundtrack!',
                    'Silence is golden! ðŸ¤ Music distracts me!',
                    'ðŸŽµ Classical music works best for me!',
                    'Nature sounds! ðŸŒŠ Rain or ocean waves!',
                    'Total quiet! ðŸ“š Any sound breaks my concentration!'
                ]);
            }
            
            // Ready/motivation questions
            if (messageTextLower.includes('ready') || messageTextLower.includes('excited') || messageTextLower.includes('motivated')) {
                return getRandomItem([
                    'So ready! ðŸ’ª Let\'s crush these goals!',
                    'Absolutely! ðŸ”¥ Feeling super motivated today!',
                    'Ready and excited! âš¡ Best study energy!',
                    'Born ready! ðŸŽ¯ Time to focus and succeed!',
                    'More than ready! ðŸš€ Let\'s make progress!',
                    'So pumped! ðŸ’¥ This group energy is amazing!',
                    'Ready to tackle anything! ðŸŒŸ Bring it on!',
                    'Feeling it! âœ¨ Motivation levels are high!'
                ]);
            }
            
            // Study preferences questions
            if (messageTextLower.includes('prefer studying') || messageTextLower.includes('anyone else prefer')) {
                return getRandomItem([
                    `I prefer ${Math.random() > 0.5 ? 'morning' : 'evening'} too! ${Math.random() > 0.5 ? 'ðŸŒ…' : 'ðŸŒ™'} That\'s when I\'m most focused!`,
                    `Same here! ${Math.random() > 0.5 ? 'Morning' : 'Evening'} studying just hits different! âš¡`,
                    `Totally agree! ${Math.random() > 0.5 ? 'Early bird' : 'Night owl'} gang! ðŸ¦‰`,
                    `Yes! ${Math.random() > 0.5 ? 'Morning' : 'Evening'} is definitely my peak productivity time! ðŸ’ª`
                ]);
            }
            
            // Subject preferences
            if (messageTextLower.includes('subject') || messageTextLower.includes('studying')) {
                return getRandomItem([
                    `I'm working on ${responder.subject} today! ðŸ“š`,
                    `${responder.subject} here! ðŸŽ“ How about you?`,
                    `Focusing on ${responder.subject}! ðŸ’¡ Making good progress!`,
                    `${responder.subject} is my focus! ðŸ“– Loving the challenge!`,
                    `Deep in ${responder.subject} mode! ðŸ§  So interesting!`,
                    `${responder.subject} all day! ðŸ“ Getting lots done!`
                ]);
            }
            
            // Generic group agreement responses
            return getRandomItem([
                'Me! ðŸ™‹â€â™€ï¸ Totally agree!',
                'Same here! ðŸ’¯ You\'re so right!',
                'Absolutely! ðŸ‘ I\'m with you on that!',
                'Me too! âœ‹ That\'s exactly how I feel!',
                'Yes! ðŸŽ‰ Couldn\'t agree more!',
                'Same! ðŸ˜Š Great minds think alike!',
                'Definitely me! ðŸŒŸ You nailed it!',
                'Count me in! ðŸ’ª I\'m totally there!'
            ]);
        }

        function generateReplyToUser() {
            if (!lastUserMessage || !currentRoom || !chatEnabled) return;
            
            // Check if this is a group question that multiple people should respond to
            const isGroupQuestion = detectGroupQuestion(lastUserMessage.text);
            
            if (isGroupQuestion) {
                scheduleGroupResponses(lastUserMessage.text, lastUserMessage.sender, lastUserMessage.text);
                lastUserMessage = null;
                return;
            }
            
            // Check if the real user mentioned any fake user specifically
            const mentionedFakeUser = findMentionedFakeUser(lastUserMessage.text, lastUserMessage.sender);
            
            let replyUser;
            let replyMessage;
            
            if (mentionedFakeUser) {
                // If a specific fake user was mentioned, they reply with high priority
                replyUser = mentionedFakeUser;
                replyMessage = generateFakeToRealUserReplyMessage(lastUserMessage.text, mentionedFakeUser, lastUserMessage.sender);
            } else {
                // Only one fake user should reply to general messages
                const availableFakeUsers = currentRoom.users.filter(u => !u.isCurrentUser);
                if (availableFakeUsers.length === 0) return;
                replyUser = getRandomItem(availableFakeUsers);
                replyMessage = generateContextualReply(lastUserMessage.text);
            }
            
            if (replyMessage) {
                // Add reply context
                const replyContext = {
                    sender: lastUserMessage.sender,
                    message: lastUserMessage.text
                };
                addChatMessage(replyUser.name, replyMessage, false, replyContext);
            }
            lastUserMessage = null; // Clear after replying
        }

        // New function for fake users replying to each other
        function scheduleFakeUserReply() {
            if (!chatEnabled || !currentRoom || recentFakeMessages.length === 0) return;
            
            const lastMessage = recentFakeMessages[recentFakeMessages.length - 1];
            
            // Check for stress/study difficulty messages - 100% response rate as requested
            const isStressMessage = lastMessage.text.includes('stressed') || 
                                  lastMessage.text.includes('worried') || 
                                  lastMessage.text.includes('struggling') || 
                                  lastMessage.text.includes('difficult') || 
                                  lastMessage.text.includes('hard') ||
                                  lastMessage.text.includes('frustrated') ||
                                  lastMessage.text.includes('overwhelmed') ||
                                  lastMessage.text.includes('nervous') ||
                                  lastMessage.text.includes('anxious') ||
                                  lastMessage.text.includes('stuck') ||
                                  lastMessage.text.includes('worried about my studies') ||
                                  lastMessage.text.includes('worried about studies') ||
                                  lastMessage.text.includes('stressed about studies') ||
                                  lastMessage.text.includes('concerned about') ||
                                  lastMessage.text.includes('afraid') ||
                                  lastMessage.text.includes('scared about') ||
                                  lastMessage.text.includes('panicking') ||
                                  lastMessage.text.includes('freaking out') ||
                                  lastMessage.text.includes('so worried about') ||
                                  lastMessage.text.includes('really worried about') ||
                                  lastMessage.text.includes('very worried about') ||
                                  lastMessage.text.includes('so stressed about') ||
                                  lastMessage.text.includes('really stressed about') ||
                                  lastMessage.text.includes('very stressed about');
            
            // General greetings should get some responses for warmth
            const isGeneralGreeting = lastMessage.text.includes('hi guys') ||
                                    lastMessage.text.includes('hello everyone') ||
                                    lastMessage.text.includes('hey everyone') ||
                                    lastMessage.text.includes('hi all') ||
                                    lastMessage.text.includes('hello all') ||
                                    lastMessage.text.includes('hey all') ||
                                    lastMessage.text.includes('good morning') ||
                                    lastMessage.text.includes('good afternoon') ||
                                    lastMessage.text.includes('good evening') ||
                                    lastMessage.text.includes('hi guys!!') ||
                                    lastMessage.text.includes('hello!!') ||
                                    lastMessage.text.includes('hey!!') ||
                                    lastMessage.text.includes('hi everyone!!');
            
            // Other relatable messages get normal rate
            const isRelatableMessage = lastMessage.text.includes('hungry') || 
                                     lastMessage.text.includes('snack') || 
                                     lastMessage.text.includes('food') || 
                                     lastMessage.text.includes('eat') || 
                                     lastMessage.text.includes('bathroom') || 
                                     lastMessage.text.includes('pee') || 
                                     lastMessage.text.includes('restroom') || 
                                     lastMessage.text.includes('brb') ||
                                     lastMessage.text.includes('break') ||
                                     lastMessage.text.includes('exam') ||
                                     lastMessage.text.includes('test') ||
                                     lastMessage.text.includes('finished') ||
                                     lastMessage.text.includes('completed') ||
                                     lastMessage.text.includes('studies') ||
                                     lastMessage.text.includes('agggg') ||
                                     lastMessage.text.includes('argh') ||
                                     lastMessage.text.includes('ugh') ||
                                     lastMessage.text.includes('omg') ||
                                     lastMessage.text.includes('lol') ||
                                     lastMessage.text.includes('haha') ||
                                     lastMessage.text.includes('hiii') ||
                                     lastMessage.text.includes('hiiii') ||
                                     lastMessage.text.includes('heyyyy') ||
                                     lastMessage.text.includes('helloooo');
            
            // General compliments and positive statements
            const isPositiveStatement = lastMessage.text.includes('love this') || 
                                      lastMessage.text.includes('amazing') || 
                                      lastMessage.text.includes('great job') ||
                                      lastMessage.text.includes('well done') ||
                                      lastMessage.text.includes('awesome') ||
                                      lastMessage.text.includes('fantastic') ||
                                      lastMessage.text.includes('excellent') ||
                                      lastMessage.text.includes('wonderful') ||
                                      lastMessage.text.includes('good luck') ||
                                      lastMessage.text.includes('you can do this');
            
            // INCREASED response rates for more human-like conversation
            let replyChance = 0.50; // Default 50% chance (increased from 35% for more activity)
            if (isStressMessage) {
                replyChance = 1.0; // 100% chance for stress/difficulty messages - as requested
            } else if (isRelatableMessage) {
                replyChance = 0.75; // 75% chance for relatable messages (increased)
            } else if (isGeneralGreeting) {
                replyChance = 0.85; // 85% chance for general greetings (increased significantly)
            } else if (isPositiveStatement) {
                replyChance = 0.60; // 60% chance for positive statements (increased)
            }
            
            // EXPANDED: Study-related messages should also get good response rates
            const isStudyRelated = lastMessage.text.includes('study') || 
                                 lastMessage.text.includes('work') || 
                                 lastMessage.text.includes('focus') || 
                                 lastMessage.text.includes('progress') || 
                                 lastMessage.text.includes('chapter') || 
                                 lastMessage.text.includes('homework') || 
                                 lastMessage.text.includes('assignment') || 
                                 lastMessage.text.includes('subject') || 
                                 lastMessage.text.includes('math') || 
                                 lastMessage.text.includes('science') || 
                                 lastMessage.text.includes('computer') || 
                                 lastMessage.text.includes('history') || 
                                 lastMessage.text.includes('english') || 
                                 lastMessage.text.includes('physics') || 
                                 lastMessage.text.includes('chemistry') || 
                                 lastMessage.text.includes('biology') || 
                                 lastMessage.text.includes('motivated') || 
                                 lastMessage.text.includes('productive') || 
                                 lastMessage.text.includes('learning') ||
                                 lastMessage.text.includes('practice') ||
                                 lastMessage.text.includes('review') ||
                                 lastMessage.text.includes('notes');
            
            if (isStudyRelated && !isStressMessage && !isRelatableMessage && !isGeneralGreeting && !isPositiveStatement) {
                replyChance = 0.55; // 55% chance for study-related messages (increased significantly)
            }
            
            if (Math.random() < replyChance) {
                const replyDelay = isStressMessage ? 
                    getRandomNumber(1500, 6000) : // Faster response to stress: 1.5-6 seconds (improved)
                    getRandomNumber(6000, 15000); // Normal delay for others: 6-15 seconds (improved)
                
                setTimeout(() => {
                    generateFakeToFakeReply();
                }, replyDelay);
            }
        }

        function generateFakeToFakeReply() {
            if (!currentRoom || !chatEnabled || recentFakeMessages.length === 0 || chatCooldownActive) return;

            // Global chat cooldown to prevent rapid-fire messages
            const now = Date.now();
            if (now - lastChatMessageTime < 8000) { // 8 second minimum between any messages (reduced from 15)
                return;
            }
            
            // Get the most recent fake message to potentially reply to
            const messageToReplyTo = recentFakeMessages[recentFakeMessages.length - 1];
            
            // Get available fake users (exclude the sender of the message we're replying to)
            const availableRepliers = currentRoom.users.filter(u => 
                !u.isCurrentUser && u.name !== messageToReplyTo.sender
            );
            
            if (availableRepliers.length === 0) return;
            
            const replier = getRandomItem(availableRepliers);
            const originalSender = currentRoom.users.find(u => u.name === messageToReplyTo.sender);
            
            const replyMessage = generateFakeToFakeReplyMessage(messageToReplyTo, replier, originalSender);

            if (replyMessage) {
                // Set global cooldown
                chatCooldownActive = true;
                lastChatMessageTime = now;

                // Add reply context showing what message triggered this response
                const replyContext = {
                    sender: messageToReplyTo.sender,
                    message: messageToReplyTo.originalMessage
                };
                addChatMessage(replier.name, replyMessage, false, replyContext);
                
                // Limit conversation length
                conversationLength++;
                if (conversationLength > 3) {
                    // Reset conversation after 3 exchanges
                    recentFakeMessages = [];
                    conversationLength = 0;
                }
                
                setTimeout(() => {
                    chatCooldownActive = false;
                }, 10000); // 10 second cooldown
            }
        }

        // Function to detect if the real user mentions a fake user by name
        function findMentionedFakeUser(message, sender) {
            if (!currentRoom || !currentRoom.users) return null;
            
            const messageLower = message.toLowerCase();
            // Only look at fake users (exclude current user)
            const fakeUsers = currentRoom.users.filter(u => !u.isCurrentUser);
            
            // Look for fake user names mentioned in the real user's message
            for (const user of fakeUsers) {
                const nameLower = user.name.toLowerCase();
                
                // MUCH MORE PERMISSIVE mention detection - any mention of the name
                const mentionPatterns = [
                    new RegExp(`\\b${nameLower}\\b`, 'i'),           // Name anywhere in message
                    new RegExp(`^${nameLower}[!,.]`, 'i'),           // Start with name + punctuation
                    new RegExp(`\\bhi\\s+${nameLower}\\b`, 'i'),     // "Hi [Name]"
                    new RegExp(`\\bhey\\s+${nameLower}\\b`, 'i'),    // "Hey [Name]"
                    new RegExp(`\\bthanks?\\s+${nameLower}\\b`, 'i'), // "Thanks [Name]"
                    new RegExp(`\\b${nameLower}[!,.]`, 'i'),         // "[Name]!" or "[Name],"
                    new RegExp(`@${nameLower}\\b`, 'i'),             // "@[Name]"
                    new RegExp(`\\b${nameLower}\\s`, 'i'),           // "[Name] " (name followed by space)
                    new RegExp(`\\s${nameLower}\\b`, 'i')            // " [Name]" (space followed by name)
                ];
                
                // Return if ANY mention pattern matches
                if (mentionPatterns.some(pattern => pattern.test(message))) {
                    return user;
                }
            }
            
            return null;
        }

        // Function to schedule a direct reply from a fake user when mentioned by real user
        function scheduleDirectReplyFromFakeUser(message, mentionedFakeUser) {
            if (!chatEnabled || !currentRoom || !mentionedFakeUser) return;
            
            // Very high chance (90%) for fake user to reply when mentioned by real user
            if (Math.random() < 0.9) {
                const replyDelay = getRandomNumber(1500, 5000); // 1.5-5 seconds for real user mentions
                setTimeout(() => {
                    generateFakeUserReplyToRealUser(message, mentionedFakeUser);
                }, replyDelay);
            }
        }

        // Function to generate a reply from fake user to real user
        function generateFakeUserReplyToRealUser(originalMessage, fakeUser) {
            if (!currentRoom || !chatEnabled || !fakeUser) return;

            const realUserName = userProfile.name;
            const replyMessage = generateFakeToRealUserReplyMessage(originalMessage, fakeUser, realUserName);

            if (replyMessage) {
                // Add reply context showing this is a response to the real user
                const replyContext = {
                    sender: realUserName,
                    message: originalMessage
                };
                addChatMessage(fakeUser.name, replyMessage, false, replyContext);
            }
        }

        // Track fake users who have asked questions and should respond to answers
        let fakeUsersExpectingAnswers = new Map(); // Maps fake user name to expected answer type

        // Function to generate contextual replies from fake users to real user
        function generateFakeToRealUserReplyMessage(originalMessage, fakeUser, realUserName) {
            const messageText = originalMessage.toLowerCase();
            
            // STRICT CONTEXT VALIDATION - Check if response makes sense
            if (!shouldRespondToRealUserMessage(messageText, originalMessage)) {
                return null; // Don't respond if it doesn't make contextual sense
            }
            
            // PRIORITY 1: ALWAYS handle stress/exam messages FIRST - before any other processing!
            if (messageText.includes('exam') || messageText.includes('test') || messageText.includes('quiz') ||
                messageText.includes('finals') || messageText.includes('midterm') || messageText.includes('assessment') ||
                messageText.includes('stressed') || messageText.includes('worried') || messageText.includes('nervous') ||
                messageText.includes('anxious') || messageText.includes('scared') || messageText.includes('afraid') ||
                messageText.includes('panic') || messageText.includes('freak') || messageText.includes('overwhelming') ||
                messageText.includes('hard') || messageText.includes('difficult') || messageText.includes('struggling') ||
                messageText.includes('stuck') || messageText.includes('frustrated') || messageText.includes('help') ||
                messageText.includes(':(') || messageText.includes(':((') || messageText.includes(':(((') ||
                messageText.includes('ðŸ˜°') || messageText.includes('ðŸ˜Ÿ') || messageText.includes('ðŸ˜ž') ||
                messageText.includes('very soon') && (messageText.includes('exam') || messageText.includes('test'))) {
                
                return getRandomItem([
                    `You've got this ${realUserName}! ðŸ’ª Take it one step at a time!`,
                    `Good luck ${realUserName}! Your studying will pay off! ðŸ™`,
                    `Hey ${realUserName}, exam stress is real but you're more prepared than you think! âœ¨`,
                    `${realUserName}, take a deep breath! You can get through this! ðŸŒŸ`,
                    `Sending positive vibes your way ${realUserName}! ðŸ“šâœ¨ You've prepared well!`,
                    `${realUserName}, you're going to do great! Trust your preparation! ðŸ’ª`,
                    `Hang in there ${realUserName}! Remember - you've studied hard for this! ðŸ”¥`,
                    `${realUserName}, believe in yourself! You're stronger than you think! ðŸŒˆ`,
                    `${realUserName}, exam nerves are normal! Channel that energy into focus! âš¡`,
                    `You're ready for this ${realUserName}! Show that exam what you know! ðŸŽ¯`,
                    `${realUserName}, breathe! You've got the knowledge - just trust yourself! ðŸ§ âœ¨`,
                    `${realUserName}, I believe in you! What specific part is worrying you most? ðŸ¤`,
                    `Don't worry ${realUserName}! We're all rooting for you! ðŸ“£ðŸ’ª`,
                    `${realUserName}, you're going to crush this exam! Stay confident! ðŸš€`,
                    `${realUserName}, remember - you're braver than you believe! One question at a time! ðŸ’Ž`
                ]);
            }
            
            // PRIORITY 2: Check if this fake user asked a question and is expecting an answer
            if (fakeUsersExpectingAnswers.has(fakeUser.name)) {
                const expectedType = fakeUsersExpectingAnswers.get(fakeUser.name);
                fakeUsersExpectingAnswers.delete(fakeUser.name); // Remove after responding
                
                // Generate appropriate response based on what they asked
                if (expectedType === 'subject') {
                    return getRandomItem([
                        `Nice! ${realUserName} ðŸ˜Š`,
                        `Cool! Good luck with that! ðŸ’ª`,
                        `Awesome choice! ðŸ“š`,
                        `That's great! ðŸŒŸ`,
                        `Sounds interesting! âœ¨`,
                        `Perfect! ðŸ‘`,
                        `Nice! How's it going so far? ðŸ˜Š`,
                        `Cool subject! ðŸ’¡`,
                        `That's awesome! ðŸŽ¯`,
                        `Great! Keep it up! âš¡`
                    ]);
                } else if (expectedType === 'general') {
                    return getRandomItem([
                        `Nice! ðŸ˜Š`,
                        `Cool! ðŸ‘`,
                        `Awesome! ðŸŒŸ`,
                        `That's great! âœ¨`,
                        `Perfect! ðŸ’ª`,
                        `Good to know! ðŸ˜Š`,
                        `Sounds good! ðŸŽ¯`,
                        `Awesome! âš¡`,
                        `Nice! ðŸ“š`,
                        `Cool! ðŸ”¥`
                    ]);
                }
            }
            
            // PRIORITY 2: Direct questions - always respond (100% chance)
            if (messageText.includes('?')) {
                // Subject questions
                if (messageText.includes('what') && (messageText.includes('studying') || messageText.includes('subject'))) {
                    return `Hi ${realUserName}! I'm studying ${fakeUser.subject}. Hope you're having a productive session too!`;
                }
                
                // How are you questions
                if (messageText.includes('how') && (messageText.includes('you') || messageText.includes('doing') || messageText.includes('going'))) {
                    return getRandomItem([
                        `Hey ${realUserName}! I'm doing really well, thanks for asking! This study session is going great!`,
                        `Hi ${realUserName}! I'm doing fantastic! Making good progress on my ${fakeUser.subject} goals.`,
                        `Thanks for asking ${realUserName}! I'm feeling super motivated today! Love this study group energy.`,
                        `Hey ${realUserName}! I'm doing awesome! This study group energy is amazing.`,
                        `Hi ${realUserName}! I'm doing great! Been really productive with my ${fakeUser.subject} work.`
                    ]);
                }
                
                // Location questions
                if (messageText.includes('where')) {
                    return `Hi ${realUserName}! I'm studying from ${fakeUser.location}. Nice to connect with you!`;
                }
                
                // Other questions
                return getRandomItem([
                    `Hey ${realUserName}! That's an interesting question! Let me think about that.`,
                    `Hi ${realUserName}! Good point! I'll have to consider that one.`,
                    `Thanks for asking ${realUserName}! That's definitely worth thinking about.`
                ]);
            }
            
            // PERCENTAGE-BASED RESPONSES (like real group chat members)
            
            // Welcome messages - 70% response rate (people usually acknowledge welcomes)
            if (messageText.includes('welcome') || messageText.includes('good to have you') || 
                messageText.includes('great to have you') || messageText.includes('glad to have you') ||
                messageText.includes('nice to have you') || messageText.includes('welcome to')) {
                
                if (Math.random() < 0.70) {
                    return getRandomItem([
                        'Thanks! Great to be here! ðŸ˜Š',
                        'Happy to be part of this group!',
                        'Excited to study together! ðŸ“š',
                        'Thank you! Ready to focus and learn! ðŸ’ª',
                        'Appreciate the warm welcome!',
                        'So nice! Love the positive energy here! âœ¨',
                        'Thanks! ðŸ˜Š',
                        'Thank you! ðŸ™',
                        'Appreciate it! ðŸ’ª'
                    ]);
                }
                return null;
            }
            
            // General greetings - 65% response rate (people usually say hi back)
            if ((messageText.includes('hi everyone') || messageText.includes('hello everyone') || 
                 messageText.includes('hey everyone') || messageText.includes('hi all') ||
                 messageText.includes('hello all') || messageText.includes('hey all')) &&
                messageText.length < 40) {
                
                if (Math.random() < 0.65) {
                    return getRandomItem([
                        'Hey there! ðŸ‘‹',
                        'Hello! Ready to study! ðŸ“š',
                        'Hi! Great energy today!',
                        'Hello! Let\'s do this! ðŸ’ª',
                        'Hey! Ready to focus! ðŸŽ¯',
                        'Hi! ðŸ˜Š',
                        'Hello! âœ¨',
                        'Hey! ðŸ‘‹'
                    ]);
                }
                return null;
            }
            
            // Status updates - 50% response rate (people sometimes acknowledge these)
            if ((messageText.includes('i\'m') || messageText.includes('i am') || messageText.includes('just finished') ||
                messageText.includes('taking a break') || messageText.includes('be right back')) &&
                !messageText.includes('?')) {
                
                if (Math.random() < 0.50) {
                    if (messageText.includes('finished') || messageText.includes('completed')) {
                        return getRandomItem([
                            'Nice work! ðŸŽ‰',
                            'Great job! âœ…',
                            'Awesome! ðŸ’ª',
                            'Well done! ðŸŒŸ',
                            'Nice! ðŸ˜Š',
                            'Great! ðŸ‘'
                        ]);
                    } else if (messageText.includes('break') || messageText.includes('brb')) {
                        return getRandomItem([
                            'Take care! ðŸ‘‹',
                            'See you soon! â˜•',
                            'Enjoy! âœ¨',
                            'See ya! ðŸ˜Š',
                            'BRB! ðŸ‘‹'
                        ]);
                    } else {
                        return getRandomItem([
                            'You got this! ðŸ’ª',
                            'Good luck! ðŸ€',
                            'Nice! ðŸŽ¯',
                            'Cool! âš¡',
                            'Awesome! ðŸ˜Š'
                        ]);
                    }
                }
                return null;
            }
            
            // Compliments - 60% response rate (people like to agree with positive comments)
            if ((messageText.includes('love') || messageText.includes('amazing') || messageText.includes('great')) &&
                (messageText.includes('room') || messageText.includes('group') || messageText.includes('app') ||
                 messageText.includes('energy') || messageText.includes('vibe'))) {
                
                if (Math.random() < 0.60) {
                    return getRandomItem([
                        'Totally agree! ðŸ’¯',
                        'So true! âœ¨',
                        'Absolutely! ðŸ˜Š',
                        'Yes! ðŸ’•',
                        'Same! ðŸŒŸ',
                        'Agreed! ðŸ‘',
                        'For sure! ðŸ”¥'
                    ]);
                }
                return null;
            }
            
            // Farewell messages - 55% response rate (polite to say goodbye back)
            if (messageText.includes('goodbye') || messageText.includes('see you later') ||
                messageText.includes('thanks for studying') || messageText.includes('good luck')) {
                
                if (Math.random() < 0.55) {
                    return getRandomItem([
                        'Take care! ðŸ‘‹',
                        'Good luck! ðŸ€',
                        'See you! âœ¨',
                        'Bye! ðŸ˜Š',
                        'Thanks! ðŸ“š',
                        'Later! ðŸ’ª'
                    ]);
                }
                return null;
            }
            
            // PRIORITY 2: Handle greetings with specific readiness questions
            if ((messageText.includes('hi') || messageText.includes('hello') || messageText.includes('hey')) &&
                (messageText.includes('ready') || messageText.includes('tackle') || messageText.includes('study') || 
                 messageText.includes('focus') || messageText.includes('let\'s'))) {
                
                return getRandomItem([
                    `Hey ${realUserName}! Absolutely! I'm totally ready to dive into some serious studying! ðŸŽ¯`,
                    `Hi ${realUserName}! Yes! I'm pumped and ready to focus on ${fakeUser.subject} today! ðŸ’ª`,
                    `Hello ${realUserName}! Definitely ready! Let's make this a super productive session! ðŸ“š`,
                    `Hey there ${realUserName}! 100% ready! I love studying with motivated people like you! âš¡`,
                    `Hi ${realUserName}! So ready! Perfect timing - I was just getting into my study flow! ðŸ”¥`,
                    `Hey ${realUserName}! Absolutely ready to tackle some learning! Let's do this! ðŸ˜Š`
                ]);
            }
            
            // PRIORITY 3: Pure greetings (without readiness questions)
            if (messageText.includes('hi ') || messageText.includes('hello ') || messageText.includes('hey ') || 
                messageText.includes(' hi') || messageText.includes(' hello') || messageText.includes(' hey') ||
                messageText.startsWith('hi') || messageText.startsWith('hello') || messageText.startsWith('hey')) {
                
                return getRandomItem([
                    `Hey ${realUserName}! Great to meet you! Hope you have an amazing study session! ðŸ˜Š`,
                    `Hi there ${realUserName}! Thanks for saying hi! So nice to connect with you! ðŸ‘‹`,
                    `Hello ${realUserName}! Welcome! I'm ${fakeUser.name}, excited to study alongside you! ðŸŒŸ`,
                    `Hey ${realUserName}! Good to see a friendly face! Ready to crush some goals together? ðŸ’ª`,
                    `Hi ${realUserName}! Thanks for the greeting! Love the positive energy you're bringing! âœ¨`,
                    `Hey there ${realUserName}! Nice to meet you! This study group has such great vibes! ðŸŽ‰`
                ]);
            }
            
            // Thank you responses
            if (messageText.includes('thank') || messageText.includes('thanks')) {
                return getRandomItem([
                    `You're so welcome ${realUserName}! Happy to help! ðŸ˜Š`,
                    `No problem at all ${realUserName}! We're all here to support each other!`,
                    `Anytime ${realUserName}! That's what study buddies are for! ðŸ’ª`,
                    `Glad I could help ${realUserName}! Feel free to ask me anything else!`
                ]);
            }
            
            // Compliments/encouragement
            if (messageText.includes('great') || messageText.includes('good job') || messageText.includes('awesome') || 
                messageText.includes('well done') || messageText.includes('amazing') || messageText.includes('nice')) {
                return getRandomItem([
                    `Aw, thanks ${realUserName}! That really means a lot! You're doing amazing too! ðŸŒŸ`,
                    `Thank you so much ${realUserName}! Your encouragement is keeping me motivated! ðŸ’ª`,
                    `I really appreciate that ${realUserName}! Love this supportive study community!`,
                    `You're too kind ${realUserName}! Thanks for the positive vibes! âœ¨`
                ]);
            }
            
            // Help requests
            if (messageText.includes('help') || messageText.includes('advice') || messageText.includes('tip')) {
                return getRandomItem([
                    `I'd be happy to help ${realUserName}! What specific topic are you working on?`,
                    `Absolutely ${realUserName}! What kind of help do you need? I might have some ideas!`,
                    `Of course ${realUserName}! I love helping others - what's challenging you?`,
                    `Sure thing ${realUserName}! Let's figure this out together! What's the problem? ðŸ¤`
                ]);
            }
            
            // Study context mentions
            if (messageText.includes('study') || messageText.includes('focus') || messageText.includes('work')) {
                return getRandomItem([
                    `Hey ${realUserName}! Yes, I'm really in the zone with ${fakeUser.subject} right now!`,
                    `Hi ${realUserName}! This study session has been so productive!`,
                    `Hey there ${realUserName}! I love how focused everyone is in this room! Great energy!`,
                    `Hi ${realUserName}! The group study vibe is really keeping me motivated!`
                ]);
            }
            
            // Progress sharing
            if (messageText.includes('finished') || messageText.includes('completed') || messageText.includes('done')) {
                return getRandomItem([
                    `That's awesome ${realUserName}! ðŸŽ‰ How does it feel to get that done?`,
                    `Congratulations ${realUserName}! I love hearing about progress like that! âœ¨`,
                    `Way to go ${realUserName}! You're really crushing your goals today! ðŸ’ª`,
                    `Amazing work ${realUserName}! Your productivity is inspiring! ðŸŒŸ`
                ]);
            }
            
            // Difficulty/stress
            if (messageText.includes('hard') || messageText.includes('difficult') || messageText.includes('stuck') ||
                messageText.includes('stress') || messageText.includes('struggling')) {
                return getRandomItem([
                    `Hey ${realUserName}, you've got this! What part is giving you trouble? Maybe I can help!`,
                    `I totally get that ${realUserName}! Sometimes stepping away for 5 minutes helps clear your mind ðŸ’ª`,
                    `Hang in there ${realUserName}! We're all here to support each other! ðŸ¤`,
                    `${realUserName}, remember that challenges mean you're learning! You're doing better than you think!`
                ]);
            }
            
            // Final fallback - only for truly general mentions
            return getRandomItem([
                `Hey ${realUserName}! Thanks for mentioning me! Great to connect with you!`,
                `Hi ${realUserName}! ðŸ˜„`,
                `ðŸ˜„`,
                `ðŸ˜ƒ`,
                `ðŸ˜†`,
                `Hi ${realUserName}! Always happy to chat with fellow students!`,
                `Hey there ${realUserName}! I'm so glad you reached out!`,
                `${realUserName}! Happy to chat with you!`
            ]);
        }

        // Function to detect if a message mentions another fake user by name
        function findMentionedUser(message, sender) {
            if (!currentRoom || !currentRoom.users) return null;
            
            const messageLower = message.toLowerCase();
            const availableUsers = currentRoom.users.filter(u => !u.isCurrentUser && u.name !== sender);
            
            // Look for names mentioned in the message - be VERY specific to prevent wrong responses
            for (const user of availableUsers) {
                const nameLower = user.name.toLowerCase();
                
                // STRICT name detection patterns - only clear, direct mentions
                const specificMentionPatterns = [
                    new RegExp(`\\bhi\\s+${nameLower}\\b`, 'i'),     // "Hi [Name]"
                    new RegExp(`\\bhey\\s+${nameLower}\\b`, 'i'),    // "Hey [Name]"
                    new RegExp(`\\bhello\\s+${nameLower}\\b`, 'i'),  // "Hello [Name]"
                    new RegExp(`^${nameLower}[!,.]`, 'i'),           // Start with name + punctuation
                    new RegExp(`\\bthanks?\\s+${nameLower}\\b`, 'i'), // "Thanks [Name]"
                    new RegExp(`@${nameLower}\\b`, 'i'),             // "@[Name]"
                    new RegExp(`\\b${nameLower}\\?`, 'i'),           // "[Name]?" (direct question)
                    new RegExp(`\\b${nameLower}[!]\\s*$`, 'i')       // "[Name]!" at end
                ];
                
                // CRITICAL: Only return if there's a clear, unambiguous mention
                // Exclude general words that might accidentally match names
                const hasSpecificMention = specificMentionPatterns.some(pattern => pattern.test(message));
                
                if (hasSpecificMention) {
                    console.log(`Direct mention detected: ${sender} mentioned ${user.name} in: "${message}"`);
                    return user;
                }
            }
            
            return null;
        }

        // Function to schedule a direct reply from a mentioned user
        function scheduleDirectReply(messageData, mentionedUser) {
            if (!chatEnabled || !currentRoom || !mentionedUser) return;
            
            // High chance (85%) for mentioned user to reply
            if (Math.random() < 0.85) {
                const replyDelay = getRandomNumber(2000, 7000); // 2-7 seconds for direct mentions
                setTimeout(() => {
                    generateDirectReply(messageData, mentionedUser);
                }, replyDelay);
            }
        }

        // Function to generate a direct reply from a mentioned user
        function generateDirectReply(originalMessage, mentionedUser) {
            if (!currentRoom || !chatEnabled) return;
            
            const originalSender = currentRoom.users.find(u => u.name === originalMessage.sender);
            if (!originalSender) return;
            
            const replyMessage = generateDirectReplyMessage(originalMessage, mentionedUser, originalSender);
            
            if (replyMessage) {
                addChatMessage(mentionedUser.name, replyMessage);
            }
        }

        // Function to generate contextual direct replies
        function generateDirectReplyMessage(originalMessage, replier, originalSender) {
            const messageText = originalMessage.text;
            const originalMessageFull = originalMessage.originalMessage;
            
            // STRICT CONTEXT FILTERS - Prevent nonsensical responses
            
            // FILTER 1: Never respond to welcome messages
            if (messageText.includes('welcome') || messageText.includes('good to have you') || 
                messageText.includes('great to have you') || messageText.includes('glad to have you') ||
                messageText.includes('nice to have you') || messageText.includes('welcome to') ||
                messageText.includes('joined the') || messageText.includes('new user') ||
                messageText.includes('new member') || messageText.includes('welcome!')) {
                return null; // Never respond to welcome messages
            }
            
            // FILTER 2: Never respond to system/goodbye messages
            if (messageText.includes('left the') || messageText.includes('finished their') ||
                messageText.includes('goodbye') || messageText.includes('see you later') ||
                messageText.includes('catch you later') || messageText.includes('thanks for studying') ||
                messageText.includes('good luck with') || messageText.includes('have a great')) {
                return null; // Never respond to farewell messages
            }
            
            // FILTER 3: Never respond to pure greetings from fake users to other fake users
            if ((messageText.includes('hi') || messageText.includes('hello') || messageText.includes('hey')) &&
                messageText.length < 30 && !messageText.includes('?') && 
                !messageText.includes('how') && !messageText.includes('what')) {
                return null; // Don't respond to simple greetings between fake users
            }
            
            // FILTER 4: Never respond to statements that aren't directed at anyone
            if (messageText.includes('i\'m') || messageText.includes('i am') || messageText.includes('just finished') ||
                messageText.includes('taking a break') || messageText.includes('be right back') ||
                messageText.includes('brb') || messageText.includes('going to')) {
                return null; // Don't respond to personal status updates
            }
            
            // FILTER 5: Don't respond to compliments about the room/app/general things
            if ((messageText.includes('love') || messageText.includes('amazing') || messageText.includes('great')) &&
                (messageText.includes('room') || messageText.includes('group') || messageText.includes('app') ||
                 messageText.includes('energy') || messageText.includes('vibe'))) {
                return null; // Don't respond to general compliments
            }
            
            // Create conversation key for loop detection
            const conversationKey = `${originalSender.name}-${replier.name}`;
            if (!conversationContext[conversationKey]) {
                conversationContext[conversationKey] = {
                    topicsDiscussed: new Set(),
                    lastInteraction: 0,
                    questionCount: 0
                };
            }
            
            const context = conversationContext[conversationKey];
            const now = Date.now();
            
            // ONLY respond to VERY SPECIFIC patterns that make conversational sense
            
            // 1. Direct questions TO this specific user
            if (messageText.includes('?') && 
                (messageText.includes(replier.name.toLowerCase()) || messageText.includes('you'))) {
                
                if (messageText.includes('what') && (messageText.includes('studying') || messageText.includes('subject'))) {
                    context.topicsDiscussed.add('subject');
                    context.lastInteraction = now;
                    return `Hi ${originalSender.name}! I'm studying ${replier.subject}. Hope you're having a productive session too!`;
                }
                
                if (messageText.includes('how') && (messageText.includes('you') || messageText.includes('doing') || messageText.includes('going'))) {
                    context.topicsDiscussed.add('wellbeing');
                    context.lastInteraction = now;
                    return getRandomItem([
                        `Hey ${originalSender.name}! Things are going well, thanks for asking! Making good progress.`,
                        `Hi ${originalSender.name}! I'm doing great! This study session has been productive.`,
                        `Thanks for asking ${originalSender.name}! I'm feeling really focused today.`
                    ]);
                }
                
                if (messageText.includes('where') && messageText.includes('you')) {
                    context.topicsDiscussed.add('location');
                    context.lastInteraction = now;
                    return `Hi ${originalSender.name}! I'm from ${replier.location}. Nice to connect!`;
                }
                
                // Only respond to clear, direct questions
                return null;
            }
            
            // 2. Direct thanks TO this specific user
            if ((messageText.includes('thank') || messageText.includes('thanks')) && 
                messageText.includes(replier.name.toLowerCase())) {
                context.lastInteraction = now;
                return getRandomItem([
                    `No problem ${originalSender.name}! Happy to help! ðŸ˜Š`,
                    `You're welcome ${originalSender.name}! Anytime!`,
                    `Glad I could help ${originalSender.name}!`
                ]);
            }
            
            // 3. Direct compliments TO this specific user
            if ((messageText.includes('great job') || messageText.includes('well done') || messageText.includes('awesome')) && 
                messageText.includes(replier.name.toLowerCase())) {
                context.lastInteraction = now;
                return getRandomItem([
                    `Thanks ${originalSender.name}! That means a lot!`,
                    `Thank you ${originalSender.name}! You're doing great too!`,
                    `I appreciate that ${originalSender.name}!`
                ]);
            }
            
            // 4. Direct requests for help FROM this specific user
            if ((messageText.includes('help') || messageText.includes('advice')) && 
                (messageText.includes('can you') || messageText.includes('could you') || messageText.includes(replier.name.toLowerCase()))) {
                context.lastInteraction = now;
                return getRandomItem([
                    `I'd be happy to help ${originalSender.name}! What do you need?`,
                    `Sure thing ${originalSender.name}! How can I assist?`,
                    `Of course ${originalSender.name}! What's the problem?`
                ]);
            }
            
            // If none of the specific patterns match, don't respond
            // This prevents the nonsensical "Good point!" responses to irrelevant messages
            return null;
        }

        // Enhanced conversation tracking to prevent ALL loops
        let conversationContext = {};

        function generateFakeToFakeReplyMessage(originalMessage, replier, originalSender) {
            if (!originalMessage || !replier || !originalSender) return null;

            const messageText = originalMessage.text;
            const originalMessageFull = originalMessage.originalMessage;

            // Simplified approach: Only block system messages and welcome messages for new users
            // Let fake users respond naturally to most other messages

            // Block: System notifications (joins, leaves, etc)
            if (messageText.includes('joined the study group') || messageText.includes('just joined us') ||
                messageText.includes('left the study session') || messageText.includes('finished their study session')) {
                return null;
            }

            // Block: Welcome messages FOR new users (to avoid welcome loops)
            if ((messageText.includes('welcome') && (messageText.includes('to the') || messageText.includes('to our'))) ||
                messageText.includes('welcome to the group') || messageText.includes('great to have you here')) {
                return null;
            }
            
            // Create conversation key for tracking
            const conversationKey = `${originalSender.name}-${replier.name}`;
            
            // Initialize conversation context if doesn't exist
            if (!conversationContext[conversationKey]) {
                conversationContext[conversationKey] = {
                    topicsDiscussed: new Set(),
                    lastInteraction: 0
                };
            }
            
            const context = conversationContext[conversationKey];
            const now = Date.now();
            
            // EXPANDED: Respond to many more types of messages
            
            // 1. FOOD & DRINK RELATED - High relevance, people naturally respond
            // Only respond to EXPLICIT food mentions to avoid nonsensical "too" responses
            const hasExplicitFoodMention = (
                messageText.includes('hungry') || messageText.includes('snack') ||
                messageText.includes('starving') || messageText.includes('eat') ||
                messageText.includes('lunch') || messageText.includes('dinner') ||
                messageText.includes('breakfast') || messageText.includes('food') ||
                (messageText.includes('anyone') && messageText.includes('hungry'))
            );

            const hasCoffeeMention = messageText.includes('coffee') || messageText.includes('who wants coffee');
            const hasDrinkMention = messageText.includes('tea') || messageText.includes('drink') || messageText.includes('thirsty');

            if (hasExplicitFoodMention || hasCoffeeMention || hasDrinkMention) {
                context.topicsDiscussed.add('food');
                context.lastInteraction = now;

                // Special responses for coffee-related messages
                if (hasCoffeeMention) {
                    return getRandomItem([
                        `Me! â˜• Desperately need caffeine right now!`,
                        `I do! â˜• Can't function without my coffee fix!`,
                        `Absolutely! â˜• My brain needs fuel!`,
                        `Me please! â˜• Running on empty here!`,
                        `Count me in! â˜• Coffee = productivity for me!`,
                        `Yes! â˜• Already thinking about my next cup!`,
                        `Coffee gang! â˜• Can't study without it!`,
                        `â˜• Absolutely! Coffee is my study fuel today!`,
                        `Me! â˜• Already on my second cup!`,
                        `â˜• Yes! Perfect study companion!`
                    ]);
                }

                // Only use "too" responses for VERY explicit food/hunger mentions
                if (hasExplicitFoodMention) {
                    return getRandomItem([
                        `Same here! I'm getting pretty hungry too ðŸ˜…`,
                        `Perfect timing for a snack break!`,
                        `I could definitely go for some food right now too! ðŸ•`,
                        `Hunger is real! Time for a quick food break ðŸ¥ª`,
                        `I'm starving too! This studying is making me work up an appetite ðŸ˜‚`,
                        `Food break sounds amazing! ðŸ¿`,
                        `Same! My stomach has been growling for the last 10 minutes ðŸ˜†`,
                        `You're not alone! Brain work definitely burns calories ðŸ§ âš¡`
                    ]);
                }

                // For drink mentions, use more general responses
                return getRandomItem([
                    `Good idea! Staying hydrated is important!`,
                    `I should grab a drink too!`,
                    `Perfect time for a drink break! ðŸ’§`
                ]);
            }
            
            // 2. BATHROOM BREAKS & TAKING BREAKS
            if (messageText.includes('bathroom') || messageText.includes('pee') || messageText.includes('restroom') ||
                messageText.includes('brb') || messageText.includes('quick break') || messageText.includes('be right back') ||
                messageText.includes('taking a break') || messageText.includes('break time')) {
                context.lastInteraction = now;
                return getRandomItem([
                    `Go for it! We'll keep the study energy going! ðŸ’ª`,
                    `Take your time! Perfect excuse for everyone to stretch ðŸ¤¸â€â™€ï¸`,
                    `Good call! I should probably take a quick break too!`,
                    `No worries! See you back in a few! ðŸ‘‹`,
                    `BRB! That reminds me I need to get up and move around too!`,
                    `Smart to take breaks! Your brain will thank you! ðŸ§ âœ¨`,
                    `Totally understand! Quick breaks keep us productive! âš¡`,
                    `See you in a bit! Taking care of yourself is part of good studying! ðŸ˜Š`
                ]);
            }
            
            // 3. COMPLETION CELEBRATIONS
            if (messageText.includes('finished') || messageText.includes('completed') || messageText.includes('done') ||
                messageText.includes('accomplished') || messageText.includes('achieved')) {
                context.lastInteraction = now;
                return getRandomItem([
                    `Awesome work! ðŸŽ‰ That's such a great feeling!`,
                    `Congratulations! Well done! âœ¨`,
                    `Way to go! You're really crushing your goals today! ðŸ’ª`,
                    `That's fantastic! Great progress!`,
                    `Excellent! Your hard work is paying off! ðŸŒŸ`,
                    `Amazing! Keep up the momentum! ðŸš€`,
                    `Nice job! How satisfying is that? ðŸ˜Š`,
                    `Well done! You should be proud! ðŸ’¯`
                ]);
            }
            
            // 4. STRESS/DIFFICULTY/WORRY - Always respond with support
            if (messageText.includes('stress') || messageText.includes('worried') || messageText.includes('hard') || 
                messageText.includes('difficult') || messageText.includes('struggling') || messageText.includes('stuck') ||
                messageText.includes('frustrated') || messageText.includes('overwhelmed') || messageText.includes('confused') ||
                messageText.includes('nervous') || messageText.includes('anxious')) {
                context.lastInteraction = now;
                return getRandomItem([
                    `You've got this! Stay strong! ðŸ’ª`,
                    `I totally understand. Sometimes taking a 5-min break helps clear your mind ðŸ’ª`,
                    `Hang in there! We're all here to support each other! ðŸ¤`,
                    `Remember that struggling means you're learning! You're stronger than you think!`,
                    `Take a deep breath. You can get through this! ðŸŒŸ`,
                    `I feel that too sometimes! We can push through together! ðŸ’ª`,
                    `It's okay to feel challenged - that means you're growing! ðŸŒ±`,
                    `Don't give up! Small steps still count as progress! âœ¨`
                ]);
            }
            
            // 5. EXAM/TEST anxiety
            if (messageText.includes('exam') || messageText.includes('test') || messageText.includes('quiz') ||
                messageText.includes('finals') || messageText.includes('midterm') || messageText.includes('assessment')) {
                context.lastInteraction = now;
                return getRandomItem([
                    `Good luck! You've been studying hard - you're going to do great! ðŸ™`,
                    `Sending positive vibes your way! ðŸ“šâœ¨`,
                    `You've got this! Just breathe and trust your preparation!`,
                    `Rooting for you! Remember to get good sleep before the exam!`,
                    `You're more prepared than you think! Trust yourself! ðŸŒŸ`,
                    `Exam stress is normal! You've prepared well! ðŸ’ª`,
                    `I believe in you! Show that test what you know! ðŸŽ¯`
                ]);
            }
            
            // 6. GREETINGS - More permissive, respond to most greetings
            if ((messageText.includes('hi') || messageText.includes('hello') || messageText.includes('hey') ||
                messageText.includes('hiii') || messageText.includes('heyyyy') || messageText.includes('helloooo')) && 
                !context.topicsDiscussed.has('greeting')) {
                
                context.topicsDiscussed.add('greeting');
                context.lastInteraction = now;
                return getRandomItem([
                    `Hey! Great to see you here! Hope you have a productive session! ðŸ˜Š`,
                    `Hi! Welcome! Love the study energy today!`,
                    `Hello! Ready to tackle some serious studying! ðŸ“š`,
                    `Hey there! Nice to have you in the group! ðŸ’ª`,
                    `Hi! Good to see another motivated student! ðŸŽ¯`,
                    `Hey! Perfect timing to join our study session! âš¡`,
                    `Hello! So glad you're here! Let's crush some goals! ðŸš€`
                ]);
            }
            
            // 7. STUDY-RELATED MENTIONS - High relevance
            if (messageText.includes('study') || messageText.includes('studying') || messageText.includes('homework') ||
                messageText.includes('assignment') || messageText.includes('chapter') || messageText.includes('notes') ||
                messageText.includes('reading') || messageText.includes('review') || messageText.includes('practice')) {
                context.lastInteraction = now;
                return getRandomItem([
                    `Same here! This study session is really helping me focus! ðŸ’ª`,
                    `I know right? Studying together makes such a difference! ðŸ“š`,
                    `Totally! I'm making great progress on my work too! âš¡`,
                    `Love the study energy in this room! So motivating! ðŸ”¥`,
                    `Same! The accountability here is amazing! ðŸŽ¯`,
                    `Study mode activated! Let's keep each other going! ðŸš€`
                ]);
            }
            
            // 8. MOTIVATION & ENERGY
            if (messageText.includes('motivated') || messageText.includes('focused') || messageText.includes('energy') ||
                messageText.includes('pumped') || messageText.includes('ready') || messageText.includes('excited') ||
                messageText.includes('determined') || messageText.includes('productive')) {
                context.lastInteraction = now;
                return getRandomItem([
                    `I love that energy! Let's channel it into some serious studying! ðŸ’ª`,
                    `Yes! That motivation is contagious! ðŸ”¥`,
                    `Same here! Feeling super productive today! âš¡`,
                    `That's the spirit! We're all going to crush our goals! ðŸŽ¯`,
                    `Absolutely! This group energy is amazing! ðŸš€`,
                    `So motivated too! Let's make today count! âœ¨`
                ]);
            }
            
            // 9. HOW ARE YOU QUESTIONS - But no counter-questions
            if (messageText.includes('?') && messageText.includes('how') && 
                (messageText.includes('you') || messageText.includes('doing') || messageText.includes('going')) &&
                !context.topicsDiscussed.has('wellbeing')) {
                
                context.topicsDiscussed.add('wellbeing');
                context.lastInteraction = now;
                return getRandomItem([
                    `I'm doing really well, thanks for asking! Making great progress.`,
                    `Going fantastic! This study session has been super productive.`,
                    `I'm doing awesome! Really focused today.`,
                    `Really good! I love the energy in this study group.`,
                    `Doing great! Been making solid progress on my ${replier.subject} work.`,
                    `I'm doing well! Feeling really motivated today! ðŸ’ª`,
                    `Great! This group is keeping me so focused! ðŸ“š`
                ]);
            }
            
            // 10. GENERAL POSITIVE STATEMENTS - More social engagement
            if (messageText.includes('love') || messageText.includes('amazing') || messageText.includes('great') ||
                messageText.includes('awesome') || messageText.includes('fantastic') || messageText.includes('wonderful')) {
                context.lastInteraction = now;
                return getRandomItem([
                    `I totally agree! ðŸ’¯`,
                    `Same here! It's so great! âœ¨`,
                    `Absolutely! Couldn't agree more! ðŸ˜Š`,
                    `Yes! That's exactly how I feel! ðŸŒŸ`,
                    `So true! Love that perspective! ðŸ’ª`,
                    `Exactly! That's what makes this so special! ðŸŽ¯`
                ]);
            }
            
            // Clean up old conversation contexts (older than 10 minutes)
            if (now - context.lastInteraction > 600000) {
                context.topicsDiscussed.clear();
            }
            
            // More generous fallback - allow some general engagement
            if (Math.random() < 0.1) { // 10% chance for general supportive responses
                return getRandomItem([
                    `Totally! ðŸ˜Š`,
                    `I hear you! ðŸ’ª`,
                    `Same! âœ¨`,
                    `Exactly! ðŸŽ¯`,
                    `For sure! ðŸŒŸ`,
                    `Absolutely! ðŸ’¯`
                ]);
            }
            
            return null;
        }

        function generateContextualReply(userMessage) {
            const messageText = userMessage.toLowerCase();
            
            // PRIORITY 1: Handle stress/worry messages FIRST - before any filters!
            if (messageText.includes('worried about my studies') || messageText.includes('worried about studies') ||
                messageText.includes('stressed about studies') || messageText.includes('so worried about') ||
                messageText.includes('really worried about') || messageText.includes('very worried about') ||
                messageText.includes('i\'m worried about') || messageText.includes('i am worried about') ||
                messageText.includes('concerned about my studies') || messageText.includes('anxious about studies') ||
                messageText.includes('nervous about my studies') || messageText.includes('afraid about studies') ||
                messageText.includes('panicking about') || messageText.includes('freaking out about studies') ||
                messageText.includes('worried') || messageText.includes('stressed') || messageText.includes('struggling') || 
                messageText.includes('hard') || messageText.includes('difficult') || messageText.includes('stuck') ||
                messageText.includes('frustrated') || messageText.includes('overwhelmed') || 
                messageText.includes('nervous') || messageText.includes('anxious') ||
                messageText.includes('help') || messageText.includes('advice')) {
                
                return getRandomItem([
                    'Hey, you\'ve got this! ðŸ’ª Take it one day at a time!',
                    'Don\'t worry! ðŸ¤— You\'re doing better than you think!',
                    'I believe in you! ðŸŒŸ What specific part is stressing you out?',
                    'Take a deep breath! ðŸ˜Œ You\'re already taking the right steps by studying!',
                    'You\'re not alone! ðŸ¤ We\'re all here to support each other!',
                    'Remember: progress, not perfection! ðŸ“ˆ You\'re doing great!',
                    'Hey, worry shows you care! ðŸ’ Channel that energy into action!',
                    'You\'re braver than you believe! ðŸ’Ž One step at a time!',
                    'Trust yourself! ðŸŒ± You\'ve overcome challenges before!',
                    'It\'s okay to feel worried! ðŸŒŠ That means you\'re pushing yourself!',
                    'You\'re exactly where you need to be! ðŸš€ Keep going!',
                    'I have faith in you! ðŸ™Œ What\'s one small thing you can do right now?',
                    'Breathe! ðŸ’¨ Break it down into smaller, manageable pieces!',
                    'You\'re stronger than your worries! ðŸ’ª What support do you need?',
                    'Every expert was once a beginner! ðŸŒ± You\'re growing!',
                    'Worried minds are caring minds! âœ¨ You\'re going to succeed!',
                    'Don\'t let worry steal your joy! ðŸ˜Š Celebrate small victories!',
                    'You\'re doing the hard work! ðŸ† That takes courage!',
                    'Focus on what you can control! ðŸŽ¯ You\'ve got the power!',
                    'Remember: this feeling is temporary! ðŸŒˆ You\'ll get through this!',
                    'I totally understand. Sometimes taking a 5-min break helps clear your mind ðŸ’ª',
                    'Hang in there! We\'re all here to support each other! ðŸ¤',
                    'Remember that struggling means you\'re learning! You\'re stronger than you think!',
                    'Take a deep breath. You can get through this! ðŸŒŸ',
                    'I feel you! It\'s tough but we can figure it out together ðŸ¤',
                    'Don\'t give up! Sometimes the hardest problems teach us the most',
                    'Been there! Take a short break and come back to it fresh',
                    'You\'re not alone! What specific part is giving you trouble?',
                    'Challenging material means you\'re growing! Keep pushing! ðŸ’ª',
                    'I totally understand! Want to talk through what\'s bothering you?'
                ]);
            }
            
            // STRICT CONTEXT FILTERS - Prevent nonsensical responses
            
            // FILTER 1: Never respond to welcome messages from real users
            if (messageText.includes('welcome') || messageText.includes('good to have you') || 
                messageText.includes('great to have you') || messageText.includes('glad to have you') ||
                messageText.includes('nice to have you') || messageText.includes('welcome to') ||
                messageText.includes('welcome everyone') || messageText.includes('welcome all') ||
                messageText.includes('good to see you') || messageText.includes('nice to see you')) {
                return null; // Never respond to welcome messages
            }
            
            // FILTER 2: Never respond to general greetings to groups
            if ((messageText.includes('hi everyone') || messageText.includes('hello everyone') || 
                 messageText.includes('hey everyone') || messageText.includes('hi all') ||
                 messageText.includes('hello all') || messageText.includes('hey all')) &&
                messageText.length < 40 && !messageText.includes('?')) {
                return null; // Don't respond to general group greetings
            }
            
            // FILTER 3: Never respond to system/goodbye messages
            if (messageText.includes('left the') || messageText.includes('finished their') ||
                messageText.includes('goodbye') || messageText.includes('see you later') ||
                messageText.includes('catch you later') || messageText.includes('thanks for studying') ||
                messageText.includes('good luck with') || messageText.includes('have a great')) {
                return null; // Never respond to farewell messages
            }
            
            // FILTER 4: Don't respond to compliments about the room/app/general things
            if ((messageText.includes('love') || messageText.includes('amazing') || messageText.includes('great')) &&
                (messageText.includes('room') || messageText.includes('group') || messageText.includes('app') ||
                 messageText.includes('energy') || messageText.includes('vibe') || messageText.includes('everyone'))) {
                return null; // Don't respond to general compliments
            }
            
            // FILTER 5: Don't respond to pure status updates
            if ((messageText.includes('i\'m') || messageText.includes('i am') || messageText.includes('just finished') ||
                messageText.includes('taking a break') || messageText.includes('be right back') ||
                messageText.includes('brb') || messageText.includes('going to')) &&
                !messageText.includes('?') && !messageText.includes('anyone')) {
                return null; // Don't respond to personal status updates
            }
            
            // PRIORITY: Check for greetings + readiness FIRST - even when mixed with names
            if ((messageText.includes('hi ') || messageText.includes('hello ') || messageText.includes('hey ') || 
                messageText.includes(' hi') || messageText.includes(' hello') || messageText.includes(' hey') ||
                messageText.startsWith('hi') || messageText.startsWith('hello') || messageText.startsWith('hey')) &&
                (messageText.includes('ready') || messageText.includes('study') || messageText.includes('focus') ||
                 messageText.includes('tackle') || messageText.includes('studying'))) {
                
                return getRandomItem([
                    'Absolutely! I\'m totally ready to dive into some serious studying! ðŸŽ¯',
                    'Yes! I\'m pumped and ready to focus today! ðŸ’ª',
                    'Definitely ready! Let\'s make this a super productive session! ðŸ“š',
                    '100% ready! I love studying with motivated people like you! âš¡',
                    'So ready! Perfect timing - I was just getting into my study flow! ðŸ”¥',
                    'Absolutely ready to tackle some learning! ðŸ˜Š'
                ]);
            }
            
            // Pure greeting detection - check for greeting words at start or as standalone
            if (messageText.includes('hi ') || messageText.includes('hello ') || messageText.includes('hey ') || 
                messageText.includes(' hi') || messageText.includes(' hello') || messageText.includes(' hey') ||
                messageText.startsWith('hi') || messageText.startsWith('hello') || messageText.startsWith('hey')) {
                
                return getRandomItem([
                    'Hey there! Welcome to the study group! ðŸ‘‹',
                    'Hello! Great to have you here!',
                    'Hi! Ready to crush some studying together? ðŸ’ª',
                    'Hey! Good to see another dedicated student! ðŸ“š',
                    'Welcome! Let\'s make this a productive session! âœ¨',
                    'Hi! Love the energy in this room today! ðŸ”¥',
                    'Hey there! Perfect timing to join our study session! ðŸ˜Š',
                    'Hello! So glad you\'re here!'
                ]);
            }
            
            // Hunger and food-related messages - only respond to explicit mentions
            const hasExplicitFoodMention = (
                messageText.includes('hungry') || messageText.includes('snack') ||
                messageText.includes('starving') || messageText.includes('eat') ||
                messageText.includes('lunch') || messageText.includes('dinner') ||
                messageText.includes('breakfast') || messageText.includes('food')
            );

            if (hasExplicitFoodMention) {
                return getRandomItem([
                    'Same here! I could definitely go for some food right now too! ðŸ•',
                    'Perfect timing for a snack break! What are you thinking of eating?',
                    'I\'m getting pretty hungry too! This studying is making me work up an appetite ðŸ˜‚',
                    'Food break sounds amazing! Maybe we should all take a quick food break? â˜•ðŸ¥ª',
                    'You\'re not alone! My stomach has been growling too ðŸ˜†',
                    'Brain work definitely burns calories! Time for some fuel ðŸ§ âš¡',
                    'I could totally go for some food too! Anyone else getting hangry? ðŸ¿',
                    'Same! Studying always makes me hungry - our brains need that energy! ðŸŽ'
                ]);
            }
            
            // Bathroom and personal needs
            if (messageText.includes('bathroom') || messageText.includes('pee') || messageText.includes('restroom') ||
                messageText.includes('brb') || messageText.includes('quick break') || messageText.includes('be right back')) {
                return getRandomItem([
                    'Go for it! We\'ll keep the study energy going! ðŸ’ª',
                    'Take your time! Perfect excuse for everyone to stretch ðŸ¤¸â€â™€ï¸',
                    'Good call! I should probably take a quick break too!',
                    'No worries! See you back in a few! ðŸ‘‹',
                    'BRB! That reminds me I need to get up and move around too!',
                    'Smart to take breaks! Your brain will thank you! ðŸ§ âœ¨',
                    'Totally understand! Quick breaks keep us productive! âš¡',
                    'See you in a bit! Taking care of yourself is part of good studying! ðŸ˜Š'
                ]);
            }
            
            // Motivation and enthusiasm  
            if (messageText.includes('motivated') || messageText.includes('pumped') || messageText.includes('ready') || 
                messageText.includes('excited') || messageText.includes('determined') || messageText.includes('let\'s go') ||
                messageText.includes('yay') || messageText.includes('woohoo')) {
                return getRandomItem([
                    'That\'s the spirit! Let\'s do this! ðŸ’ª',
                    'Love the energy! You\'ve got this!',
                    'Awesome attitude! We\'re all going to smash our goals today!',
                    'Yes! That motivation is contagious! ðŸ”¥',
                    'That\'s what I like to hear! Let\'s stay focused!',
                    'Your enthusiasm is amazing! Ready to crush this session! âš¡',
                    'I\'m feeling that energy! Let\'s make today super productive! ðŸŽ¯'
                ]);
            }
            
            // Difficulty and stress
            if (messageText.includes('stressed') || messageText.includes('stress') || messageText.includes('help') || 
                messageText.includes('hard') || messageText.includes('difficult') || messageText.includes('tough') || 
                messageText.includes('challenging') || messageText.includes('struggle') || messageText.includes('stuck') ||
                messageText.includes('arg') || messageText.includes('ugh') || messageText.includes('frustrated')) {
                return getRandomItem([
                    'I feel you! It\'s tough but we can figure it out together ðŸ¤',
                    'Don\'t give up! Sometimes the hardest problems teach us the most',
                    'Been there! Take a short break and come back to it fresh',
                    'You\'re not alone! What specific part is giving you trouble?',
                    'Challenging material means you\'re growing! Keep pushing! ðŸ’ª',
                    'I totally understand! Want to talk through what\'s bothering you?',
                    'Hang in there! We\'re all here to support each other! âœ¨'
                ]);
            }
            
            // Completion and achievements
            if (messageText.includes('done') || messageText.includes('finished') || messageText.includes('completed') || 
                messageText.includes('accomplished') || messageText.includes('success') || messageText.includes('nailed it')) {
                return getRandomItem([
                    'Congratulations! That\'s awesome! ðŸŽ‰',
                    'Way to go! You\'re making great progress!',
                    'Nice work! How does it feel to check that off the list?',
                    'Fantastic! You\'re inspiring the rest of us!',
                    'Well done! Time for a well-deserved break! â˜•',
                    'Amazing work! Your dedication is really paying off! âœ¨',
                    'That\'s what I call productivity! Great job! ðŸ’ª'
                ]);
            }
            
            // Questions - but keep responses general and supportive
            if (messageText.includes('?') || messageText.includes('anyone') || messageText.includes('what do you think')) {
                return getRandomItem([
                    'Great question! That\'s definitely worth thinking about!',
                    'I\'m curious about that too! Interesting point to consider.',
                    'Hmm, that\'s worth exploring! Good observation.',
                    'Good point! I\'ve been wondering about something similar.',
                    'Interesting question! Thanks for bringing that up!',
                    'That\'s a thoughtful question! Always good to ask those things.',
                    'Nice question! I love when people think deeply about things.'
                ]);
            }
            
            // Subject-specific replies
            if (currentRoom && currentRoom.subjects) {
                const subjectReplies = getSubjectSpecificReplies(currentRoom.subjects, userMessage);
                if (subjectReplies.length > 0) {
                    return getRandomItem(subjectReplies);
                }
            }
            
            // General supportive replies for other messages (removed non-contextual responses)
            return getRandomItem([
                'Keep up the great work! ðŸ“š',
                'You\'ve got this! Stay focused! ðŸ’ª',
                'Same here! This study group is really helping me stay on track',
                'Totally agree! Let\'s keep each other motivated!',
                'I hear you! We\'re all in this together! ðŸ¤',
                'That\'s so relatable! Thanks for sharing!',
                'Exactly! That\'s what makes studying together so valuable',
                'Absolutely! You\'re spot on with that! âœ¨',
                'I can relate to that! Thanks for putting it so well! ðŸ˜Š',
                'Right there with you! ðŸ’¯',
                'This is so motivating! ðŸ”¥',
                'Love the energy! âš¡',
                'Feeling the same way! ðŸ™Œ'
            ]);
        }

        function getSubjectSpecificReplies(subjects, userMessage) {
            const replies = [];
            
            subjects.forEach(subject => {
                switch(subject.toLowerCase()) {
                    case 'mathematics':
                        if (userMessage.includes('math') || userMessage.includes('equation') || userMessage.includes('problem')) {
                            replies.push(...[
                                'Math can be tricky! Which topic are you working on?',
                                'I love how math builds on itself! What chapter?',
                                'Those equations can be sneaky! Double-check your algebra ðŸ“',
                                'Math is like a puzzle - so satisfying when it clicks!'
                            ]);
                        }
                        break;
                    case 'science':
                        if (userMessage.includes('science') || userMessage.includes('experiment') || userMessage.includes('lab')) {
                            replies.push(...[
                                'Science is fascinating! What are you studying?',
                                'Lab reports can be intense! Good luck! ðŸ§ª',
                                'I love how science explains everything around us!',
                                'Those scientific concepts are mind-blowing when you get them!'
                            ]);
                        }
                        break;
                    case 'computer science':
                        if (userMessage.includes('code') || userMessage.includes('programming') || userMessage.includes('computer')) {
                            replies.push(...[
                                'Coding is so rewarding! What language are you using? ðŸ’»',
                                'Debug life! Sometimes the smallest typos cause the biggest headaches',
                                'Programming teaches such great problem-solving skills!',
                                'The feeling when your code finally works is unbeatable! ðŸŽ‰'
                            ]);
                        }
                        break;
                }
            });
            
            return replies;
        }

        function startEnhancedChat() {
            if (!chatEnabled || !currentRoom) return;
            
            // Initial welcome message
            setTimeout(() => {
                const welcomeUser = getRandomItem(currentRoom.users.filter(u => !u.isCurrentUser));
                const welcomeMessages = [
                    `Welcome ${document.getElementById('userName').textContent}! Great to have you in our study group! ðŸŽ‰`,
                    `Hey ${document.getElementById('userName').textContent}! Ready to tackle some studying together?`,
                    `Welcome to the group! I\'m ${welcomeUser.name}, let\'s make this a productive session!`,
                    `Hi there! Love seeing new faces in our study space! What are you working on?`
                ];
                addChatMessage(welcomeUser.name, getRandomItem(welcomeMessages));
            }, 2000);
            
            // More frequent regular messages
            setTimeout(() => scheduleRegularChatActivity(), getRandomNumber(10000, 20000));
        }

        function scheduleRegularChatActivity() {
            if (!chatEnabled || !currentRoom || chatCooldownActive) return;
            
            // Check if there's been recent chat activity - if so, pause regular messages
            const now = Date.now();
            if (now - lastChatMessageTime < 20000) { // 20 seconds pause after any message (reduced from 30)
                setTimeout(() => scheduleRegularChatActivity(), 15000); // Check again in 15 seconds
                return;
            }
            
            // Get available users (exclude current user and last sender to avoid repetition)
            const availableUsers = currentRoom.users.filter(u => 
                !u.isCurrentUser && u.name !== lastChatSender
            );
            
            // If no available users (rare edge case), include all fake users
            const userPool = availableUsers.length > 0 ? availableUsers : 
                             currentRoom.users.filter(u => !u.isCurrentUser);
            
            if (userPool.length === 0) return; // Safety check
            
            const user = getRandomItem(userPool);
            const message = generateRegularChatMessage();
            
            // Set global cooldown
            chatCooldownActive = true;
            lastChatMessageTime = now;
            addChatMessage(user.name, message);
            
            // Track last sender to prevent immediate repetition
            lastChatSender = user.name;
            
            // Store message in history to prevent repetition across different users
            chatMessageHistory.push(message);
            if (chatMessageHistory.length > 15) {
                chatMessageHistory.shift(); // Keep only last 15 messages
            }
            
            // More frequent regular activity for livelier chat
            const baseDelay = getRandomNumber(25000, 65000); // 25s to 65s base (much more frequent)
            const participantFactor = Math.max(0.6, 1 - (currentRoom.participants / 40)); // A bit faster in larger rooms
            const adjustedDelay = baseDelay * participantFactor;
            
            setTimeout(() => {
                chatCooldownActive = false;
            }, 10000); // 10 second cooldown after regular messages (reduced from 15)
            
            setTimeout(() => scheduleRegularChatActivity(), adjustedDelay);
        }

        function generateRegularChatMessage() {
            const generalMessages = [
                'This study group is really helping me stay focused! ðŸ’ª',
                'Anyone else find it easier to study with others?',
                'Anyone else hungry?',
                'Who wants coffee?',
                'Anyone feel stressed about exams?',
                'Who prefers studying in the morning?',
                'Anyone else tired?',
                'Does anyone need a break?',
                'Taking a quick 2-minute break to stretch ðŸ¤¸â€â™€ï¸',
                'I need to pee, wait a moment!',
                'Hiiiii!',
                'Ahh I have an exam tomorrow! Please pray for me! ðŸ™ðŸ»',
                'So worried about my studies... ðŸ˜¥',
                'if you\â€™re reading this, take it as your gentle reminder to focus and get back to work ðŸ’ªâœ¨',
                'The Pomodoro technique is a game changer!',
                'Love the energy in this room! ðŸ”¥',
                'Remember to stay hydrated everyone! ðŸ’§',
                'Who else is obsessed with Study Sync? ðŸ˜„',
                'Who else is powered by coffee today? â˜•',
                'Almost done with this chapter! ðŸ“–',
                'Study tip: explain concepts out loud - it really helps!',
                'Good luck everyone! We\'ve got this! ðŸŽ¯',
                'The accountability here is amazing!',
                'Hello everyone!',
                'Hi guys!!',
                'Short break, then back to the grind! ðŸ’¼',
                'This timer system is keeping me so productive!',
                'Anyone else love the satisfaction of checking off tasks? âœ…',
                'Just switched to background music - much better concentration! ðŸŽµ',
                'Pro tip: the 2-minute rule really works for small tasks',
                'Time flies when you\'re in the zone!',
                'This collaborative energy is so motivating âš¡',
                'To whoever sees this: You can do this!',
                'If you are reading this: We are all rooting for you!',
                'Friendly reminder: If you are reading this, remember to focus on you\'re studies! ðŸ˜‰',
                'Setting smaller goals is helping me stay on track',
                'Anyone else prefer studying in the morning vs evening?',
                'The accountability in here is next level! ðŸ“ˆ',
                'Just organized my notes - feeling much clearer now',
                'Breaking down complex topics into chunks really helps',
                'Study buddy system for the win! ðŸ¤',
                'Focus mode: activated! Let\'s crush these goals',
                'Quick brain break with some deep breathing ðŸ§˜â€â™€ï¸',
                'Highlighter game strong today! ðŸ–ï¸',
                'Making steady progress - slow and steady wins!',
                'The power of consistent study sessions is real',
                'Grateful for this supportive study community! ðŸ™',
                'What are ya\'ll studying?',
                'Just switched study locations - fresh perspective!',
                'Active recall method is challenging but effective',
                'Study playlist is hitting different today ðŸŽ§',
                'Mind mapping this topic is making it click!',
                'Taking notes by hand vs typing - old school wins',
                'Hi friends!!!',
                'The struggle is real but so is the progress! ðŸ’¯',
                'Switching between subjects keeps me engaged',
                'Environment matters - clean desk, clear mind',
                'Study timer just hit and I\'m actually sad to stop!',
                'Celebrating small wins throughout the session ðŸŽŠ',
                'This group dynamic is everything! Team effort!',
                'Snack break = brain fuel â›½ðŸ¤£ðŸ¤£ðŸ¤£',
                'You can do this! We\'re rooting for you. ðŸ˜„',
                'The grind never stops but neither do we!',
                'Visual learner checking in - diagrams everywhere! ðŸ“Š',
                'Question everything, understand everything ðŸ¤”',
                'Arggg I\'m so hungry! ðŸ˜…',
                'Making connections between topics is so satisfying'
            ];
            
            const subjectMessages = currentRoom ? getSubjectSpecificMessages(currentRoom.subjects) : [];
            const statusMessages = getStatusSpecificMessages();
            
            const allMessages = [...generalMessages, ...subjectMessages, ...statusMessages];
            
            // Filter out recently used messages
            const availableMessages = allMessages.filter(msg => !recentChatMessages.includes(msg));
            
            // If all messages have been used recently, reset the tracking
            if (availableMessages.length === 0) {
                recentChatMessages = [];
                const selectedMessage = getRandomItem(allMessages);
                recentChatMessages.push(selectedMessage);
                return selectedMessage;
            }
            
            const selectedMessage = getRandomItem(availableMessages);
            recentChatMessages.push(selectedMessage);
            
            // Keep only the last 5 messages in memory to prevent repeating
            if (recentChatMessages.length > 5) {
                recentChatMessages.shift();
            }
            
            return selectedMessage;
        }

        function getSubjectSpecificMessages(subjects) {
            const messages = [];
            
            subjects.forEach(subject => {
                const subjectMessages = {
                    'Mathematics': [
                        'These calculus problems are really clicking now! ðŸ“',
                        'Algebra review is paying off in advanced topics',
                        'Mathematics is like a universal language ðŸ”¢',
                        'Just solved a tricky geometry proof! âœ…'
                    ],
                    'Science': [
                        'Lab results came in better than expected! ðŸ§ª',
                        'This chemistry chapter is fascinating',
                        'Physics concepts are starting to make sense! âš¡',
                        'Science homework due tomorrow - almost done!'
                    ],
                    'Computer Science': [
                        'Finally debugged that tricky algorithm! ðŸ’»',
                        'Data structures are becoming second nature',
                        'Machine learning concepts are mind-blowing ðŸ¤–',
                        'Code review session was super helpful!'
                    ],
                    'History': [
                        'This historical period is so interesting! ðŸ“š',
                        'Making connections between different eras',
                        'Essay on ancient civilizations due next week',
                        'History teaches us so much about today!'
                    ],
                    'English': [
                        'Shakespeare is growing on me! ðŸ“–',
                        'Creative writing assignment is flowing well',
                        'Literary analysis is getting easier with practice',
                        'Grammar rules finally making sense!'
                    ]
                };
                
                if (subjectMessages[subject]) {
                    messages.push(...subjectMessages[subject]);
                }
            });
            
            return messages;
        }

        function getStatusSpecificMessages() {
            const currentStatus = userStatus;
            const messages = {
                'studying': [
                    'In the zone right now! ðŸŽ¯',
                    'Deep focus mode activated!',
                    'Making great progress on my goals!'
                ],
                'break': [
                    'Perfect time for a quick break! â˜•',
                    'Stepping away for a few minutes',
                    'Break time - back to studying soon!'
                ],
                'focused': [
                    'Laser focused today! ðŸ”¥',
                    'Nothing can break my concentration!',
                    'In my element right now!'
                ],
                'resting': [
                    'Taking a well-deserved rest ðŸ˜´',
                    'Recharging for the next session',
                    'Short rest before the next push!'
                ]
            };
            
            return messages[currentStatus] || [];
        }

        // Enhanced checklist functionality
        function renderChecklist() {
            const container = document.getElementById('checklistContainer');
            container.innerHTML = userChecklist.map(item => `
                <div class="flex items-center space-x-2 p-2 bg-white/40 rounded-lg hover:bg-white/60 transition-all">
                    <button class="checklist-toggle w-4 h-4 rounded border-2 border-muted-pink-300 dark:border-gray-500 flex items-center justify-center hover:bg-muted-pink-50 dark:hover:bg-gray-600 transition-all ${item.completed ? 'bg-muted-pink-500 border-muted-pink-500 dark:bg-muted-pink-400 dark:border-muted-pink-400' : ''}" data-id="${item.id}">
                        ${item.completed ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                    </button>
                    <span class="flex-1 text-sm ${item.completed ? 'line-through text-warm-gray-500' : 'text-warm-gray-800'}">${item.text}</span>
                    <button class="remove-checklist-item text-warm-gray-400 hover:text-red-500 text-xs transition-all" data-id="${item.id}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');

            // Add event listeners
            document.querySelectorAll('.checklist-toggle').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = e.currentTarget.dataset.id;
                    const item = userChecklist.find(i => i.id === itemId);
                    if (item) {
                        item.completed = !item.completed;
                        if (item.completed) {
                            showMotivationalQuote();
                            updateGoalsCompleted();
                        }
                        renderChecklist();
                    }
                });
            });

            document.querySelectorAll('.remove-checklist-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = e.currentTarget.dataset.id;
                    userChecklist = userChecklist.filter(i => i.id !== itemId);
                    renderChecklist();
                });
            });
        }

        function addChecklistItem(text) {
            const newItem = {
                id: Math.random().toString(36).substr(2, 9),
                text: text,
                completed: false
            };
            userChecklist.push(newItem);
            renderChecklist();
        }

        function showMotivationalQuote() {
            const quote = getRandomItem(motivationalQuotes);
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-md w-full mx-4 text-center animate-bounce-gentle">
                    <div class="w-16 h-16 bg-gradient-to-r from-muted-pink-400 to-muted-pink-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-trophy text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-warm-gray-900 dark:text-white mb-4">Goal Completed! ðŸŽ‰</h3>
                    <p class="text-warm-gray-700 dark:text-gray-300 mb-6 text-sm leading-relaxed">"${quote}"</p>
                    <button class="px-6 py-2 bg-muted-pink-500 text-white rounded-lg hover:bg-muted-pink-600 transition-all transform hover:scale-105" onclick="this.closest('.fixed').remove()">
                        Continue Studying
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 8000);
        }

        function updateGoalsCompleted() {
            const completedCount = parseInt(document.getElementById('goalsCompleted').textContent) + 1;
            document.getElementById('goalsCompleted').textContent = completedCount;
        }

        // Back to dashboard without leaving room (keeps timer running)
        function backToDashboard() {
            if (!currentRoom) return;

            // Save current room as background room
            backgroundRoom = currentRoom;
            isViewingDashboard = true;

            // Hide room view, show dashboard
            document.getElementById('roomView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');

            // Show background room indicator
            showBackgroundRoomIndicator();

            // Force update timer display and status
            if (backgroundRoom.type === 'synchronized' && backgroundRoom.syncTimer) {
                // For synchronized rooms, update sync timer
                updateSyncTimerDisplay(backgroundRoom.syncTimer);
            } else {
                // For individual rooms, update regular timer
                updateTimerDisplay();
                updateTimerStatus();
            }
        }

        function showBackgroundRoomIndicator() {
            if (!backgroundRoom) return;

            const indicator = document.getElementById('backgroundRoomIndicator');
            indicator.classList.remove('hidden');

            // Update room name
            document.getElementById('backgroundRoomName').textContent = backgroundRoom.name;

            // Update timer display with current time
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('backgroundTimerDisplay').textContent = display;

            // Update timer status
            if (isPomodoro) {
                document.getElementById('backgroundTimerStatus').textContent = isStudyPhase ? 'Study Time' : 'Break Time';
            } else {
                document.getElementById('backgroundTimerStatus').textContent = 'Study Time';
            }
        }

        function hideBackgroundRoomIndicator() {
            document.getElementById('backgroundRoomIndicator').classList.add('hidden');
        }

        function returnToRoom() {
            if (!backgroundRoom) return;

            currentRoom = backgroundRoom;
            isViewingDashboard = false;

            // Show room view, hide dashboard
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('roomView').classList.remove('hidden');

            // Hide background indicator
            hideBackgroundRoomIndicator();
        }

        function leaveRoom() {
            // Add farewell message before leaving
            if (currentRoom && chatEnabled) {
                const farewellMessages = [
                    `${userProfile.name} left the study session. Thanks for studying together! ðŸ‘‹`,
                    `See you later! Good luck with your future studies! âœ¨`,
                    `${userProfile.name} finished their study session. Keep up the great work everyone! ðŸ’ª`,
                    `Thanks for the productive session everyone! Catch you later! ðŸ“š`
                ];
                addSystemMessage(getRandomItem(farewellMessages));
            }
            
            // Remove current user from the room and decrement participant count
            if (currentRoom && currentRoom.users) {
                // Remove the current user from the users list
                const initialUserCount = currentRoom.users.length;
                currentRoom.users = currentRoom.users.filter(user => !user.isCurrentUser);
                
                // Only decrement if we actually removed a user
                if (currentRoom.users.length < initialUserCount) {
                    currentRoom.participants--;
                }
                
                // Ensure participant count matches users array
                currentRoom.participants = currentRoom.users.length;
            }
            
            document.getElementById('roomView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
            
            // Clean up timers
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (roomTimer) {
                clearInterval(roomTimer);
                roomTimer = null;
            }
            if (chatReplyTimeout) {
                clearTimeout(chatReplyTimeout);
                chatReplyTimeout = null;
            }

            // Stop online time updates
            if (onlineTimeUpdateInterval) {
                clearInterval(onlineTimeUpdateInterval);
                onlineTimeUpdateInterval = null;
            }

            // Stop study time tracking
            stopStudyTimeTracking();

            isRunning = false;
            currentTime = 0;
            currentRoom = null;
            backgroundRoom = null;
            isViewingDashboard = true;
            lastUserMessage = null;

            // Hide background room indicator
            hideBackgroundRoomIndicator();

            // Stop fake user timers and status updates
            if (fakeUserTimersInterval) {
                clearInterval(fakeUserTimersInterval);
                fakeUserTimersInterval = null;
            }
            if (fakeUserStatusInterval) {
                clearInterval(fakeUserStatusInterval);
                fakeUserStatusInterval = null;
            }
            
            // Clear chat
            document.getElementById('chatMessages').innerHTML = '';
            
            // Re-render rooms to show updated participant count
            filterRooms();
        }

        // Enhanced cleanup function
        function cleanup() {
            // Clear all intervals
            if (roomActivityInterval) {
                clearInterval(roomActivityInterval);
                roomActivityInterval = null;
            }
            if (roomListUpdateInterval) {
                clearInterval(roomListUpdateInterval);
                roomListUpdateInterval = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (roomTimer) {
                clearInterval(roomTimer);
                roomTimer = null;
            }
            if (fakeUserTimersInterval) {
                clearInterval(fakeUserTimersInterval);
                fakeUserTimersInterval = null;
            }
            if (fakeUserStatusInterval) {
                clearInterval(fakeUserStatusInterval);
                fakeUserStatusInterval = null;
            }
            if (chatReplyTimeout) {
                clearTimeout(chatReplyTimeout);
                chatReplyTimeout = null;
            }
            
            // Clear message history to prevent memory accumulation
            chatMessageHistory = [];
            recentChatMessages = [];
            usedGeneralMessages = [];
            usedSubjectMessages = [];
            usedStatusMessages = [];
            recentFakeMessages = [];
            
            // Reset chat sender tracking
            lastChatSender = null;
        }

        // Add cleanup when the page unloads
        window.addEventListener('beforeunload', cleanup);

        // Motivational quote functionality with proper shuffling
        let quotesPool = [...motivationalQuotes];
        let currentQuoteIndex = 0;
        
        function shuffleQuotes() {
            // Fisher-Yates shuffle algorithm
            for (let i = quotesPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [quotesPool[i], quotesPool[j]] = [quotesPool[j], quotesPool[i]];
            }
            currentQuoteIndex = 0;
        }

        function updateMotivationalQuote() {
            const quoteElement = document.getElementById('motivationalQuote');
            
            // If we've gone through all quotes, reshuffle
            if (currentQuoteIndex >= quotesPool.length) {
                shuffleQuotes();
            }
            
            const nextQuote = quotesPool[currentQuoteIndex];
            currentQuoteIndex++;
            
            // Add fade effect
            quoteElement.style.opacity = '0.5';
            
            setTimeout(() => {
                quoteElement.textContent = `"${nextQuote}"`;
                quoteElement.style.opacity = '1';
            }, 250);
        }

        function startQuoteRotation() {
            // Initial shuffle
            shuffleQuotes();
            // Update quote every 30 seconds
            setInterval(updateMotivationalQuote, 30000);
        }

        // Fake user timer functionality
        function startFakeUserTimers() {
            if (!currentRoom || currentRoom.type !== 'individual' || !currentRoom.users) return;
            
            // Update fake user timers every second
            fakeUserTimersInterval = setInterval(() => {
                try {
                    if (!currentRoom || currentRoom.type !== 'individual' || !currentRoom.users) return;
                    
                    let timersUpdated = false;
                    
                    currentRoom.users.forEach(user => {
                        if (!user.isCurrentUser && user.timerSeconds !== null && user.timerSeconds !== undefined && user.timerSeconds > 0) {
                            user.timerSeconds--;
                            
                            // Update timer display
                            const minutes = Math.floor(user.timerSeconds / 60);
                            const seconds = user.timerSeconds % 60;
                            user.timer = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                            timersUpdated = true;
                            
                            // Handle timer completion
                            if (user.timerSeconds <= 0) {
                                completeFakeUserTimer(user);
                            }
                        }
                    });
                    
                    // Re-render users if any timers were updated
                    if (timersUpdated) {
                        renderUsers(currentRoom.users);
                    }
                } catch (error) {
                    console.error('Error in fake user timers:', error);
                }
            }, 1000);
        }

        function completeFakeUserTimer(user) {
            // Reset timer with a new random duration (simulate starting a new session)
            const minutes = getRandomNumber(15, 50);
            const seconds = getRandomNumber(0, 59);
            user.timerSeconds = minutes * 60 + seconds;
            user.timer = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Occasionally post a completion message in chat
            if (Math.random() < 0.12 && chatEnabled) { // 12% chance (reduced from 20%)
                setTimeout(() => {
                    const completionMessages = [
                        'Just finished a great study session! ðŸŽ‰',
                        'Timer done! Taking a quick break before the next round â˜•',
                        'Completed another focus session! This app is amazing! ðŸ’ª',
                        'Study session complete! Feeling productive! âœ…',
                        'Another successful timer! Ready for the next challenge! ðŸ”¥'
                    ];
                    addChatMessage(user.name, getRandomItem(completionMessages));
                }, getRandomNumber(2000, 8000));
            }
        }

        // Enhanced fake user status updates based on timers
        function startFakeUserStatusUpdates() {
            if (!currentRoom) return;
            
            fakeUserStatusInterval = setInterval(() => {
                if (!currentRoom) return;
                
                let statusUpdated = false;
                const now = Date.now();
                
                currentRoom.users.forEach(user => {
                    if (!user.isCurrentUser) {
                        // Check if it's time to potentially change status
                        const timeSinceLastChange = now - (user.lastStatusChange || now);
                        
                        // Change status every 30-120 seconds randomly
                        if (timeSinceLastChange > getRandomNumber(30000, 120000)) {
                            updateFakeUserStatus(user);
                            user.lastStatusChange = now;
                            statusUpdated = true;
                        }
                    }
                });
                
                if (statusUpdated) {
                    renderUsers(currentRoom.users);
                }
            }, 5000); // Check every 5 seconds
        }

        // Enhanced cleanup to clear fake-to-fake message tracking
        function clearFakeMessageTracking() {
            recentFakeMessages = [];
            chatMessageHistory = [];
            recentChatMessages = [];
            lastChatSender = null;
        }

        function updateFakeUserStatus(user) {
            // Status logic based on room type and timer state
            if (currentRoom.type === 'synchronized' && currentRoom.syncTimer) {
                // Synchronized rooms: status based on room timer
                if (currentRoom.syncTimer.isWaiting) {
                    // During waiting period: mix of resting and break
                    user.status = Math.random() > 0.6 ? 'resting' : 'break';
                } else if (currentRoom.syncTimer.isStudyPhase) {
                    // During study phase: mostly studying/focused, some break (bathroom etc.)
                    const rand = Math.random();
                    if (rand < 0.7) user.status = 'studying';
                    else if (rand < 0.9) user.status = 'focused';
                    else user.status = 'break';
                } else {
                    // During break phase: mostly break, some resting
                    user.status = Math.random() > 0.3 ? 'break' : 'resting';
                }
            } else {
                // Individual rooms: status based on their personal timer
                if (user.timerSeconds && user.timerSeconds > 0) {
                    // Timer is running: mostly studying/focused
                    const rand = Math.random();
                    if (rand < 0.6) user.status = 'studying';
                    else if (rand < 0.85) user.status = 'focused';
                    else user.status = 'break'; // Short break during study
                } else {
                    // Timer not running or completed: break/resting
                    user.status = Math.random() > 0.5 ? 'break' : 'resting';
                }
            }
        }

        // Dynamic room participant changes
        function startRoomActivitySystem() {
            // Clear any existing intervals first to prevent multiple intervals running
            stopRoomActivitySystem();
            
            roomActivityInterval = setInterval(() => {
                updateRoomParticipants();
            }, getRandomNumber(8000, 15000)); // 8-15 seconds between updates
            
            // Start continuous room list updates for instant-join
            roomListUpdateInterval = setInterval(() => {
                // Only update if we're on dashboard and instant-join is active
                if (!currentRoom && currentFilters.type === 'instant-join') {
                    filterRooms();
                }
            }, 10000); // Update every 10 seconds
        }

        function updateRoomParticipants() {
            if (!allRooms || allRooms.length === 0) return;
            
            // Update 1-3 random rooms each time
            const roomsToUpdate = getRandomNumber(1, 3);
            
            for (let i = 0; i < roomsToUpdate; i++) {
                // Include user-created rooms in the update system, but don't exclude current room
                const eligibleRooms = allRooms;
                const room = getRandomItem(eligibleRooms);
                if (room) {
                    updateSingleRoomParticipants(room);
                }
            }

            // Always update the room you're in
            if (currentRoom) {
                updateSingleRoomParticipants(currentRoom);
            }
            
            // Re-render rooms if we're on dashboard
            if (!currentRoom) {
                filterRooms();
            }
        }

        function updateSingleRoomParticipants(room) {
            const changeType = Math.random();
            
            if (changeType < 0.4) {
                // 40% chance: someone joins
                addParticipantToRoom(room);
            } else if (changeType < 0.7) {
                // 30% chance: someone leaves
                removeParticipantFromRoom(room);
            } else {
                // 30% chance: no change (keeps some rooms stable)
                return;
            }
            
            // Update last activity time
            room.lastActivity = new Date();
            
            // Update dashboard if user is viewing it
            if (!currentRoom) {
                filterRooms();
            }
        }

        function addParticipantToRoom(room) {
            // Don't let rooms get too crowded
            if (room.participants >= 30) return;
            
            // More likely to join if room has moderate size
            const joinProbability = room.participants < 15 ? 0.8 : 0.4;
            if (Math.random() > joinProbability) return;
            
            // Generate new fake user with enhanced duplicate prevention
            const newUser = generateFakeUser(room.subjects, room.type, room.country, room.users);

            room.users.push(newUser);
            room.participants++;

            // Update participant count in header if user is in this room
            if (currentRoom && currentRoom.id === room.id) {
                currentRoom.users = room.users;
                currentRoom.participants = room.participants;
                document.getElementById('roomParticipants').textContent = `${room.participants} participants`;
                renderUsers(room.users);
                
                // Show subtle join notification
                showJoinNotification(newUser.name);
                
                // Show join message in chat if user is in this room
                if (chatEnabled) {
                    setTimeout(() => {
                        const joinMessages = [
                            `${newUser.name} joined the study group! Welcome! ðŸ‘‹`,
                            `Hey everyone! ${newUser.name} is here to study ${newUser.subject}`,
                            `${newUser.name} just joined us! Let's keep each other motivated! ðŸ’ª`,
                            `Welcome ${newUser.name}! Great to have you in our study session!`
                        ];

                        addSystemMessage(getRandomItem(joinMessages));
                        
                        // Have existing fake users greet the new user less often
                        if (Math.random() < 0.5) { // 50% chance (reduced from 80%)
                            setTimeout(() => {
                                const existingFakeUsers = room.users.filter(u => !u.isCurrentUser && u.id !== newUser.id);
                                if (existingFakeUsers.length > 0) {
                                    const greeter = getRandomItem(existingFakeUsers);
                                    const greetingMessages = [
                                        `Welcome ${newUser.name}! Good to have you here! ðŸ˜Š`,
                                        `Hey ${newUser.name}! What are you studying today?`,
                                        `Welcome to the group ${newUser.name}! Let's crush our goals together! ðŸ’ª`,
                                        `Hi ${newUser.name}! Great timing - we're all really focused today!`,
                                        `Welcome ${newUser.name}! Hope you have a productive study session! ðŸ“š`,
                                        `Hey ${newUser.name}! Love the energy you're bringing! âš¡`,
                                        `Welcome aboard ${newUser.name}! This group is amazing for staying motivated!`,
                                        `Hi ${newUser.name}! Ready to tackle some serious studying? ðŸŽ¯`,
                                        `Welcome ${newUser.name}! Feel free to ask if you need any study tips!`,
                                        `Hey there ${newUser.name}! Excited to study alongside you! ðŸŒŸ`
                                    ];
                                    const welcomeMessage = getRandomItem(greetingMessages);
                                    addChatMessage(greeter.name, welcomeMessage);
                                    
                                    // Schedule the new user to reply back to the welcome (75% chance)
                                    if (Math.random() < 0.75) {
                                        setTimeout(() => {
                                            const replyMessages = [
                                                `Thanks! Happy to be here! ðŸ˜Š`,
                                                `Thank you! Excited to study with everyone! ðŸ’ª`,
                                                `Thanks for the warm welcome! ðŸ™`,
                                                `Hi everyone! Ready to get some serious studying done! ðŸ“š`,
                                                `Thank you! Love the positive energy here! âœ¨`,
                                                `Thanks! Looking forward to a productive session! ðŸŽ¯`,
                                                `Appreciate it! This group seems amazing! ðŸŒŸ`,
                                                `Thanks! Let's crush our goals together! ðŸ”¥`,
                                                `Thank you! Happy to join this motivated group! ðŸ’¯`,
                                                `Thanks! Perfect timing - I'm ready to focus! âš¡`
                                            ];
                                            addChatMessage(newUser.name, getRandomItem(replyMessages));
                                        }, getRandomNumber(2000, 6000)); // 2-6 seconds after welcome
                                    }
                                }
                            }, getRandomNumber(2000, 8000)); // 2-8 seconds after system message
                        }
                    }, getRandomNumber(1000, 3000));
                }
            }
        }
        
        // Track users who are currently leaving to prevent race conditions
        let usersCurrentlyLeaving = new Set();
        
        function removeParticipantFromRoom(room) {
            // Don't let rooms become too empty
            if (room.participants <= 3) return;

            // Less likely to leave if room is small
            const leaveProbability = room.participants > 15 ? 0.6 : 0.3;
            if (Math.random() > leaveProbability) return;

            // Remove a random fake user (not current user if they're in the room, and not already leaving)
            const fakeUsers = room.users.filter(u => !u.isCurrentUser && !usersCurrentlyLeaving.has(u.id));
            if (fakeUsers.length === 0) return;

            const userToRemove = getRandomItem(fakeUsers);
            const roomId = room.id;
            const userToRemoveId = userToRemove.id;
            const userToRemoveName = userToRemove.name;

            // Mark this user as currently leaving to prevent race conditions
            usersCurrentlyLeaving.add(userToRemoveId);

            // Helper function to get the actual room from allRooms
            const getRoomById = (id) => allRooms.find(r => r.id === id);

            // Helper function to actually remove the user from the room
            const actuallyRemoveUser = () => {
                const actualRoom = getRoomById(roomId);
                if (!actualRoom) return false;

                const userIndex = actualRoom.users.findIndex(u => u.id === userToRemoveId);
                if (userIndex === -1) return false;

                // Remove user from the actual room in allRooms
                actualRoom.users.splice(userIndex, 1);
                actualRoom.participants = actualRoom.users.length;

                // Update UI if this is the current room
                if (currentRoom && currentRoom.id === roomId) {
                    // Sync currentRoom reference
                    currentRoom.users = actualRoom.users;
                    currentRoom.participants = actualRoom.participants;
                    document.getElementById('roomParticipants').textContent = `${actualRoom.participants} participants`;
                    renderUsers(actualRoom.users);
                }

                console.log(`âœ… Removed ${userToRemoveName} from room ${roomId}. New count: ${actualRoom.participants}`);
                return true;
            };

            // Only show goodbye flow if user is in THIS room and chat is enabled (60% chance of goodbye)
            const shouldShowGoodbye = currentRoom && currentRoom.id === roomId && chatEnabled && Math.random() < 0.6;

            if (shouldShowGoodbye) {
                const goodbyeMessages = [
                    'Time for me to go! Thanks for the great study session everyone! ðŸ‘‹',
                    'Alright, I\'m heading out! Good luck with your studies! ðŸ“šâœ¨',
                    'Thanks for studying together! Catch you all later! ðŸ’ª',
                    'Great session everyone! Time for me to take a break. See you! â˜•',
                    'I\'m going to call it here! You all are amazing study partners! ðŸŒŸ',
                    'Thanks for keeping me motivated! Time to go, but this was awesome! ðŸŽ¯',
                    'Productive session! I\'m heading out but keep up the great work! ðŸ”¥',
                    'Time for me to leave! Wishing everyone continued focus! ðŸ“–',
                    'I\'m signing off! Thanks for the positive study vibes! âœ¨',
                    'Gotta go! This study group energy is the best! See you! ðŸš€'
                ];

                // STEP 1: User sends goodbye message after 1-3 seconds
                setTimeout(() => {
                    const actualRoom = getRoomById(roomId);
                    if (actualRoom && actualRoom.users.find(u => u.id === userToRemoveId)) {
                        addChatMessage(userToRemoveName, getRandomItem(goodbyeMessages));
                    }
                }, getRandomNumber(1000, 3000));

                // STEP 2: Remove user from room after 3-4 seconds
                setTimeout(() => {
                    actuallyRemoveUser();
                }, getRandomNumber(3000, 4000));

                // STEP 3: Show system leave message after 4-5 seconds
                setTimeout(() => {
                    const leaveMessages = [
                        `${userToRemoveName} left the study session. Good luck! ðŸ‘‹`,
                        `${userToRemoveName} finished studying. See you next time! âœ¨`,
                        `${userToRemoveName} has left the room. Keep up the great work everyone! ðŸ’ª`
                    ];
                    addSystemMessage(getRandomItem(leaveMessages));
                }, getRandomNumber(4000, 5000));

                // STEP 4: Other users say goodbye after 5-7 seconds (1-2 people respond)
                setTimeout(() => {
                    const actualRoom = getRoomById(roomId);
                    if (!actualRoom) return;

                    const otherFakeUsers = actualRoom.users.filter(u => !u.isCurrentUser && u.id !== userToRemoveId);
                    if (otherFakeUsers.length > 0) {
                        const maxRepliers = Math.min(2, otherFakeUsers.length);
                        const numRepliers = Math.random() < 0.3 ? 0 : Math.random() < 0.6 ? 1 : 2; // 30% no replies, 30% one reply, 40% two replies

                        if (numRepliers > 0) {
                            const shuffled = [...otherFakeUsers].sort(() => Math.random() - 0.5);
                            const responders = shuffled.slice(0, Math.min(numRepliers, maxRepliers));

                            responders.forEach((user, index) => {
                                // 1-7 seconds apart
                                const baseDelay = 1000 + (index * 3000); // 1s, 4s, 7s...
                                const randomDelay = baseDelay + getRandomNumber(0, 2000);

                                setTimeout(() => {
                                    const currentActualRoom = getRoomById(roomId);
                                    if (currentActualRoom && currentActualRoom.users.find(u => u.id === user.id)) {
                                        const replyMessages = [
                                            'Good luck with everything! ðŸ‘‹',
                                            'See you later! Take care! âœ¨',
                                            'Bye! Thanks for studying with us! ðŸ’ª',
                                            'Good luck! Come back soon! ðŸ˜Š',
                                            'Take care! Great session! ðŸŒŸ',
                                            'Bye! Stay motivated! ðŸ”¥',
                                            'Good luck with your goals! ðŸ“š',
                                            'Later! Keep crushing it! ðŸŽ¯',
                                            'Bye! You did great today! ðŸ’¯',
                                            'Take care! Keep up the good work! âš¡'
                                        ];
                                        addChatMessage(user.name, getRandomItem(replyMessages));
                                    }
                                }, randomDelay);
                            });
                        }
                    }
                }, getRandomNumber(5000, 7000));

                // Final cleanup: remove from leaving tracker after everything is done
                setTimeout(() => {
                    usersCurrentlyLeaving.delete(userToRemoveId);
                }, 15000);

            } else {
                // Silent removal (no goodbye message in chat)
                actuallyRemoveUser();
                usersCurrentlyLeaving.delete(userToRemoveId);
            }
        }

        // Join notification system
        function showJoinNotification(userName) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 z-50 transform translate-x-full transition-all duration-500 ease-out';
            notification.innerHTML = `
                <div class="bg-white/90 backdrop-blur-md rounded-lg shadow-lg border border-muted-pink-200 p-4 flex items-center space-x-3 max-w-sm">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-user-plus text-white text-xs"></i>
                    </div>
                    <div class="min-w-0">
                        <p class="text-sm font-medium text-warm-gray-900 truncate">${userName} joined</p>
                        <p class="text-xs text-warm-gray-600">New study buddy!</p>
                    </div>
                    <button class="text-warm-gray-400 hover:text-warm-gray-600 transition-colors ml-2" onclick="this.closest('.fixed').remove()">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Slide in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
                notification.classList.add('translate-x-0');
            }, 100);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 500);
                }
            }, 4000);
        }

        function stopRoomActivitySystem() {
            if (roomActivityInterval) {
                clearInterval(roomActivityInterval);
                roomActivityInterval = null;
            }
            if (roomListUpdateInterval) {
                clearInterval(roomListUpdateInterval);
                roomListUpdateInterval = null;
            }
        }

        // Enhanced room creation with filter compliance
        function createNewRoom(roomData) {
            // Apply current filters to new room if active
            if (currentFilters.subject && currentFilters.subject !== 'Mixed Studies') {
                roomData.primarySubject = currentFilters.subject;
                roomData.subjects = [currentFilters.subject];
            }
            if (currentFilters.age && currentFilters.age !== 'Mixed Ages') {
                roomData.ageRange = currentFilters.age;
            }
            if (currentFilters.country && currentFilters.country !== 'International') {
                roomData.country = currentFilters.country;
            }
            if (currentFilters.timer) {
                roomData.timerStyle = currentFilters.timer === 'Pomodoro' ? 'Pomodoro' : 'Simple Timer';
            }
            
            // Mark as user created for special handling
            roomData.isUserCreated = true;
            
            return roomData;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize dark mode
            initializeDarkMode();

            // Initialize study time display
            updateStudyTimeDisplay();

            // Start motivational quote rotation
            startQuoteRotation();

            // Generate rooms with guaranteed minimums for filtering
            allRooms = generateRoomsWithGuarantees();
            renderRooms();
            
            // Start dynamic room activity system
            startRoomActivitySystem();
            
            // Search and filter listeners
            document.getElementById('searchRooms').addEventListener('input', filterRooms);
            document.getElementById('filterSubject').addEventListener('change', filterRooms);
            document.getElementById('filterAge').addEventListener('change', filterRooms);
            document.getElementById('filterCountry').addEventListener('change', filterRooms);
            document.getElementById('filterTimer').addEventListener('change', filterRooms);
            
            // Timer type toggle
            document.getElementById('timerType').addEventListener('change', toggleTimerSettings);
            
            // Create room timer style toggle
            document.getElementById('newRoomTimerStyle').addEventListener('change', toggleCreateRoomTimerSettings);
            
            // User status selector
            document.getElementById('userStatusSelect').addEventListener('change', (e) => {
                updateUserStatus(e.target.value);
            });
            
            // Room filters
            document.querySelectorAll('.room-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.room-filter-btn').forEach(b => {
                        b.classList.remove('active', 'bg-muted-pink-100', 'text-muted-pink-700');
                        b.classList.add('bg-white/60', 'text-warm-gray-700');
                    });
                    
                    btn.classList.add('active', 'bg-muted-pink-100', 'text-muted-pink-700');
                    btn.classList.remove('bg-white/60', 'text-warm-gray-700');
                    
                    filterRooms();
                });
            });
            
            // Modal controls
            document.getElementById('createRoomBtn').addEventListener('click', () => {
                document.getElementById('createRoomModal').classList.remove('hidden');
                document.getElementById('createRoomModal').classList.add('flex');
            });

            document.getElementById('closeCreateModal').addEventListener('click', () => {
                document.getElementById('createRoomModal').classList.add('hidden');
                document.getElementById('createRoomModal').classList.remove('flex');
            });

            document.getElementById('cancelCreateRoom').addEventListener('click', () => {
                document.getElementById('createRoomModal').classList.add('hidden');
                document.getElementById('createRoomModal').classList.remove('flex');
            });

            document.getElementById('confirmCreateRoom').addEventListener('click', () => {
                try {
                    const roomName = document.getElementById('newRoomName').value || 'My Study Room';
                    const roomSubject = document.getElementById('newRoomSubject').value;
                    const roomType = document.getElementById('newRoomType').value;
                    const timerStyle = document.getElementById('newRoomTimerStyle').value;
                    const roomCountry = document.getElementById('newRoomCountry').value;
                    const roomAgeGroup = document.getElementById('newRoomAgeGroup').value;
                    
                    // Get timer settings from the modal
                    let syncTimer = null;
                    if (roomType === 'synchronized') {
                        if (timerStyle === 'pomodoro') {
                            const studyDuration = parseInt(document.getElementById('newRoomStudyDuration').value) || 25;
                            const breakDuration = parseInt(document.getElementById('newRoomBreakDuration').value) || 5;
                            syncTimer = {
                                studyDuration: studyDuration,
                                breakDuration: breakDuration,
                                remaining: studyDuration * 60, // Start with study phase
                                isRunning: true,
                                isStudyPhase: true,
                                cycle: 1
                            };
                        } else {
                            const duration = parseInt(document.getElementById('newRoomSimpleDuration').value) || 60;
                            syncTimer = {
                                duration: duration,
                                remaining: duration * 60,
                                isRunning: true,
                                isStudyPhase: true
                            };
                        }
                    }
                    
                    const fakeUserCount = getRandomNumber(3, 8); // 3-8 fake users

                    let newRoom = {
                        id: Math.random().toString(36).substr(2, 9),
                        name: roomName,
                        primarySubject: roomSubject,
                        subjects: [roomSubject],
                        type: roomType,
                        timerStyle: timerStyle === 'pomodoro' ? 'Pomodoro' : 'Simple Timer',
                        school: 'Your School',
                        ageRange: roomAgeGroup,
                        country: roomCountry,
                        participants: 0, // start at 0, will be incremented when user joins
                        users: [],       // start empty, add fake users gradually
                        createdAt: new Date(),
                        syncTimer: syncTimer,
                        lastActivity: new Date()
                    };

                    // Apply current filters to new room
                    newRoom = createNewRoom(newRoom);

                    // Add to rooms list
                    allRooms.unshift(newRoom);
                    
                    // Check if new room passes current filters before showing
                    if (roomPassesFilters(newRoom, currentFilters)) {
                        renderRooms();
                    }
                    
                    joinRoom(newRoom); // join immediately with the real user

                    // Gradually add fake users
                    let addedUsers = 0;
                    let chatActivityRestarted = false;
                    function addNextFakeUser() {
                        if (addedUsers < fakeUserCount) {
                            // For Mixed Studies rooms, pass the subjects array so fake users get random subjects
                            const roomSubjectsForFakeUsers = roomSubject === 'Mixed Studies' ? ['Mixed Studies'] : roomSubject;
                            const fakeUser = generateFakeUser(roomSubjectsForFakeUsers, roomType, newRoom.country);
                            newRoom.users.push(fakeUser);
                            newRoom.participants++;
                            renderUsers(newRoom.users); // update the UI
                            
                            // Update header participant count
                            document.getElementById('roomParticipants').textContent = `${newRoom.participants} participants`;
                            showJoinNotification(fakeUser.name);
                            
                            // Add system message for new user joining
                            if (chatEnabled) {
                                setTimeout(() => {
                                    const joinMessages = [
                                        `${fakeUser.name} joined the study group! Welcome! ðŸ‘‹`,
                                        `Hey everyone! ${fakeUser.name} is here to study ${fakeUser.subject}`,
                                        `${fakeUser.name} just joined us! Let's keep each other motivated! ðŸ’ª`,
                                        `Welcome ${fakeUser.name}! Great to have you in our study session!`
                                    ];
                                    addSystemMessage(getRandomItem(joinMessages));
                                }, getRandomNumber(500, 2000));
                            }
                            
                            // Once we have 2+ fake users, restart the regular chat activity
                            if (addedUsers >= 1 && !chatActivityRestarted) {
                                chatActivityRestarted = true;
                                // Clear any existing cooldowns for user-created rooms
                                chatCooldownActive = false;
                                lastChatMessageTime = 0;
                                
                                // Start regular chat activity sooner for user-created rooms
                                setTimeout(() => {
                                    scheduleRegularChatActivity();
                                }, getRandomNumber(5000, 10000)); // 5-10 seconds after 2nd user joins
                            }
                                            
                            addedUsers++;
                            setTimeout(addNextFakeUser, getRandomNumber(1000, 3000)); // 1-3s delay
                        }
                    }
                    addNextFakeUser();

                    // Close the modal
                    const modal = document.getElementById('createRoomModal');
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                } catch (error) {
                    console.error('Error creating room:', error);
                    const modal = document.getElementById('createRoomModal');
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            });

            // Room navigation
            document.getElementById('backToDashboard').addEventListener('click', backToDashboard);
            document.getElementById('leaveRoomBtn').addEventListener('click', () => {
                // Show leave room confirmation modal
                document.getElementById('leaveRoomModal').classList.remove('hidden');
                document.getElementById('leaveRoomModal').classList.add('flex');
            });

            // Background room indicator buttons
            document.getElementById('returnToRoomBtn').addEventListener('click', returnToRoom);
            document.getElementById('leaveRoomFromDashboardBtn').addEventListener('click', () => {
                // Show leave room confirmation modal
                document.getElementById('leaveRoomModal').classList.remove('hidden');
                document.getElementById('leaveRoomModal').classList.add('flex');
            });

            // Leave room modal buttons
            document.getElementById('cancelLeaveRoom').addEventListener('click', () => {
                document.getElementById('leaveRoomModal').classList.add('hidden');
                document.getElementById('leaveRoomModal').classList.remove('flex');
            });
            document.getElementById('confirmLeaveRoom').addEventListener('click', () => {
                document.getElementById('leaveRoomModal').classList.add('hidden');
                document.getElementById('leaveRoomModal').classList.remove('flex');
                leaveRoom();
            });

            // Join new room modal buttons
            document.getElementById('backToPreviousRoom').addEventListener('click', () => {
                // Cancel joining new room and return to previous room
                document.getElementById('joinNewRoomModal').classList.add('hidden');
                document.getElementById('joinNewRoomModal').classList.remove('flex');
                pendingRoomToJoin = null;

                // If we're on dashboard, return to the background room
                if (isViewingDashboard && backgroundRoom) {
                    returnToRoom();
                }
            });

            document.getElementById('confirmJoinNewRoom').addEventListener('click', () => {
                // Leave current room and join new one
                document.getElementById('joinNewRoomModal').classList.add('hidden');
                document.getElementById('joinNewRoomModal').classList.remove('flex');

                if (pendingRoomToJoin) {
                    // Clean up current room first
                    const wasInRoom = currentRoom || backgroundRoom;
                    if (wasInRoom) {
                        // Silently leave without farewell message
                        const tempChatEnabled = chatEnabled;
                        chatEnabled = false;
                        leaveRoom();
                        chatEnabled = tempChatEnabled;
                    }

                    // Join the new room
                    actuallyJoinRoom(pendingRoomToJoin);
                    pendingRoomToJoin = null;
                }
            });

            // Timer controls
            document.getElementById('startTimerBtn').addEventListener('click', startTimer);
            document.getElementById('pauseTimerBtn').addEventListener('click', pauseTimer);

            // Chat controls
            document.getElementById('toggleChatBtn').addEventListener('click', () => {
                chatEnabled = !chatEnabled;
                const btn = document.getElementById('toggleChatBtn');
                btn.innerHTML = chatEnabled ? '<i class="fas fa-eye mr-1"></i>Enabled' : '<i class="fas fa-eye-slash mr-1"></i>Disabled';
                btn.className = chatEnabled ? 
                    'px-3 py-1 text-sm bg-muted-pink-100 text-muted-pink-700 rounded-lg hover:bg-muted-pink-200 transition-all' :
                    'px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all';
            });

            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });

            document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);

            function sendChatMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                if (message && chatEnabled) {
                    // Check if the message mentions/tags another user
                    let replyContext = null;

                    // Look for @username mentions
                    const atMentionMatch = message.match(/@(\w+)/);
                    if (atMentionMatch && currentRoom && currentRoom.users) {
                        const mentionedName = atMentionMatch[1];
                        const mentionedUser = currentRoom.users.find(u =>
                            u.name.toLowerCase() === mentionedName.toLowerCase()
                        );

                        if (mentionedUser) {
                            // Find the most recent message from that user
                            const chatMessages = document.getElementById('chatMessages');
                            const allMessages = Array.from(chatMessages.children);

                            for (let i = allMessages.length - 1; i >= 0; i--) {
                                const msgElement = allMessages[i];
                                const senderElement = msgElement.querySelector('.text-muted-pink-600');
                                if (senderElement && senderElement.textContent === mentionedUser.name) {
                                    const messageTextElement = msgElement.querySelector('.text-sm');
                                    if (messageTextElement) {
                                        // Extract text without the reply context
                                        let messageText = messageTextElement.textContent;
                                        const replyToElement = messageTextElement.querySelector('.italic');
                                        if (replyToElement) {
                                            messageText = messageText.replace(replyToElement.textContent, '').trim();
                                        }

                                        replyContext = {
                                            sender: mentionedUser.name,
                                            message: messageText
                                        };
                                        break;
                                    }
                                }
                            }
                        }
                    }

                    addChatMessage('You', message, true, replyContext);
                    input.value = '';
                }
            }

            // Goal and checklist controls
            document.getElementById('addChecklistItem').addEventListener('click', () => {
                const taskInput = document.createElement('input');
                taskInput.type = 'text';
                taskInput.placeholder = 'Enter a new task...';
                taskInput.className = 'w-full px-3 py-2 border border-muted-pink-200 rounded-lg focus:ring-2 focus:ring-muted-pink-500 focus:border-transparent text-base';
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 animate-slide-up">
                        <h3 class="text-lg font-semibold text-warm-gray-900 dark:text-white mb-4">Add Checklist Item</h3>
                        <div class="mb-4"></div>
                        <div class="flex space-x-3">
                            <button class="cancel-btn flex-1 px-4 py-2 border border-muted-pink-200 text-warm-gray-700 rounded-lg hover:bg-muted-pink-50 transition-all">Cancel</button>
                            <button class="add-btn flex-1 px-4 py-2 bg-muted-pink-500 text-white rounded-lg hover:bg-muted-pink-600 transition-all">Add</button>
                        </div>
                    </div>
                `;
                
                modal.querySelector('.mb-4').appendChild(taskInput);
                
                modal.querySelector('.cancel-btn').addEventListener('click', () => {
                    modal.remove();
                });
                
                modal.querySelector('.add-btn').addEventListener('click', () => {
                    const text = taskInput.value.trim();
                    if (text) {
                        addChecklistItem(text);
                    }
                    modal.remove();
                });
                
                taskInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const text = taskInput.value.trim();
                        if (text) {
                            addChecklistItem(text);
                        }
                        modal.remove();
                    }
                });
                
                document.body.appendChild(modal);
                taskInput.focus();
            });

            document.getElementById('toggleGoalVisibility').addEventListener('click', () => {
                goalVisibility = !goalVisibility;
                const toggle = document.getElementById('toggleGoalVisibility');
                if (goalVisibility) {
                    toggle.className = 'relative inline-flex h-6 w-11 items-center rounded-full bg-muted-pink-500 transition-all';
                    toggle.innerHTML = '<span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"></span>';
                } else {
                    toggle.className = 'relative inline-flex h-6 w-11 items-center rounded-full bg-gray-300 transition-all';
                    toggle.innerHTML = '<span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>';
                }
                
                if (currentRoom && currentRoom.users[0].isCurrentUser) {
                    currentRoom.users[0].isPublicGoal = goalVisibility;
                    renderUsers(currentRoom.users);
                }
            });

            // Goal and subject updates
            document.getElementById('userGoal').addEventListener('input', (e) => {
                if (currentRoom && currentRoom.users[0].isCurrentUser) {
                    currentRoom.users[0].goal = e.target.value || 'Set your goal...';
                    renderUsers(currentRoom.users);
                }
            });

            document.getElementById('userSubject').addEventListener('input', (e) => {
                if (currentRoom && currentRoom.users[0].isCurrentUser) {
                    currentRoom.users[0].subject = e.target.value || currentRoom.primarySubject;
                    renderUsers(currentRoom.users);
                }
            });

            document.getElementById('userSubjectSync').addEventListener('input', (e) => {
                if (currentRoom && currentRoom.users[0].isCurrentUser) {
                    currentRoom.users[0].subject = e.target.value || currentRoom.primarySubject;
                    renderUsers(currentRoom.users);
                }
            });

            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

            // Profile button
            document.getElementById('profileBtn').addEventListener('click', openProfileModal);
            document.getElementById('closeProfileModal').addEventListener('click', closeProfileModal);
            document.getElementById('cancelProfileEdit').addEventListener('click', closeProfileModal);
            document.getElementById('saveProfile').addEventListener('click', saveProfile);
        });

        // Dark mode functionality
        let isDarkMode = false;

        function initializeDarkMode() {
            // Start in light mode by default
            isDarkMode = false;
            updateDarkMode();
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            updateDarkMode();
            // Note: Theme preference will reset on page reload due to iframe sandbox restrictions
        }

        function updateDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.body.className = 'bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen';
                if (darkModeToggle) {
                    darkModeToggle.innerHTML = `
                        <i class="fas fa-sun text-yellow-500 text-sm"></i>
                        <span class="text-sm font-medium text-gray-900">Light</span>
                    `;
                }
            } else {
                document.documentElement.classList.remove('dark');
                document.body.className = 'bg-gradient-to-br from-muted-pink-50 to-muted-pink-100 min-h-screen';
                if (darkModeToggle) {
                    darkModeToggle.innerHTML = `
                        <i class="fas fa-moon text-warm-gray-700 text-sm"></i>
                        <span class="text-sm font-medium text-warm-gray-700">Dark</span>
                    `;
                }
            }
        }

        // Timer notification system
        function showTimerNotification(title, message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 z-50 transform translate-x-full transition-all duration-500 ease-out';
            notification.innerHTML = `
                <div class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-md rounded-lg shadow-lg border border-muted-pink-200 dark:border-gray-600 p-4 flex items-center space-x-3 max-w-sm">
                    <div class="w-10 h-10 bg-gradient-to-r from-muted-pink-400 to-muted-pink-600 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-clock text-white"></i>
                    </div>
                    <div class="min-w-0">
                        <p class="text-sm font-bold text-warm-gray-900 dark:text-white">${title}</p>
                        <p class="text-xs text-warm-gray-600 dark:text-gray-300">${message}</p>
                    </div>
                    <button class="text-warm-gray-400 hover:text-warm-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-colors ml-2" onclick="this.closest('.fixed').remove()">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Slide in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
                notification.classList.add('translate-x-0');
            }, 100);
            
            // Auto-remove after 6 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 500);
                }
            }, 6000);
        }

        // Timer restart with safe defaults
        function restartTimerWithDefaults() {
            console.log('Restarting timer with safe defaults due to error');
            
            if (!currentRoom || !currentRoom.syncTimer) return;
            
            try {
                // Reset to safe Pomodoro defaults or simple timer defaults
                if (currentRoom.syncTimer.studyDuration || currentRoom.syncTimer.breakDuration) {
                    // Pomodoro timer - use safe defaults
                    currentRoom.syncTimer.studyDuration = 25;
                    currentRoom.syncTimer.breakDuration = 5;
                    currentRoom.syncTimer.remaining = 25 * 60;
                    currentRoom.syncTimer.isStudyPhase = true;
                    currentRoom.syncTimer.isWaiting = false;
                    currentRoom.syncTimer.isRunning = true;
                    currentRoom.syncTimer.cycle = 1;
                } else {
                    // Simple timer - use safe defaults
                    currentRoom.syncTimer.duration = 60;
                    currentRoom.syncTimer.remaining = 60 * 60;
                    currentRoom.syncTimer.isStudyPhase = true;
                    currentRoom.syncTimer.isWaiting = false;
                    currentRoom.syncTimer.isRunning = true;
                }
                
                updateSyncTimerDisplay(currentRoom.syncTimer);
                showTimerNotification('ðŸ”„ Timer Restarted', 'Timer was reset due to an error and is now running with safe defaults');
                
                if (chatEnabled) {
                    addChatMessage('You', 'Timer was automatically restarted and is working normally now! ðŸ”„', true);
                }
                
            } catch (error) {
                console.error('Failed to restart timer with defaults:', error);
                // Ultimate fallback - show error state
                document.getElementById('mainTimer').textContent = '00:00';
                document.getElementById('timerStatus').textContent = 'Timer Error - Please refresh';
                document.getElementById('timerPhase').textContent = 'Contact support if this persists';
            }
        }

        // Enhanced individual timer validation
        function validateIndividualTimer() {
            try {
                if (isRunning && (isNaN(currentTime) || currentTime < 0)) {
                    console.error('Individual timer corrupted, resetting...');
                    currentTime = 25 * 60; // Reset to 25 minutes
                    isStudyPhase = true;
                    updateTimerDisplay();
                    showTimerNotification('ðŸ”„ Timer Reset', 'Your timer was reset due to an error');
                }
            } catch (error) {
                console.error('Individual timer validation failed:', error);
                pauseTimer();
            }
        }

        // Add timer validation to the existing timer interval
        function startValidatedTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                // Validate timer state before decrementing
                validateIndividualTimer();
                
                currentTime--;
                updateTimerDisplay();
                
                if (currentTime <= 0) {
                    if (isPomodoro) {
                        completePomodoroCycle();
                    } else {
                        completeTimer();
                    }
                }
            }, 1000);
        }

        // Dark mode support with system preference fallback (no localStorage in sandboxed iframe)
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            // Just update based on system preference since we can't access localStorage
            isDarkMode = event.matches;
            updateDarkMode();
        });
    </script>
</body>
</html>

























